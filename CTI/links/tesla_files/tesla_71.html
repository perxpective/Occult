<!doctype html><!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en-nz" > <![endif]--><!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en-nz" >        <![endif]--><!--[if IE 8]>    <html class="no-js lt-ie9" lang="en-nz" >               <![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en-nz"><!--<![endif]--><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="author" content="Chris Campbell">
    <meta name="description" content="Gain insight into the functionality of the ever popular .NET stealer AgentTesla through the reverse engineering and source code analysis of two recent samples.">
    <meta name="generator" content="HubSpot">
    <title>Inside a .NET Stealer: AgentTesla</title>
    <link rel="shortcut icon" href="https://www.inde.nz/hubfs/Brand%20identity/Logos/favicon.jpg">
    

    
    <meta property="og:description" content="Gain insight into the functionality of the ever popular .NET stealer AgentTesla through the reverse engineering and source code analysis of two recent samples.">
    <meta property="og:title" content="Inside a .NET Stealer: AgentTesla">
    <meta name="twitter:description" content="Gain insight into the functionality of the ever popular .NET stealer AgentTesla through the reverse engineering and source code analysis of two recent samples.">
    <meta name="twitter:title" content="Inside a .NET Stealer: AgentTesla">

    

    
    <style>
a.cta_button{-moz-box-sizing:content-box !important;-webkit-box-sizing:content-box !important;box-sizing:content-box !important;vertical-align:middle}.hs-breadcrumb-menu{list-style-type:none;margin:0px 0px 0px 0px;padding:0px 0px 0px 0px}.hs-breadcrumb-menu-item{float:left;padding:10px 0px 10px 10px}.hs-breadcrumb-menu-divider:before{content:'›';padding-left:10px}.hs-featured-image-link{border:0}.hs-featured-image{float:right;margin:0 0 20px 20px;max-width:50%}@media (max-width: 568px){.hs-featured-image{float:none;margin:0;width:100%;max-width:100%}}.hs-screen-reader-text{clip:rect(1px, 1px, 1px, 1px);height:1px;overflow:hidden;position:absolute !important;width:1px}
</style>

<link rel="stylesheet" href="/hs/hsstatic/AsyncSupport/static-1.122/sass/comments_listing_asset.css">
    

    

<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  /* POWER THEME - Important 3D Box Fix - Chrome 93/94 - 03. Sep 2021 */
.pwr-3D-box {
    transform: perspective(1200px) scale(1) !important;
}
.pwr-header.pwr-header-fixed {
    transform: translateZ(100px) !important;
}
.pwr-post-item__overlay,
.pwr-value__overlay,
.pwr-image-box__overlay,
.pwr-team-member__overlay {
    transform: none !important;
}
.featherlight {
    transform: translateZ(101px) !important;
}
@media (hover: hover) {
    .pwr-3D-box:hover {
        transform: perspective(1200px) scale(1.05) !important;
    }
}
</style>
<link rel="amphtml" href="https://www.inde.nz/blog/inside-agenttesla?hs_amp=true">

<meta property="og:image" content="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-27-06-22-PM.png#keepProtocol">
<meta property="og:image:width" content="602">
<meta property="og:image:height" content="464">

<meta name="twitter:image" content="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-27-06-22-PM.png#keepProtocol">


<meta property="og:url" content="https://www.inde.nz/blog/inside-agenttesla">
<meta name="twitter:card" content="summary_large_image">

<link rel="canonical" href="https://www.inde.nz/blog/inside-agenttesla">

<meta property="og:type" content="article">
<link rel="alternate" type="application/rss+xml" href="https://www.inde.nz/blog/rss.xml">
<meta name="twitter:domain" content="www.inde.nz">
<script src="//platform.linkedin.com/in.js" type="text/javascript">
    lang: en_US
</script>

<meta http-equiv="content-language" content="en-nz">
<link rel="stylesheet" href="//cdn2.hubspot.net/hub/7052064/hub_generated/template_assets/1703096199886/hubspot/hubspot_default/shared/responsive/layout.min.css">


<link rel="stylesheet" href="https://www.inde.nz/hs-fs/hub/7919588/hub_generated/template_assets/32431268042/1598884728467/Inde_Website_Theme_July2020/Coded_Files/Inde-custom-styles_July2020.min.css">
<link rel="stylesheet" href="https://www.inde.nz/hs-fs/hub/7919588/hub_generated/template_assets/32431268044/1669685659703/Inde_Website_Theme_July2020/Coded_Files/Inde-main_July2020.min.css">




</head>
<body class="   hs-content-id-38341734945 hs-blog-post hs-blog-id-30761529062" style="">
    <div class="header-container-wrapper">
    <div class="header-container container-fluid">

<div class="row-fluid-wrapper row-depth-1 row-number-1 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-custom_widget " style="" data-widget-type="custom_widget" data-x="0" data-w="12">
<div id="hs_cos_wrapper_module_1595996249347285" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">




<div id="pwr-js-burger" class="pwr-burger pwr--light">
  <a href="#" id="pwr-js-burger__trigger-close" class="pwr-burger__trigger-close">
    <span class="pwr-burger__icon-close"></span>Close
  </a>
  
      
      
          <div class="pwr-burger__menu pwr-js-menu">
              <span id="hs_cos_wrapper_module_1595996249347285_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_menu" style="" data-hs-cos-general-type="widget" data-hs-cos-type="menu"><div id="hs_menu_wrapper_module_1595996249347285_" class="hs-menu-wrapper active-branch no-flyouts hs-menu-flow-vertical" role="navigation" data-sitemap-name="default" data-menu-id="32461141892" aria-label="Navigation Menu">
 <ul role="menu" class="active-branch">
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz" role="menuitem">Home</a></li>
  <li class="hs-menu-item hs-menu-depth-1 hs-item-has-children" role="none"><a href="javascript:;" aria-haspopup="true" aria-expanded="false" role="menuitem">Services</a>
   <ul role="menu" class="hs-menu-children-wrapper">
    <li class="hs-menu-item hs-menu-depth-2 hs-item-has-children" role="none"><a href="https://www.inde.nz/our-services/enterprise-networking" role="menuitem">Enterprise Networking</a>
     <ul role="menu" class="hs-menu-children-wrapper">
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-networking" role="menuitem">Overview</a></li>
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-networking/sd-wan" role="menuitem">SD-WAN</a></li>
     </ul></li>
    <li class="hs-menu-item hs-menu-depth-2 hs-item-has-children" role="none"><a href="https://www.inde.nz/our-services/cloud-and-compute" role="menuitem">Cloud &amp; Compute</a>
     <ul role="menu" class="hs-menu-children-wrapper">
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/cloud-and-compute" role="menuitem">Overview</a></li>
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/identity" role="menuitem">Identity</a></li>
      <li class="hs-menu-item hs-menu-depth-3 hs-item-has-children" role="none"><a href="https://www.inde.nz/our-services/cloud-and-compute/inde-hybrid-cloud" role="menuitem">Hybrid Cloud</a>
       <ul role="menu" class="hs-menu-children-wrapper">
        <li class="hs-menu-item hs-menu-depth-4" role="none"><a href="https://www.inde.nz/our-services/cloud-and-compute/inde-hybrid-cloud/azure-stack" role="menuitem">Azure Stack</a></li>
       </ul></li>
     </ul></li>
    <li class="hs-menu-item hs-menu-depth-2 hs-item-has-children" role="none"><a href="https://www.inde.nz/our-services/enterprise-security" role="menuitem">Enterprise Security</a>
     <ul role="menu" class="hs-menu-children-wrapper">
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-security" role="menuitem">Overview</a></li>
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-security/inde-mdr" role="menuitem">MDR</a></li>
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-security/inde-security-assessments" role="menuitem">Security Assessments</a></li>
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-security/incident-simulation" role="menuitem">Incident Simulation</a></li>
     </ul></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/our-services/workspace" role="menuitem">Workspace</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/our-services/application-delivery" role="menuitem">Application Delivery</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/our-services/integration-and-automation" role="menuitem">Integration &amp; Automation</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/our-services/licensing-and-procurement" role="menuitem">Licensing &amp; Procurement</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/our-services/managed-services" role="menuitem">Managed Services</a></li>
   </ul></li>
  <li class="hs-menu-item hs-menu-depth-1 hs-item-has-children" role="none"><a href="https://www.inde.nz/sectors" aria-haspopup="true" aria-expanded="false" role="menuitem">Sectors</a>
   <ul role="menu" class="hs-menu-children-wrapper">
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/agriculture" role="menuitem">Agriculture</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/government" role="menuitem">Government</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/health" role="menuitem">Health</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/retail" role="menuitem">Retail</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/tertiary-education" role="menuitem">Tertiary Education</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/transport-and-logistics" role="menuitem">Transport &amp; Logistics</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/utilities" role="menuitem">Utilities</a></li>
   </ul></li>
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/our-clients" role="menuitem">Clients</a></li>
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/resources" role="menuitem">Resources</a></li>
  <li class="hs-menu-item hs-menu-depth-1 active active-branch" role="none"><a href="https://www.inde.nz/blog" role="menuitem">Blog</a></li>
  <li class="hs-menu-item hs-menu-depth-1 hs-item-has-children" role="none"><a href="https://www.inde.nz/about-us" aria-haspopup="true" aria-expanded="false" role="menuitem">About</a>
   <ul role="menu" class="hs-menu-children-wrapper">
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/about-us#People" role="menuitem">People</a></li>
   </ul></li>
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/contact-us" role="menuitem">Contact</a></li>
  <li class="hs-menu-item hs-menu-depth-1 hs-item-has-children" role="none"><a href="https://www.inde.nz/careers" aria-haspopup="true" aria-expanded="false" role="menuitem">Careers</a>
   <ul role="menu" class="hs-menu-children-wrapper">
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/careers" role="menuitem">Overview</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/careers#open-positions" role="menuitem">Open positions</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/scholarships" role="menuitem">Scholarships</a></li>
   </ul></li>
 </ul>
</div></span>
          </div>
      
  
  <div class="pwr-burger-bottom-bar">
    
    <div class="pwr-burger-bottom-bar__item">
      <a href="#" id="pwr-js-burger-search__trigger" class="pwr-burger-bottom-bar__item-link pwr-burger-search__trigger">
        <div class="pwr-header-right-bar__icon pwr--padding-r-sm"><span id="hs_cos_wrapper_module_1595996249347285_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_icon" style="" data-hs-cos-general-type="widget" data-hs-cos-type="icon"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 512" aria-hidden="true"><g id="search1_layer"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z" /></g></svg></span></div>
        <span>SEARCH</span>
      </a>
      <div id="pwr-js-burger-search__inner" class="pwr-burger-bottom-bar__inner pwr-burger-search__inner pwr-form pwr-form--style-1">
        <div class="hs-search-field__bar"> 
          <form action="/hs-search-results">
            <div class="pwr--relative">
              <input type="text" id="pwr-js-burger-search__input" class="pwr-burger-search__input hs-search-field__input" name="term" autocomplete="off" aria-label="Search" placeholder="Type search here">
              <button class="pwr-search-field__icon" type="submit"><span id="hs_cos_wrapper_module_1595996249347285_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_icon" style="" data-hs-cos-general-type="widget" data-hs-cos-type="icon"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 512" aria-hidden="true"><g id="search2_layer"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z" /></g></svg></span></button>
            </div>
            <input type="hidden" name="limit" value="5">
                        
            
            
            
          </form>
        </div>
      </div>
    </div>
    
    
    
    
    </div>
</div>

<div id="pwr-header-fixed__spacer" class="pwr-header-fixed__spacer"></div>

<div id="pwr-header-fixed" class="pwr-header pwr-header-fixed pwr--light  pwr-header--light-on-scroll">
  <div class="page-center pwr-header--padding">
    <div class="pwr-header-full pwr--clearfix">
      <div class="pwr-header-logo ">
        
        
          
        
        
        <span id="hs_cos_wrapper_module_1595996249347285_logo" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_logo" style="" data-hs-cos-general-type="widget" data-hs-cos-type="logo"><a href="https://www.inde.nz/" id="hs-link-module_1595996249347285_logo" style="border-width:0px;border:0px;"><img src="https://www.inde.nz/hubfs/Brand%20identity/Logos/Inde%20Logo.svg" class="hs-image-widget " height="110" style="height: auto;width:110px;border-width:0px;border:0px;" width="110" alt="logo" title="logo"></a></span>
        
        
      </div>
      
      <div id="pwr-js-header__menu" class="pwr-header__menu  pwr-header__menu--dropdown ">
        
          
          
            <div class="pwr-js-menu">
              
                <span id="hs_cos_wrapper_module_1595996249347285_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_menu" style="" data-hs-cos-general-type="widget" data-hs-cos-type="menu"><div id="hs_menu_wrapper_module_1595996249347285_" class="hs-menu-wrapper active-branch flyouts hs-menu-flow-horizontal" role="navigation" data-sitemap-name="default" data-menu-id="32461141892" aria-label="Navigation Menu">
 <ul role="menu" class="active-branch">
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz" role="menuitem">Home</a></li>
  <li class="hs-menu-item hs-menu-depth-1 hs-item-has-children" role="none"><a href="javascript:;" aria-haspopup="true" aria-expanded="false" role="menuitem">Services</a>
   <ul role="menu" class="hs-menu-children-wrapper">
    <li class="hs-menu-item hs-menu-depth-2 hs-item-has-children" role="none"><a href="https://www.inde.nz/our-services/enterprise-networking" role="menuitem">Enterprise Networking</a>
     <ul role="menu" class="hs-menu-children-wrapper">
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-networking" role="menuitem">Overview</a></li>
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-networking/sd-wan" role="menuitem">SD-WAN</a></li>
     </ul></li>
    <li class="hs-menu-item hs-menu-depth-2 hs-item-has-children" role="none"><a href="https://www.inde.nz/our-services/cloud-and-compute" role="menuitem">Cloud &amp; Compute</a>
     <ul role="menu" class="hs-menu-children-wrapper">
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/cloud-and-compute" role="menuitem">Overview</a></li>
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/identity" role="menuitem">Identity</a></li>
      <li class="hs-menu-item hs-menu-depth-3 hs-item-has-children" role="none"><a href="https://www.inde.nz/our-services/cloud-and-compute/inde-hybrid-cloud" role="menuitem">Hybrid Cloud</a>
       <ul role="menu" class="hs-menu-children-wrapper">
        <li class="hs-menu-item hs-menu-depth-4" role="none"><a href="https://www.inde.nz/our-services/cloud-and-compute/inde-hybrid-cloud/azure-stack" role="menuitem">Azure Stack</a></li>
       </ul></li>
     </ul></li>
    <li class="hs-menu-item hs-menu-depth-2 hs-item-has-children" role="none"><a href="https://www.inde.nz/our-services/enterprise-security" role="menuitem">Enterprise Security</a>
     <ul role="menu" class="hs-menu-children-wrapper">
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-security" role="menuitem">Overview</a></li>
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-security/inde-mdr" role="menuitem">MDR</a></li>
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-security/inde-security-assessments" role="menuitem">Security Assessments</a></li>
      <li class="hs-menu-item hs-menu-depth-3" role="none"><a href="https://www.inde.nz/our-services/enterprise-security/incident-simulation" role="menuitem">Incident Simulation</a></li>
     </ul></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/our-services/workspace" role="menuitem">Workspace</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/our-services/application-delivery" role="menuitem">Application Delivery</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/our-services/integration-and-automation" role="menuitem">Integration &amp; Automation</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/our-services/licensing-and-procurement" role="menuitem">Licensing &amp; Procurement</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/our-services/managed-services" role="menuitem">Managed Services</a></li>
   </ul></li>
  <li class="hs-menu-item hs-menu-depth-1 hs-item-has-children" role="none"><a href="https://www.inde.nz/sectors" aria-haspopup="true" aria-expanded="false" role="menuitem">Sectors</a>
   <ul role="menu" class="hs-menu-children-wrapper">
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/agriculture" role="menuitem">Agriculture</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/government" role="menuitem">Government</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/health" role="menuitem">Health</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/retail" role="menuitem">Retail</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/tertiary-education" role="menuitem">Tertiary Education</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/transport-and-logistics" role="menuitem">Transport &amp; Logistics</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/sectors/utilities" role="menuitem">Utilities</a></li>
   </ul></li>
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/our-clients" role="menuitem">Clients</a></li>
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/resources" role="menuitem">Resources</a></li>
  <li class="hs-menu-item hs-menu-depth-1 active active-branch" role="none"><a href="https://www.inde.nz/blog" role="menuitem">Blog</a></li>
  <li class="hs-menu-item hs-menu-depth-1 hs-item-has-children" role="none"><a href="https://www.inde.nz/about-us" aria-haspopup="true" aria-expanded="false" role="menuitem">About</a>
   <ul role="menu" class="hs-menu-children-wrapper">
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/about-us#People" role="menuitem">People</a></li>
   </ul></li>
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/contact-us" role="menuitem">Contact</a></li>
  <li class="hs-menu-item hs-menu-depth-1 hs-item-has-children" role="none"><a href="https://www.inde.nz/careers" aria-haspopup="true" aria-expanded="false" role="menuitem">Careers</a>
   <ul role="menu" class="hs-menu-children-wrapper">
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/careers" role="menuitem">Overview</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/careers#open-positions" role="menuitem">Open positions</a></li>
    <li class="hs-menu-item hs-menu-depth-2" role="none"><a href="https://www.inde.nz/scholarships" role="menuitem">Scholarships</a></li>
   </ul></li>
 </ul>
</div></span>
              
            </div>
          
        </div>
      
      
      <div id="pwr-js-header-right-bar" class="pwr-header-right-bar ">
      
        
        <div class="pwr-header-right-bar__item pwr-header-right-bar__search">
          <a href="#" id="pwr-js-header-search__trigger" class="pwr-header-right-bar__link">
            <div class="pwr-header-right-bar__icon"><span id="hs_cos_wrapper_module_1595996249347285_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_icon" style="" data-hs-cos-general-type="widget" data-hs-cos-type="icon"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 512" aria-hidden="true"><g id="search3_layer"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z" /></g></svg></span></div>
          </a>
        </div>
        
        
        
      </div>
      
      <div id="pwr-js-header-search" class="pwr-header-search hs-search-field">
        <div class="pwr-header-search__inner">
          <div class="hs-search-field__bar"> 
            <form action="/hs-search-results">
              <div class="pwr--relative">
                <input type="text" id="pwr-header-search__input" class="pwr-header-search__input hs-search-field__input" name="term" autocomplete="off" aria-label="Search" placeholder="Type search here. Hit enter to submit or escape to close.">
                <button class="pwr-search-field__icon" type="submit"><span id="hs_cos_wrapper_module_1595996249347285_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_icon" style="" data-hs-cos-general-type="widget" data-hs-cos-type="icon"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 512" aria-hidden="true"><g id="search4_layer"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z" /></g></svg></span></button>
                <a href="#" id="pwr-js-header-search__close" class="pwr-header-search__close">
                  <span class="pwr-header-search__close-icon"></span>
                </a>
              </div>
              <input type="hidden" name="limit" value="5">
                          
              
              
              
            </form>
          </div>
        </div>
      </div>
      <a href="#" id="pwr-js-burger__trigger-open" class="pwr-burger__trigger-open pwr-burger__trigger-open--mobile-only">
        <div class="pwr-burger__icon-open">
          <span></span>
        </div>
      </a>
    </div>
  </div>
</div></div>

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

    </div><!--end header -->
</div><!--end header wrapper -->

<div class="body-container-wrapper">
    <div class="body-container container-fluid">

<div class="row-fluid-wrapper row-depth-1 row-number-1 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-custom_widget " style="" data-widget-type="custom_widget" data-x="0" data-w="12">
<div id="hs_cos_wrapper_module_15471597189097082" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">
  
    
      
    
    
    
    

    
      
      
      

    

  





<div class="pwr-post-header pwr--dark">
  
    <div class="pwr-hero pwr-hero--small" style="
                 background-image: url(https://7919588.fs1.hubspotusercontent-na1.net/hub/7919588/hubfs/image-png-Dec-03-2020-10-27-06-22-PM.png?width=2000&amp;name=image-png-Dec-03-2020-10-27-06-22-PM.png);
                 background-image: -webkit-image-set(url(https://7919588.fs1.hubspotusercontent-na1.net/hub/7919588/hubfs/image-png-Dec-03-2020-10-27-06-22-PM.png?width=2000&amp;name=image-png-Dec-03-2020-10-27-06-22-PM.png) 1x, url(https://7919588.fs1.hubspotusercontent-na1.net/hub/7919588/hubfs/image-png-Dec-03-2020-10-27-06-22-PM.png?width=3000&amp;name=image-png-Dec-03-2020-10-27-06-22-PM.png) 2x);
                 background-size: cover;
                 background-position: center;
                ">
      
      

      
      <div class="pwr--abs-full" style="background-color: rgba(0, 0, 0, 0.4)"></div>
      
      <div class="page-center pwr-post-header__info-box">
        <div class="pwr-post-item__author" id="hubspot-author_data" data-hubspot-form-id="author_data" data-hubspot-name="Blog Author">
          <a class="pwr-post-item__name" href="https://www.inde.nz/blog/author/chris-campbell">Chris Campbell</a>
          <span class="pwr-post-item__date">Dec 4, 2020 1:11:03 PM</span>
          <span class="pwr-post-item__n-min-read">24
 min read</span>
        </div>
        <h1 class="pwr-post-header__title pwr--toc-ignore"><span id="hs_cos_wrapper_name" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="text">Inside a .NET Stealer: AgentTesla</span></h1>
        
      </div>
    </div>
           


</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

<div class="row-fluid-wrapper row-depth-1 row-number-2 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-custom_widget " style="" data-widget-type="custom_widget" data-x="0" data-w="12">
<div id="hs_cos_wrapper_module_15471606383437493" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">





<div class="pwr-sec-prev-next-nav pwr--dark">
  
  

  
  <div class="pwr-prev-next-nav__content page-center pwr--clearfix pwr--relative">
    <div class="pwr-prev-next-nav__container pwr-prev-next-nav__left">
    
      <a href="/blog/using-the-cloud-to-differentiate-the-opportunities-for-automation-and-cost-savings" class="pwr-prev-next-nav__link">
        <span class="pwr-icon pwr-prev-next-nav__icon">
          <svg version="1.1" id="arrow_left_thin" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 32 19.3" xml:space="preserve">
          <polygon points="0,9.6 9.6,0 11.8,2.2 5.8,8.1 32,8.1 32,11.2 5.8,11.2 11.8,17.1 9.6,19.3 0,9.6 0,9.6 " />
          </svg>
        </span>
        <span class="pwr-prev-next-nav__text">Previous Post</span>
      </a>      
    
    </div>

    <div class="pwr-prev-next-nav__container pwr-prev-next-nav__middle pwr--align-c">
      <a href="https://www.inde.nz/blog" class="pwr-prev-next-nav__link">
        <span class="pwr-icon pwr-prev-next-nav__icon">
          <svg version="1.1" id="overview" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 32 31.9" xml:space="preserve">
          <style type="text/css">
            .st0{fill-rule:evenodd;clip-rule:evenodd;}
          </style>
          <rect class="st0" width="12.8" height="12.8" />
          <rect y="19.2" class="st0" width="12.8" height="12.8" />
          <rect x="19.2" class="st0" width="12.8" height="12.8" />
          <rect x="19.2" y="19.2" class="st0" width="12.8" height="12.8" />
          </svg>
        </span>
      </a>
    </div>

    <div class="pwr-prev-next-nav__container pwr-prev-next-nav__right pwr--align-r">
    
      <a href="/blog/humble-hungry-smart-creating-a-culture-of-excellence" class="pwr-prev-next-nav__link">
        <span class="pwr-prev-next-nav__text">Next Post</span>
        <span class="pwr-icon pwr-prev-next-nav__icon">
          <svg version="1.1" id="arrow_right_thin" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 32 19.3" xml:space="preserve">
          <polygon points="32,9.6 22.3,0 20.2,2.2 26.1,8.1 0,8.1 0,11.2 26.1,11.2 20.2,17.1 22.3,19.3 32,9.6 32,9.6 " />
          </svg>
        </span>
      </a>
                  
    </div>
  </div>
</div></div>

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

<div class="row-fluid-wrapper row-depth-1 row-number-3 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-custom_widget " style="" data-widget-type="custom_widget" data-x="0" data-w="12">
<div id="hs_cos_wrapper_module_155196085853314974" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">



<div class="pwr-post-body">
  <progress id="pwr-progress-bar" max="0" value="0"></progress>
  
  <div class="pwr-post-social pwr-post-social--is-float">
    <div class="addthis_inline_share_toolbox"></div>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=YOUR_ID"></script>
  
  <div class="pwr-post-content">
    <span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>First seen in 2014, AgentTesla (<a href="https://attack.mitre.org/software/S0331/" rel="noopener" target="_blank">S0331</a>) is a .NET platformed stealer that has recently surpassed Emotet and Trickbot to become one of the most prevalent malware threats. At present it is the #2 most submitted malware family submitted to the <a href="https://any.run/" rel="noopener" target="_blank">ANY.RUN</a> sandbox service, mostly thanks to the Emotet crew appearing to have taken an early Christmas vacation. From pray and spray spam runs through to more resourced campaigns targeting critical infrastructure sectors, AgentTesla appears to have a wide variety of operators. Up until 2019 it was available through the website of the developer, www.agenttesla[.]com, as moreorless a SaaS subscription that included 24x7 support, web management, delivery and packing services, and regular updates:</p>
<!--more-->
<p><img src="https://www.inde.nz/hubfs/image-png.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>Predictably, the service was sold with the disclaimer <em>“Agent Tesla is a software for monitoring your personal computer. It is not a malware. Please, don’t use for computers which is not access permission.”</em>, in much the same fashion as open-source RAT’s and ransomware are cautioned on GitHub as being <em>“for educational purposes only”.</em> While cracked and leaked copies of the tool were always available through forums and marketplaces, their availability has naturally exploded following closure of the official service.</p>
<h2 style="font-size: 24px;">Features</h2>
<p>As a SaaS offering with a reported 6300+ customers (source: <a href="https://krebsonsecurity.com/2018/10/who-is-agent-tesla/" rel="noopener" target="_blank">Krebs<span> on Security</span></a>), it was fair to expect that the feature set and reliability of the tool would continually improve to remain competitive, meet customer requirements and stay ahead of defenses. Current features include:</p>
<ul>
<li>Keylogging, clipboard scraping and screenshot capture.</li>
<li>Credential theft from a wide selection of browsers, VPN, FTP and email clients, and Windows credential stores.</li>
<li>FTP, HTTP and SMTP exfiltration.</li>
<li>Tor proxying.</li>
</ul>
<p>Occasionally custom modules have been seen in samples, such as the WiFi credential stealer.</p>
<h2 style="font-size: 24px;">Delivery</h2>
<p>Like many varieties of malware, delivery is primarily via email. Compromised email credentials are frequently used for sending, and messages utilise your garden variety logistics, financial and current event templates. Most often we observe the AgentTesla payload attached to messages in an archive, but maldoc delivery is also commonplace. A full spectrum of payload delivery mechanisms are seen being employed by the maldocs, including links, macros, DDE commands and Office exploits (e.g. CVE-2017-11882 and CVE-2017-8570).</p>
<p>Loaders employ obfuscators/crypters for source protection and almost always .NET reflection to load the AgentTesla stealer, as will be illustrated in the following samples.</p>
<h2 style="font-size: 24px;">Email</h2>
<p>The sample that we will first investigate in this post begins with a payment themed message that leverages the branding of a Turkish garment company:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-1.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>Attached to the email is a zip file containing the payload: “swift copy.exe” (sha256: 9d626bb9d442d3762e5366f0fbefae41708936b9c254141fcf3b0a1b80291ebb). The sample is detected by 44 of 71 engines on VirusTotal (<a href="https://www.virustotal.com/gui/file/9d626bb9d442d3762e5366f0fbefae41708936b9c254141fcf3b0a1b80291ebb/detection" rel="noopener" target="_blank">report</a>) – so it’s not exactly low key.</p>
<h2 style="font-size: 24px;">Test Environment</h2>
<p>The sample is copied to a 64-bit Windows 7 analysis VM that is running a FileZilla FTP server and has a handful of dummy accounts set up, including for CoreFTP:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-2.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>We know that this is one of the tools that AgentTesla is capable of stealing credentials from, so it is expected that this will prompt the sample to attempt exfiltration.</p>
<p>The debugger used is dnSpy (<a href="https://github.com/dnSpy/dnSpy" rel="noopener" target="_blank">https://github.com/dnSpy/dnSpy</a>).</p>
<h2 style="font-size: 24px;">Loader</h2>
<p>“PongGame” may seem like an odd choice of namespace for a loader, but this isn’t at all abnormal for the obfuscators used with AgentTesla. Naming conventions of legitimate programs are often adopted and applied across metadata, namespaces, classes, methods and objects.</p>
<p><img src="https://www.inde.nz/hubfs/image-png-3.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>The loader imports System.Reflection, indicating .NET reflection is likely used to load additional modules during unpacking:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-24-31-20-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>Before stepping through the execution, we review the program resources, of which there are two that stand out. It is well known that AgentTesla makes heavy use of steganography, so it is safe to assume the single image (XDDVe) will at some point be passed through a decoding routine. However, there is no reference to it in the loader:</p>
<p><img src="https://www.inde.nz/hs-fs/hubfs/image-png-Dec-03-2020-10-24-23-42-PM.png?width=602&amp;name=image-png-Dec-03-2020-10-24-23-42-PM.png" style="display: block; margin-left: auto; margin-right: auto; width: 602px;" width="602" srcset="https://www.inde.nz/hs-fs/hubfs/image-png-Dec-03-2020-10-24-23-42-PM.png?width=301&amp;name=image-png-Dec-03-2020-10-24-23-42-PM.png 301w, https://www.inde.nz/hs-fs/hubfs/image-png-Dec-03-2020-10-24-23-42-PM.png?width=602&amp;name=image-png-Dec-03-2020-10-24-23-42-PM.png 602w, https://www.inde.nz/hs-fs/hubfs/image-png-Dec-03-2020-10-24-23-42-PM.png?width=903&amp;name=image-png-Dec-03-2020-10-24-23-42-PM.png 903w, https://www.inde.nz/hs-fs/hubfs/image-png-Dec-03-2020-10-24-23-42-PM.png?width=1204&amp;name=image-png-Dec-03-2020-10-24-23-42-PM.png 1204w, https://www.inde.nz/hs-fs/hubfs/image-png-Dec-03-2020-10-24-23-42-PM.png?width=1505&amp;name=image-png-Dec-03-2020-10-24-23-42-PM.png 1505w, https://www.inde.nz/hs-fs/hubfs/image-png-Dec-03-2020-10-24-23-42-PM.png?width=1806&amp;name=image-png-Dec-03-2020-10-24-23-42-PM.png 1806w" sizes="(max-width: 602px) 100vw, 602px"></p>
<p>There is also a long string that is preceded with TVqQ which is base64 for “MZ”, the magic number for the MS-DOS EXE format:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-24-39-09-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>A reference to this is seen in method “dddddddddddd”, where the value of this resource converted from a URL string token to a byte array using System.Web.HttpServerUtility.UrlTokenDecode, and the byte array then loaded as an assembly. A breakpoint is set prior to the assembly being invoked and execution is run through to this:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-25-29-78-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<h2 style="font-size: 24px;"><strong>Second Stage</strong></h2>
<p>This unpacked assembly is MARCUS.dll and the method that will first be invoked is Jarico.Buta. The DLL is also obfuscated and has relatively few classes:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-25-40-43-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>A breakpoint is set on Jarico.Buta and execution is continued through to here:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-25-51-03-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>Shortly after this is an image object is returned by a method that takes a resource name and project name as parameters. Breaking at this point shows that the project and resource are the loader and image:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-26-00-38-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>The image is run through several decoding methods which produces an additional executable:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-26-10-46-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>Stepping through a little further we see the executable is named “IDvurjJAoNJbsjjolQx” and the entry point is the Main method:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-26-19-89-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<h2 style="font-size: 24px;"><strong>Third Stage</strong></h2>
<p>IDvurjJAoNJbsjjolQx is an obfuscated executable with a sizable resource named “YMh2sbk1276”:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-26-31-14-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-26-39-40-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>No direct reference to this is found, however a method is found where a resource is loaded into a byte array, so a breakpoint is set after the array has been formed:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-26-47-15-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>The value of \uE00C confirms that the loaded resource is what was expected. Contents of this resource are passed through several decoding routines to produce another executable:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-26-54-89-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<h2 style="font-size: 24px;"><strong>Unpacked Stealer</strong></h2>
<p>The memory section is dumped to disk and the resulting file – the AgentTesla stealer – is opened in a new dnSpy session. While still a little obfuscated, the source is relatively easy to read through:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-27-06-22-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>In this sample, configuration items are extracted from a specific position (i.e. offset and length) within a UTF8 byte array and converted to string format:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-27-20-05-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-27-29-30-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-27-35-64-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>We can also set a breakpoint prior to HTTP POSTs or email messages being sent to obtain the respective config (i.e. HTTP request or SMTP credentials):</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-27-47-27-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>Imports are made for the kernel functions required by the keylogger:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-27-55-95-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>And below these is the method that implements the keylogger:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-28-03-64-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<h2 style="font-size: 24px;"><strong>Another Loader</strong></h2>
<p>This second sample illustrates a couple of different aspects of .NET malware: anti-tamper measures and persistence.</p>
<p>Upon loading the sample into dnSpy and jumping to the module initialiser, we are presented with decompiler errors intentionally resulting from the anti-decompiler measures implemented by the obfuscator:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-28-12-89-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>Attempting to run the sample also fails and the method at the entry point of the program appears to be empty. While it is possible to remove these protections with dnSpy by editing the IL instructions, a much faster method is simply running the payload and dumping the unpacked assemblies with a tool such as MegaDumper (<a href="https://github.com/CodeCracker-Tools/MegaDumper" rel="noopener" target="_blank">https://github.com/CodeCracker-Tools/MegaDumper</a>):</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-28-30-11-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-28-34-76-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>Hollows Hunter (<a href="https://github.com/hasherezade/hollows_hunter" rel="noopener" target="_blank">https://github.com/hasherezade/hollows_hunter</a>) is also a useful tool in similar situations.</p>
<p>This produced two executables and a handful of DLLs:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-28-46-90-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>The smaller executable is AgentTesla and the larger is a loader.</p>
<h2 style="font-size: 24px;">Modules</h2>
<p>In this case, the level of obfuscation is much lower than the previous sample, so more insight into the capabilities can be gleamed thanks to cleaner class, method and attribute names (e.g. DPAPI, HttpToSocks5Proxy, SafariDecrypter, TorBrowser, VaultCli, etc):</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-30-24-64-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-04-2020-12-21-37-22-AM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>While the previous sample used the simple method of storing the configuration as plaintext in a UTF8 byte array, this instead stores an encrypted configuration as a list of unsigned integer arrays:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-29-06-70-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-29-12-17-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-29-18-02-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-29-43-26-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<h2 style="font-size: 24px;"><strong>Persistence</strong></h2>
<p>Among the functions of the loader is setting up persistence via scheduled task. The bytes of the current assembly are first written to a path under %APPDATA%:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-30-56-53-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>A scheduled task XML configuration is then formed, referencing the path of the dropped executable, and written out to a temporary text file:</p>
<p style="text-align: center;"><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-31-04-65-PM.png"></p>
<p style="text-align: center;"><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-31-15-09-PM.png"></p>
<p>The configuration is passed to schtasks.exe which sets up the scheduled task according to the XML:</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-31-22-15-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-31-27-24-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<p>In effect, the scheduled task will run gnFZsnV.exe upon logon. Scheduled tasks aren’t a particularly stealthy method of persistence, so should a suspected victim of AgentTesla be triaged, the scheduled task will be highlighted by Sysinternals AutoRuns (<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns" rel="noopener" target="_blank">https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns</a>):</p>
<p><img src="https://www.inde.nz/hubfs/image-png-Dec-03-2020-10-31-36-82-PM.png" style="display: block; margin-left: auto; margin-right: auto;"></p>
<h2 style="font-size: 24px;"><strong>Detection and Mitigation</strong></h2>
<ul>
<li><strong>Mail:</strong> Given the predominant method of delivery is mail, robust mail filters, external sender warnings and end-user education form a significant part of defense against AgentTesla.</li>
<li><strong>Network:</strong> Depending on the capabilities of your firewall IPS, blocking traffic to known Tor nodes or traffic identified as Tor, combined with SMTP whitelisting, will help to prevent exfiltration. If your firewall supports TLS inspection, do it. FortiGate, ForcePoint and Palo Alto all have signatures for AgentTesla. Public IP lookups using the ipify service are also a potential indicator.</li>
<li><strong>Endpoint:</strong> Detection of AgentTesla is not difficult. Reputable EDR products, such as Defender ATP and SentinelOne, will have you sleeping easy. There are also a number of hardening steps that can be taken to prevent the impact of maldocs, including <a href="https://www.microsoft.com/security/blog/2016/03/22/new-feature-in-office-2016-can-block-macros-and-help-prevent-infection/" rel="noopener" target="_blank">blocking the execution of macros</a> and <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/attack-surface-reduction" rel="noopener" target="_blank">ASR rules</a> to block Office child processes.</li>
</ul>
<h2 style="font-size: 24px;">Samples</h2>
<ul>
<li>swift copy.exe (SHA256: 2ba9db3110899e60daeecb086d4f53adc1cfab127820db3d230c383e74f7172c): <a href="https://tria.ge/201201-lbk71xggyx" rel="noopener" target="_blank">https://tria.ge/201201-lbk71xggyx</a></li>
<li>exe (SHA256: bd648199b17ff21db3d45cfd10eb3b70fdcbdf42c405061025de6cd1a59c212e): <a href="https://tria.ge/201201-3yr3d6cakn" rel="noopener" target="_blank">https://tria.ge/201201-3yr3d6cakn</a></li>
</ul>
<h2 style="font-size: 24px;">Want More?</h2>
<p>If you enjoyed this blog post and want to follow other interesting malware finds that I make, I regularly share them on Twitter: <a href="https://twitter.com/phage_nz" rel="noopener" target="_blank">@phage_nz</a></p>
<p><em><strong>If you'd like to find out more about how Inde can help detect this security threat, you can<span>&nbsp;</span><a href="https://www.inde.nz/contact-us" rel="noopener" target="_blank">contact us here</a>.</strong></em></p></span>

    
    <div class="pwr-author-profile__wrapper pwr--sec-padding-t-md pwr--sec-padding-b-md">
      <div class="pwr-author-profile">
        
        <div class="pwr-author-profile__info">
          <a href="https://www.inde.nz/blog/author/chris-campbell">
            <h5>About the author</h5>
            <h4 class="pwr-author-profile__name pwr--toc-ignore">Chris Campbell</h4>
          </a>
          <span class="pwr-author-profile__bio">Chris was that notoriously disobedient kid who sat at the back of the class and always seemed bored, but somehow still managed to ace all of his exams. Obsessed with the finer details and mechanics of everything in both the physical and digital realms, Chris serves as the Security Architect within the Inde Security Team. His ventures into computer security began at an early age and haven't slowed down since. After a decade spent across security and operations, and evenings spent diving into the depths of malware and operating systems, he brings a wealth of knowledge to Inde along with a uniquely adversary focused approach to defence. Like many others at Inde, Chris likes to unwind by hitting the bike trails or pretending to be a BBQ pitmaster.</span>
                              
        </div>
      </div>                  
    </div>
    

    
    <div class="pwr-form pwr-post-comments  ">
      <h4 class="pwr--margin-t-0">COMMENTS</h4>
      <span id="hs_cos_wrapper_module_155196085853314974_blog_comments" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_blog_comments" style="" data-hs-cos-general-type="widget" data-hs-cos-type="blog_comments">
<div class="section post-footer">
    <div id="comments-listing" class="new-comments"></div>
    
      <div id="hs_form_target_8d31c92a-5cfd-4b12-935a-36aa00ee575a"></div>
      
      
      
      
    
</div>

</span>
    </div>
    
  </div>
</div></div>

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

    </div><!--end body -->
</div><!--end body wrapper -->

<div class="footer-container-wrapper">
    <div class="footer-container container-fluid">

<div class="row-fluid-wrapper row-depth-1 row-number-1 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-global_group " style="" data-widget-type="global_group" data-x="0" data-w="12">
<div class="" data-global-widget-path="generated_global_groups/33701082245.html"><div class="row-fluid-wrapper row-depth-1 row-number-1 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-cell pwr-footer pwr-footer-full pwr--dark" style="" data-widget-type="cell" data-x="0" data-w="12">

<div class="row-fluid-wrapper row-depth-1 row-number-2 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-cell page-center" style="" data-widget-type="cell" data-x="0" data-w="12">

<div class="row-fluid-wrapper row-depth-1 row-number-3 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-cell pwr-footer__content pwr-footer-full__content" style="" data-widget-type="cell" data-x="0" data-w="12">

<div class="row-fluid-wrapper row-depth-1 row-number-4 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-custom_widget reduced-footer pwr-footer-full__menu pwr-footer-full__menu--7col pwr-js-menu pwr--align-c" style="font-weight: 700; text-transform: uppercase; margin-top: 2em;" data-widget-type="custom_widget" data-x="0" data-w="12">
<div id="hs_cos_wrapper_module_1597616753119247" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module widget-type-menu" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">
<span id="hs_cos_wrapper_module_1597616753119247_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_menu" style="" data-hs-cos-general-type="widget" data-hs-cos-type="menu"><div id="hs_menu_wrapper_module_1597616753119247_" class="hs-menu-wrapper active-branch flyouts hs-menu-flow-horizontal" role="navigation" data-sitemap-name="default" data-menu-id="34036085378" aria-label="Navigation Menu">
 <ul role="menu" class="active-branch">
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz" role="menuitem">Home</a></li>
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/our-clients" role="menuitem">Clients</a></li>
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/resources" role="menuitem">Resources</a></li>
  <li class="hs-menu-item hs-menu-depth-1 active active-branch" role="none"><a href="https://www.inde.nz/blog" role="menuitem">Blog</a></li>
  <li class="hs-menu-item hs-menu-depth-1 hs-item-has-children" role="none"><a href="https://www.inde.nz/about-us" aria-haspopup="true" aria-expanded="false" role="menuitem">About</a></li>
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/contact-us" role="menuitem">Contact</a></li>
 </ul>
</div></span></div>

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

<div class="row-fluid-wrapper row-depth-1 row-number-5 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-custom_widget pwr--align-c big-icon" style="" data-widget-type="custom_widget" data-x="0" data-w="12">
<div id="hs_cos_wrapper_module_1597622943677884" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module widget-type-rich_text" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module"><span id="hs_cos_wrapper_module_1597622943677884_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_rich_text" style="" data-hs-cos-general-type="widget" data-hs-cos-type="rich_text"><div class="pwr-footer-company-info__icons"><a href="https://www.linkedin.com/company/inde-nz" target="_blank" class="pwr-social-icon" rel="noopener"> <span id="hs_cos_wrapper_module_159547890641856_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_icon" data-hs-cos-general-type="widget" data-hs-cos-type="icon"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 448 512" aria-hidden="true"><g id="layer1"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></g></svg></span> </a></div></span></div>

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

<div class="row-fluid-wrapper row-depth-1 row-number-6 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-custom_widget pwr--align-c" style="" data-widget-type="custom_widget" data-x="0" data-w="12">
<div id="hs_cos_wrapper_module_1597621593257476" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module widget-type-simple_menu" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module"><span id="hs_cos_wrapper_module_1597621593257476_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_simple_menu" style="" data-hs-cos-general-type="widget" data-hs-cos-type="simple_menu"><div id="hs_menu_wrapper_module_1597621593257476_" class="hs-menu-wrapper active-branch flyouts hs-menu-flow-horizontal" role="navigation" data-sitemap-name="" data-menu-id="" aria-label="Navigation Menu">
 <ul role="menu">
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/contact-us#office-locations" role="menuitem" target="_self">Auckland | Wellington | Christchurch | Dunedin</a></li>
 </ul>
</div></span></div>

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

<div class="row-fluid-wrapper row-depth-1 row-number-7 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-custom_widget " style="" data-widget-type="custom_widget" data-x="0" data-w="12">
<div id="hs_cos_wrapper_module_1597616663000160" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">





<div class="pwr-footer pwr-footer--copyright pwr--align-c pwr--dark">
  
   

  

  <div class="pwr-footer-legal page-center ">
    <div class="pwr-footer-legal__content">
      <span class="pwr-footer__item pwr-footer-legal__notice"><span id="hs_cos_wrapper_module_1597616663000160_page_footer" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_page_footer" style="" data-hs-cos-general-type="widget" data-hs-cos-type="page_footer">
<footer>
    <span class="hs-footer-company-copyright">© 2023 Inde Technology</span>
</footer>
</span> - All rights reserved.</span>
      
      
      <span class="pwr-footer__item pwr-footer-legal__menu pwr-js-menu">
        <span id="hs_cos_wrapper_module_1597616663000160_" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_menu" style="" data-hs-cos-general-type="widget" data-hs-cos-type="menu"><div id="hs_menu_wrapper_module_1597616663000160_" class="hs-menu-wrapper active-branch no-flyouts hs-menu-flow-horizontal" role="navigation" data-sitemap-name="default" data-menu-id="32606690851" aria-label="Navigation Menu">
 <ul role="menu">
  <li class="hs-menu-item hs-menu-depth-1" role="none"><a href="https://www.inde.nz/privacy-policy" role="menuitem">Privacy Policy</a></li>
 </ul>
</div></span>
      </span>
      </div>
  </div>
</div></div>

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->
</div>
</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

    </div><!--end footer -->
</div><!--end footer wrapper -->

    <script src="/hs/hsstatic/jquery-libs/static-1.4/jquery/jquery-1.11.2.js"></script>
<script>hsjQuery = window['jQuery'];</script>
<!-- HubSpot performance collection script -->
<script defer src="https://static.hsappstatic.net/content-cwv-embed/static-1.388/embed.js"></script>
<script src="https://www.inde.nz/hs-fs/hub/7919588/hub_generated/template_assets/32320707807/1606753449844/Marketplace/maka_Agency/POWER_-_Full_Pack/Coded_Files/pwr.min.js"></script>
<script>
var hsVars = hsVars || {}; hsVars['language'] = 'en-nz';
</script>

<script src="/hs/hsstatic/cos-i18n/static-1.53/bundles/project.js"></script>
<script src="/hs/hsstatic/keyboard-accessible-menu-flyouts/static-1.17/bundles/project.js"></script>
<script src="/hs/hsstatic/AsyncSupport/static-1.122/js/comment_listing_asset.js"></script>
<script>
  function hsOnReadyPopulateCommentsFeed() {
    var options = {
      commentsUrl: "https://api-na1.hubapi.com/comments/v3/comments/thread/public?portalId=7919588&offset=0&limit=1000&contentId=38341734945&collectionId=30761529062",
      maxThreadDepth: 1,
      showForm: true,
      
      skipAssociateContactReason: 'blogComment',
      disableContactPromotion: true,
      
      target: "hs_form_target_8d31c92a-5cfd-4b12-935a-36aa00ee575a"
    };
    window.hsPopulateCommentsFeed(options);
  }

  if (document.readyState === "complete" ||
      (document.readyState !== "loading" && !document.documentElement.doScroll)
  ) {
    hsOnReadyPopulateCommentsFeed();
  } else {
    document.addEventListener("DOMContentLoaded", hsOnReadyPopulateCommentsFeed);
  }

</script>


          <!--[if lte IE 8]>
          <script charset="utf-8" src="https://js.hsforms.net/forms/v2-legacy.js"></script>
          <![endif]-->
      
<script data-hs-allowed="true" src="/_hcms/forms/v2.js"></script>

        <script data-hs-allowed="true">
            hbspt.forms.create({
                portalId: '7919588',
                formId: '8d31c92a-5cfd-4b12-935a-36aa00ee575a',
                pageId: '38341734945',
                region: 'na1',
                pageName: "Inside a .NET Stealer: AgentTesla",
                contentType: 'blog-post',
                
                formsBaseUrl: '/_hcms/forms/',
                
                
                
                css: '',
                target: "#hs_form_target_8d31c92a-5cfd-4b12-935a-36aa00ee575a",
                type: 'BLOG_COMMENT',
                
                submitButtonClass: 'hs-button primary',
                formInstanceId: '2667',
                getExtraMetaDataBeforeSubmit: window.hsPopulateCommentFormGetExtraMetaDataBeforeSubmit
            });

            window.addEventListener('message', function(event) {
              var origin = event.origin; var data = event.data;
              if ((origin != null && (origin === 'null' || document.location.href.toLowerCase().indexOf(origin.toLowerCase()) === 0)) && data !== null && data.type === 'hsFormCallback' && data.id == '8d31c92a-5cfd-4b12-935a-36aa00ee575a') {
                if (data.eventName === 'onFormReady') {
                  window.hsPopulateCommentFormOnFormReady({
                    successMessage: "Your comment has been received.",
                    target: "#hs_form_target_8d31c92a-5cfd-4b12-935a-36aa00ee575a"
                  });
                } else if (data.eventName === 'onFormSubmitted') {
                  window.hsPopulateCommentFormOnFormSubmitted();
                }
              }
            });
        </script>
      

<!-- Start of HubSpot Analytics Code -->
<script type="text/javascript">
var _hsq = _hsq || [];
_hsq.push(["setContentType", "blog-post"]);
_hsq.push(["setCanonicalUrl", "https:\/\/www.inde.nz\/blog\/inside-agenttesla"]);
_hsq.push(["setPageId", "38341734945"]);
_hsq.push(["setContentMetadata", {
    "contentPageId": 38341734945,
    "legacyPageId": "38341734945",
    "contentFolderId": null,
    "contentGroupId": 30761529062,
    "abTestId": null,
    "languageVariantId": 38341734945,
    "languageCode": "en-nz",
    
}]);
</script>

<script type="text/javascript" id="hs-script-loader" async defer src="/hs/scriptloader/7919588.js"></script>
<!-- End of HubSpot Analytics Code -->


<script type="text/javascript">
var hsVars = {
    render_id: "f78e2ddb-c2e0-4ad8-b916-c8bb3e64e2b4",
    ticks: 1703525970507,
    page_id: 38341734945,
    
    content_group_id: 30761529062,
    portal_id: 7919588,
    app_hs_base_url: "https://app.hubspot.com",
    cp_hs_base_url: "https://cp.hubspot.com",
    language: "en-nz",
    analytics_page_type: "blog-post",
    analytics_page_id: "38341734945",
    category_id: 3,
    folder_id: 0,
    is_hubspot_user: false
}
</script>


<script defer src="/hs/hsstatic/HubspotToolsMenu/static-1.191/js/index.js"></script>



<div id="fb-root"></div>
 <script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&status=0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
 


    
    <!-- Generated by the HubSpot Template Builder - template version 1.03 -->

</div></div></body></html>