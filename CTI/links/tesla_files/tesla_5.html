<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Attack chain leads to XWORM and AGENTTESLA — Elastic Security Labs</title><meta name="description" content="Our team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate."/><meta property="og:title" content="Attack chain leads to XWORM and AGENTTESLA — Elastic Security Labs"/><meta property="og:description" content="Our team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate."/><meta property="og:image" content="https://www.elastic.co/security-labs/assets/images/attack-chain-leads-to-xworm-and-agenttesla/blog-thumb-coin-stacks.jpg?6d0ce2aaa3adb6928128f07c4c9f6baa"/><meta property="og:image:alt" content="Our team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate."/><meta property="og:site_name"/><meta property="og:url" content="https://www.elastic.co/security-labs"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Attack chain leads to XWORM and AGENTTESLA — Elastic Security Labs"/><meta name="twitter:description" content="Our team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate."/><meta name="twitter:image" content="https://www.elastic.co/security-labs/assets/images/attack-chain-leads-to-xworm-and-agenttesla/blog-thumb-coin-stacks.jpg?6d0ce2aaa3adb6928128f07c4c9f6baa"/><meta name="twitter:image:alt" content="Our team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate."/><link rel="preload" href="/security-labs/logo.svg" as="image" fetchpriority="high"/><link rel="preload" as="image" imageSrcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=640&amp;q=75 640w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=750&amp;q=75 750w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=828&amp;q=75 828w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=1080&amp;q=75 1080w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=1200&amp;q=75 1200w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=1920&amp;q=75 1920w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=2048&amp;q=75 2048w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=3840&amp;q=75 3840w" imageSizes="100vw" fetchpriority="high"/><meta name="next-head-count" content="18"/><script src="https://play.vidyard.com/embed/v4.js" type="text/javascript" async=""></script><link rel="icon" href="/security-labs/favicon.svg"/><link rel="mask-icon" href="/security-labs/favicon.svg" color="#1C1E23"/><link rel="apple-touch-icon" href="/security-labs/favicon.svg"/><meta name="theme-color" content="#1C1E23"/><link rel="preload" href="/security-labs/_next/static/media/d6b16ce4a6175f26-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/369c6e283c5acc6e-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/92f44bb82993d879-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/ee71530a747ff30b-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/9fac010bc1f02be0-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/cbf5fbad4d73afac-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/css/73b298dbda1d9875.css" as="style"/><link rel="stylesheet" href="/security-labs/_next/static/css/73b298dbda1d9875.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/security-labs/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/security-labs/_next/static/chunks/webpack-7987c6fda769d510.js" defer=""></script><script src="/security-labs/_next/static/chunks/framework-7a7e500878b44665.js" defer=""></script><script src="/security-labs/_next/static/chunks/main-f3a0ceda7ea49cbc.js" defer=""></script><script src="/security-labs/_next/static/chunks/pages/_app-2ec74491d5ced2ab.js" defer=""></script><script src="/security-labs/_next/static/chunks/fec483df-43ee602fabdfe3a4.js" defer=""></script><script src="/security-labs/_next/static/chunks/456-3e57b712955777f8.js" defer=""></script><script src="/security-labs/_next/static/chunks/63-f16c4b34a05eccc7.js" defer=""></script><script src="/security-labs/_next/static/chunks/402-c32fd975f91b0692.js" defer=""></script><script src="/security-labs/_next/static/chunks/313-8601898b29843738.js" defer=""></script><script src="/security-labs/_next/static/chunks/pages/%5Bslug%5D-0154f8439a66bef9.js" defer=""></script><script src="/security-labs/_next/static/LbZ9DZ1J4YuByupgUw5Qo/_buildManifest.js" defer=""></script><script src="/security-labs/_next/static/LbZ9DZ1J4YuByupgUw5Qo/_ssgManifest.js" defer=""></script></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__next"><main class="__variable_0351a5 __variable_96e9ea __variable_f5ba7a flex flex-col min-h-screen"><div class="scroll-percentage-container"><div class="scroll-percentage-bar" style="width:0%"></div></div><nav class="fixed w-full z-40" data-headlessui-state=""><div class="bg-gradient-to-b from-zinc-900 from-20% h-[200%] to-transparent absolute inset-0 z-0 pointer-events-none"></div><div class="container relative z-10"><div class="flex h-16 items-center justify-between"><div class="flex items-center justify-start w-full"><div><a class="hover:opacity-50 transition" href="/security-labs"><img alt="elastic security labs logo" fetchpriority="high" width="200" height="30" decoding="async" data-nimg="1" style="color:transparent" src="/security-labs/logo.svg"/></a></div><div class="hidden lg:ml-6 lg:block"><div class="flex space-x-4"><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/about"><span>About</span></a><div class="relative" data-headlessui-state=""><div><button class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" id="headlessui-menu-button-:R2kpm:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state="">Topics<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="ml-1 -mr-1 h-4 w-4 text-zinc-400 relative top-[1px]"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div></div><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/category/vulnerability-updates"><span>Vulnerability updates</span></a><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/category/reports"><span>Reports</span></a><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/category/tools"><span>Tools</span></a></div></div><div class="hidden lg:ml-auto lg:block"><div class="flex space-x-4"><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="https://www.elastic.co/security-labs/rss/feed.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="h-4 w-4 mr-1"><path d="M3.75 3a.75.75 0 00-.75.75v.5c0 .414.336.75.75.75H4c6.075 0 11 4.925 11 11v.25c0 .414.336.75.75.75h.5a.75.75 0 00.75-.75V16C17 8.82 11.18 3 4 3h-.25z"></path><path d="M3 8.75A.75.75 0 013.75 8H4a8 8 0 018 8v.25a.75.75 0 01-.75.75h-.5a.75.75 0 01-.75-.75V16a6 6 0 00-6-6h-.25A.75.75 0 013 9.25v-.5zM7 15a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Subscribe</span></a></div></div></div><div class="-mr-2 flex lg:hidden"><button class="inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" id="headlessui-disclosure-button-:R19m:" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open navigation menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="block h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div></div></div></nav><main class="mb-20 flex-1 flex flex-col"><div class="h-48 md:h-64"><div class="after:absolute after:block after:bg-blue-400 after:blur-3xl after:content-[&#x27; &#x27;] after:h-96 after:opacity-5 after:right-0 after:rounded-full after:top-20 after:w-1/2 after:z-0 before:absolute before:block before:blur-3xl before:bg-orange-400 before:content-[&#x27; &#x27;] before:h-96 before:left-0 before:opacity-5 before:rounded-full before:w-1/2 before:z-0 w-full h-full relative"><div class="relative z-10 w-full h-[125%] -top-[25%] bg-no-repeat bg-cover bg-bottom flex items-center justify-center" style="background-image:url(/security-labs/grid.svg)"></div></div></div><article class="px-4"><div class="max-w-5xl mx-auto relative z-10 flex flex-col space-y-4"><div class="eyebrow break-words"><time class="block mb-2 md:mb-0 md:inline-block article-published-date" dateTime="2023-04-10T00:00:00.000Z">10 April 2023</time><span class="hidden md:inline-block md:mx-2">•</span><a class="hover:text-blue-400 text-xs md:text-sm whitespace-nowrap author-name" href="/security-labs/author/salim-bitam">Salim Bitam</a></div><h1 class="font-bold leading-tighter text-3xl md:text-5xl"><span>Attack chain leads to XWORM and&nbsp;AGENTTESLA</span></h1><p class="text-zinc-200 text-base md:text-xl">Our team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate.</p><div class="flex items-center mt-4 text-zinc-200 text-sm space-x-4 border-t border-white/25 pt-4"><span class="flex items-center space-x-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-4 w-4 text-zinc-400"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>10 min read</span></span><span class="flex items-center space-x-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-4 w-4 text-zinc-400"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z"></path></svg><span><a class="hover:text-blue-400 whitespace-nowrap" href="/security-labs/category/attack-pattern">Attack pattern</a>, </span><span><a class="hover:text-blue-400 whitespace-nowrap" href="/security-labs/category/malware-analysis">Malware analysis</a></span></span></div></div><div class="max-w-6xl mx-auto"><div class="bg-zinc-900 border border-zinc-800 drop-shadow-lg p-5 sm:p-8 md:p-10 rounded-3xl mt-5 md:mt-10"><div class="relative w-full rounded-lg overflow-hidden aspect-video"><img alt="Attack chain leads to XWORM and AGENTTESLA" fetchpriority="high" decoding="async" data-nimg="fill" class="object-cover absolute h-full w-full" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;color:transparent" sizes="100vw" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=640&amp;q=75 640w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=750&amp;q=75 750w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=828&amp;q=75 828w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=1080&amp;q=75 1080w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=1200&amp;q=75 1200w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=1920&amp;q=75 1920w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=2048&amp;q=75 2048w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=3840&amp;q=75 3840w" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fblog-thumb-coin-stacks.jpg&amp;w=3840&amp;q=75"/><div class="absolute border border-white/50 inset-0 mix-blend-overlay rounded-lg z-10"></div></div></div></div><div class="lg:max-w-5xl mx-auto relative mt-12 lg:grid lg:grid-cols-4 lg:gap-8 items-start"><div class="flex justify-center mx-auto lg:col-span-3"><div class="prose prose-invert w-full article-content"><div><h2 class="font-bold text-xl md:text-3xl relative"><span id="key-takeaways" class="absolute -top-32"></span>Key Takeaways</h2>
<ul>
<li>Threat actors are deploying known malware using their own custom .NET loaders</li>
<li>The threat actors employ simple and well-known tactics such as bypassing AMSI through patching and a basic custom .NET loader</li>
<li>The threat actors are abusing legitimate free file hosting services</li>
</ul>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="preamble" class="absolute -top-32"></span>Preamble</h2>
<p>Our team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate, but are in fact fake, the adversary leverages weaponized word documents to execute malicious PowerShell scripts, and also utilizes a custom obfuscated .NET loader to load various malware strains, including XWORM and AGENTTESLA.</p>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="rtf-loader-code-analysis" class="absolute -top-32"></span>RTF loader code analysis</h2>
<h3 class="font-bold leading-tight text-xl relative"><span id="overview" class="absolute -top-32"></span>Overview</h3>
<p>During a recent investigation, we discovered a malicious word document named <code>Card &amp; Booking Details.docx</code>. This document has been designed with the intent to deceive the victim and includes two falsified scanned documents, namely a credit card and a passport.</p>
<p>Upon opening the document, an RTF object hosted at <code>www.mediafire[.]com/file/79jzbqigitjp2v2/p2.rtf</code> is fetched.</p>
<p>This RTF object contains a macro-enabled Excel object. When opened, this macro downloads an obfuscated powerShell script which in turn deploys different malware families.</p>
<p>At the time of this writing, we have observed two distinct malware families, namely XWORM and AGENTTESLA, have been deployed through this execution chain. Both malware families mentioned above are loaded into the compromised system&#x27;s memory by the same custom .NET loader. Once loaded, the malicious payload can carry out a range of functions, such as stealing sensitive data and executing commands on the compromised system.</p>
<p><img alt="Execution flow diagram" loading="lazy" width="1999" height="979" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage8.png&amp;w=2048&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage8.png&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage8.png&amp;w=3840&amp;q=90"/></p>
<p>In this research post, we will walk through the initial execution of the malware and detail the capabilities we discovered.</p>
<h3 class="font-bold leading-tight text-xl relative"><span id="extracting-the-malicious-vba" class="absolute -top-32"></span>Extracting the malicious VBA</h3>
<p>The RTF document contains multiple embedded objects, including an interesting one that caught our attention: <code>Excel.SheetMacroEnabled</code>.</p>
<p><img alt="Listing objects embedded in the RTF document" loading="lazy" width="1440" height="80" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage1.jpg&amp;w=1920&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage1.jpg&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage1.jpg&amp;w=3840&amp;q=90"/></p>
<p>We can use <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/rtfdump.py"><code>rtfdumpy.py</code></a>, a script developed by Didier Stevens to analyze RTF files, to dump the object and <a href="https://www.decalage.info/python/olevba"><code>olevba.py</code></a>, a script developed by Philippe Lagadec, to extract any embedded VBA scripts from an <a href="https://en.wikipedia.org/wiki/Object_Linking_and_Embedding">OLE</a> object. The extracted VBA script shown below downloads and executes a malicious powershell script from <code>https://www.mediafire[.]com/file/xnqxmqlcj51501d/7000m.txt/file</code>.</p>
<p><img alt="Extracting the VBA script from the Excel sheet object" loading="lazy" width="1999" height="1211" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage2.png&amp;w=2048&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage2.png&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage2.png&amp;w=3840&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="powershell-script-analysis" class="absolute -top-32"></span>Powershell script analysis</h3>
<p>The malicious PowerShell script is obfuscated using string substitution to evade detection and make analysis more difficult.</p>
<p><img alt="Powershell script obfuscated using string substitution" loading="lazy" width="1999" height="737" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage13.png&amp;w=2048&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage13.png&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage13.png&amp;w=3840&amp;q=90"/></p>
<p>It contains additional powershell script blocks in hex format that will be deployed in the infected machine designed to prepare the environment by setting up persistence, bypassing AMSI, disabling Windows defender and creating a mechanism to update the malware. The ultimate objective is to install two .NET binaries, namely a loader and a payload (XWORM / AGENTTESLA).</p>
<h3 class="font-bold leading-tight text-xl relative"><span id="deleting-the-malicious-document" class="absolute -top-32"></span>Deleting the malicious document</h3>
<p>The malware starts by deleting the original Word document, first killing the process <code>Winword.exe</code> and then deleting all .DOCX files located in the default <code>Downloads</code> and <code>Desktop</code> folders of every user. This initial step shows the malware&#x27;s destructive nature and how it can potentially harm the user&#x27;s data.</p>
<p><img alt="Powershell command to delete the malicious word document" loading="lazy" width="830" height="194" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage5.jpg&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage5.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage5.jpg&amp;w=1920&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="persistence" class="absolute -top-32"></span>Persistence</h3>
<p>The malware creates a directory in the path <code>C:\ProgramData\MinMinons</code> , which is used to store other Powershell scripts and binaries. The currently running Powershell script is then copied to <code>C:\ProgramData\MinMinons\Candlegraphy.\_\_\_</code>.</p>
<p>Next, the malware deobfuscates the first embedded Powershell script which is used to create persistence. It first writes a JScript file that invokes the original Powershell script saved in <code>C:\ProgramData\MinMinons\Candlegraphy.\_\_\_</code> through the activeXObject shell, then a scheduled task named “MOperaChrome” is created to run the JScript file using the Microsoft signed <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wscript">Windows Script Host (WSH) utility</a>, <code>wscript.exe</code>.</p>
<p><img alt="Persistence through task scheduling" loading="lazy" width="1132" height="101" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage10.jpg&amp;w=1200&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage10.jpg&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage10.jpg&amp;w=3840&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="amsi-bypass" class="absolute -top-32"></span>AMSI bypass</h3>
<p>The second embedded powershell script is responsible for bypassing AMSI by patching the <code>amsiInitFailed</code> flag. In doing so, the initialization of AMSI fails, leading to the prevention of any scan being initiated for the ongoing process. Furthermore, the PowerShell script proceeds to disable the Microsoft Windows Defender service.</p>
<p><img alt="Disabling WinDefend service" loading="lazy" width="830" height="194" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage5.jpg&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage5.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage5.jpg&amp;w=1920&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="user-creation" class="absolute -top-32"></span>User creation</h3>
<p>The script creates a local administrator account named “System32” and adds it to the Remote Desktop Users group. This enables the attacker to log in via Remote Desktop Protocol (RDP). Next, the script disables the machine&#x27;s firewall to allow inbound RDP connection attempts which aren’t filtered by edge controls.</p>
<p><img alt="Creating a backdoor user" loading="lazy" width="756" height="182" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage9.jpg&amp;w=828&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage9.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage9.jpg&amp;w=1920&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="malware-update-persistence" class="absolute -top-32"></span>Malware update persistence</h3>
<p>The third embedded script stores a secondary JScript file, whose purpose is downloading a revised or updated version of the malware. This file is saved to a predetermined location at <code>C:\ProgramData\MinMinons\miguan.js</code>. Furthermore, a scheduled task with the name (“miguaned”) is created to execute the JScript file through <code>wscript.exe</code> , similar to the previously described task.</p>
<p>The JScript creates an instance of <code>WScript.Shell</code> object by calling ActiveXObject with the following CLSID <code>{F935DC22-1CF0-11D0-ADB9-00C04FD58A0B}</code> which corresponds to Shell Object, then downloads from the URL <code>https://billielishhui.blogspot[.]com/atom.xml</code> the update powershell malware.</p>
<p><img alt="JScript script used for updating the malware" loading="lazy" width="1146" height="136" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage4.jpg&amp;w=1200&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage4.jpg&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage4.jpg&amp;w=3840&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="net-loader" class="absolute -top-32"></span>.NET loader</h3>
<p>The custom DOTNET loader employs the <a href="https://learn.microsoft.com/en-us/dotnet/standard/native-interop/pinvoke">P/INVOKE technique</a> to call the native Windows API and inject a payload into a signed microsoft binary via <a href="https://attack.mitre.org/techniques/T1055/012/">process hollowing</a>.</p>
<p>The loader’s code employs various obfuscation techniques to hinder analysis, including the use of dead instruction, renamed symbols to make the code less readable and more confusion and encoded strings. Fortunately a tool like <a href="https://github.com/de4dot/de4dot">de4dot</a> can be used to output a human-readable version of it.</p>
<p><img alt=".NET loader code obfuscation" loading="lazy" width="1239" height="1009" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage12.jpg&amp;w=1920&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage12.jpg&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage12.jpg&amp;w=3840&amp;q=90"/></p>
<p>The malware leverages the <code>LoadLibrary</code> and <code>GetProcAddress</code> APIs to access the required Windows APIs. To obscure the names of these APIs, the loader stores them in an encoded format within the binary file, utilizing a sequence of substitution and string reversal methods.</p>
<p><img alt=".NET loader string obfuscation" loading="lazy" width="1440" height="657" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage3.jpg&amp;w=1920&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage3.jpg&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage3.jpg&amp;w=3840&amp;q=90"/></p>
<p>The loader then starts a process in a suspended state using <code>CreateProcessA</code> API. The following is the list of executables it uses as a host for it’s malicious code:</p>
<ul>
<li><code>C:\Windows\Microsoft.NET\Framework\v4.0.30319\RegSvcs.exe</code></li>
<li><code>C:\Windows\Microsoft.NET\Framework\v2.0.50727\RegSvcs.exe</code></li>
<li><code>C:\Windows\Microsoft.NET\Framework\v3.5\Msbuild.exe</code></li>
</ul>
<p>These binaries are signed and trusted by the system and can evade detection by security software that relies on whitelisting system processes. It then uses <code>Zwunmapviewofsection</code> to unmap the memory of the target process, writes the payload to the suspended process and then resume the thread using <code>ResumeThread</code> API.</p>
<h3 class="font-bold leading-tight text-xl relative"><span id="final-payload" class="absolute -top-32"></span>Final payload</h3>
<p>During our research we discovered that the threat actor has been deploying different payloads. Namely, we observed 2 families: XWORM and AGENTTESLA.</p>
<p>XWORM has gained notoriety in the underground criminal marketplace due to its ability to employ sophisticated capabilities like virtualization and sandbox detection, used to avoid detection and support persistence within an infected system.</p>
<p>Of particular concern is the fact that XWORM is readily available on the internet as a cracked version, with version 2.1 being especially prevalent. This highlights the dangers of underground cybercrime markets and the ease with which malicious actors can access and utilize powerful tools.</p>
<p>Two different versions of the XWORM family were observed versions 2.2 and 3.1. The following is the configuration of a XWORM sample in plain text.</p>
<p><img alt="XWorm configuration" loading="lazy" width="1020" height="727" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage14.jpg&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage14.jpg&amp;w=2048&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage14.jpg&amp;w=2048&amp;q=90"/></p>
<p>AGENTTESLA is a trojan and credential stealer written in .NET. While it first emerged in 2014, it is now among the most active and malicious software. AGENTTESLA is affordably priced and includes support from the developers, making it easily accessible to cybercriminals with limited technical skills.</p>
<p>The sample we analyzed was heavily obfuscated, masqueraded as an AVG installer,and leverages discord for C2. It uploads stolen information to the attacker’s Discord channel via the following webhook: <code>https://discord[.]com/api/webhooks/1089956337733087274/uYNA_D8Ns1z9NZ3B1mGp0XXyGq-785KLGIfEAZsrz3TJd5fvOjXA927F7bUTTzbNT6Zk</code>.</p>
<p><img alt="Agent Tesla masquerading as an AVG installer" loading="lazy" width="740" height="304" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage6.jpg&amp;w=750&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage6.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage6.jpg&amp;w=1920&amp;q=90"/></p>
<p><img alt="The discord webhook extracted dynamically" loading="lazy" width="1999" height="390" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage7.png&amp;w=2048&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage7.png&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fattack-chain-leads-to-xworm-and-agenttesla%2Fimage7.png&amp;w=3840&amp;q=90"/></p>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="observed-adversary-tactics-and-techniques" class="absolute -top-32"></span>Observed adversary tactics and techniques</h2>
<p>Elastic uses the MITRE ATT&amp;CK framework to document common tactics, techniques, and procedures that threats use.</p>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="tactics" class="absolute -top-32"></span>Tactics</h2>
<p>Tactics represent the “why” of a technique or sub-technique. They represent the adversary’s tactical goals: the reason for performing an action.</p>
<ul>
<li><a href="https://attack.mitre.org/tactics/TA0001">Initial access</a></li>
<li><a href="https://attack.mitre.org/tactics/TA0002">Execution</a></li>
<li><a href="https://attack.mitre.org/tactics/TA0003">Persistence</a></li>
<li><a href="https://attack.mitre.org/tactics/TA0011">Command and control</a></li>
<li><a href="https://attack.mitre.org/tactics/TA0005">Defense evasion</a></li>
</ul>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="techniquessubtechniques" class="absolute -top-32"></span>Techniques/subtechniques</h2>
<p>Techniques and Subtechniques represent how an adversary achieves a tactical goal by performing an action.</p>
<ul>
<li><a href="https://attack.mitre.org/techniques/T1055/">Process injection</a></li>
<li><a href="https://attack.mitre.org/techniques/T1070/004/">Indicator removal: File deletion</a></li>
<li><a href="https://attack.mitre.org/techniques/T1053/005/">Scheduled task/job: Scheduled task</a></li>
<li><a href="https://attack.mitre.org/techniques/T1204/002/">User Execution: Malicious File</a></li>
<li><a href="https://attack.mitre.org/techniques/T1566/001/">Phishing: Spearphishing Attachment</a></li>
<li><a href="https://attack.mitre.org/techniques/T1059/003/">Command and Scripting Interpreter: Powershell</a></li>
<li><a href="https://attack.mitre.org/techniques/T1027/">Obfuscated Files or Information</a></li>
<li><a href="https://attack.mitre.org/techniques/T1629/003/">Impair Defenses: Disable or Modify Tools</a></li>
<li><a href="https://attack.mitre.org/techniques/T1136/">Create Account</a></li>
</ul>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="detection-logic" class="absolute -top-32"></span>Detection logic</h2>
<h3 class="font-bold leading-tight text-xl relative"><span id="yara" class="absolute -top-32"></span>YARA</h3>
<p>Elastic Security has created YARA rules to identify this activity. Below are YARA rules to identify XWORM and <a href="https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_AgentTesla.yar">AGENTTESLA</a> malware families.</p>
<pre><code>rule Windows_Trojan_Xworm_732e6c12 {
meta:
    author = &quot;Elastic Security&quot;
    id = &quot;732e6c12-9ee0-4d04-a6e4-9eef874e2716&quot;
    fingerprint = &quot;afbef8e590105e16bbd87bd726f4a3391cd6a4489f7a4255ba78a3af761ad2f0&quot;
    creation_date = &quot;2023-04-03&quot;
    last_modified = &quot;2023-04-03&quot;
    os = &quot;Windows&quot;
    arch = &quot;x86&quot;
    category_type = &quot;Trojan&quot;
    family = &quot;Xworm&quot;
    threat_name = &quot;Windows.Trojan.Xworm&quot;
    source = &quot;Manual&quot;
    maturity = &quot;Diagnostic&quot;
    reference_sample = &quot;bf5ea8d5fd573abb86de0f27e64df194e7f9efbaadd5063dee8ff9c5c3baeaa2&quot;
    scan_type = &quot;File, Memory&quot;
    severity = 100

strings:
    $str1 = &quot;startsp&quot; ascii wide fullword
    $str2 = &quot;injRun&quot; ascii wide fullword
    $str3 = &quot;getinfo&quot; ascii wide fullword
    $str4 = &quot;Xinfo&quot; ascii wide fullword
    $str5 = &quot;openhide&quot; ascii wide fullword
    $str6 = &quot;WScript.Shell&quot; ascii wide fullword
    $str7 = &quot;hidefolderfile&quot; ascii wide fullword
condition:
    all of them}

rule Windows_Trojan_AgentTesla_d3ac2b2f {
meta:
    author = &quot;Elastic Security&quot;
    id = &quot;d3ac2b2f-14fc-4851-8a57-41032e386aeb&quot;
    fingerprint = &quot;cbbb56fe6cd7277ae9595a10e05e2ce535a4e6bf205810be0bbce3a883b6f8bc&quot;
    creation_date = &quot;2021-03-22&quot;
    last_modified = &quot;2022-06-20&quot;
    os = &quot;Windows&quot;
    arch = &quot;x86&quot;
    category_type = &quot;Trojan&quot;
    family = &quot;AgentTesla&quot;
    threat_name = &quot;Windows.Trojan.AgentTesla&quot;
    source = &quot;Manual&quot;
    maturity = &quot;Diagnostic, Production&quot;
    reference_sample = &quot;65463161760af7ab85f5c475a0f7b1581234a1e714a2c5a555783bdd203f85f4&quot;
    scan_type = &quot;File, Memory&quot;
    severity = 100

strings:
    $a1 = &quot;GetMozillaFromLogins&quot; ascii fullword
    $a2 = &quot;AccountConfiguration+username&quot; wide fullword
    $a3 = &quot;MailAccountConfiguration&quot; ascii fullword
    $a4 = &quot;KillTorProcess&quot; ascii fullword
    $a5 = &quot;SmtpAccountConfiguration&quot; ascii fullword
    $a6 = &quot;GetMozillaFromSQLite&quot; ascii fullword
</code></pre></div></div></div><div class="hidden lg:flex lg:col-span-1 text-sm lg:flex-col lg:space-y-6"><div class="toc"><h4 class="font-bold leading-tight text-lg mb-3">Jump to section</h4><ul class="flex flex-col space-y-2"><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/attack-chain-leads-to-xworm-and-agenttesla#key-takeaways"><span>Key&nbsp;Takeaways</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/attack-chain-leads-to-xworm-and-agenttesla#preamble"><span>Preamble</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/attack-chain-leads-to-xworm-and-agenttesla#rtf-loader-code-analysis"><span>RTF loader code&nbsp;analysis</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/attack-chain-leads-to-xworm-and-agenttesla#overview"><span>Overview</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/attack-chain-leads-to-xworm-and-agenttesla#extracting-the-malicious-vba"><span>Extracting the malicious&nbsp;VBA</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/attack-chain-leads-to-xworm-and-agenttesla#powershell-script-analysis"><span>Powershell script&nbsp;analysis</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/attack-chain-leads-to-xworm-and-agenttesla#deleting-the-malicious-document"><span>Deleting the malicious&nbsp;document</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/attack-chain-leads-to-xworm-and-agenttesla#persistence"><span>Persistence</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/attack-chain-leads-to-xworm-and-agenttesla#amsi-bypass"><span>AMSI&nbsp;bypass</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/attack-chain-leads-to-xworm-and-agenttesla#user-creation"><span>User&nbsp;creation</span></a></li></ul><button class="border-t border-white/20 w-full mt-3 py-2 flex items-center space-x-1 text-xs font-medium uppercase tracking-wide hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="w-3 h-3"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg><span>Show more</span></button></div><div class="bg-zinc-900 border border-zinc-800 drop-shadow-lg p-5 md:p-2 sm:p-4 md:px-6 md:py-4 rounded-xl"><h4 class="font-bold leading-tight text-lg mb-3">Elastic Security Labs Newsletter</h4><div><a target="_blank" class="button inline-flex" href="https://www.elastic.co/security-labs/newsletter?utm_source=security-labs">Sign Up</a></div></div></div></div><div class="bg-zinc-900 border border-zinc-800 drop-shadow-lg p-5 md:p-2 sm:p-4 md:px-6 md:py-4 rounded-xl my-5 md:my-10 max-w-3xl mx-auto flex flex-col items-center shadow-2xl"><h4 class="font-bold leading-tight text-lg">Share this article</h4><div class="flex flex-wrap items-center justify-center mt-4 space-x-4"><a class="flex items-center space-x-2 button" href="https://twitter.com/intent/tweet?text=Attack chain leads to XWORM and AGENTTESLA&amp;url=https://www.elastic.co/security-labs/attack-chain-leads-to-xworm-and-agenttesla" target="_blank" rel="noopener noreferrer" aria-label="Share this article on Twitter" title="Share this article on Twitter"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M23.954 4.569c-.885.389-1.83.653-2.825.772a4.98 4.98 0 002.187-2.746 9.955 9.955 0 01-3.157 1.204 4.98 4.98 0 00-8.49 4.54A14.128 14.128 0 011.69 3.05a4.98 4.98 0 001.54 6.638A4.94 4.94 0 011.2 8.62v.06a4.98 4.98 0 004 4.87 4.94 4.94 0 01-2.24.086 4.98 4.98 0 004.64 3.45A9.97 9.97 0 010 20.35a14.075 14.075 0 007.59 2.22c9.16 0 14.17-7.583 14.17-14.17 0-.217-.005-.434-.015-.65a10.128 10.128 0 002.485-2.58l-.001-.001z"></path></svg><span>Twitter</span></a><a class="flex items-center space-x-2 button" href="https://www.facebook.com/sharer/sharer.php?u=https://www.elastic.co/security-labs/attack-chain-leads-to-xworm-and-agenttesla" target="_blank" rel="noopener noreferrer" aria-label="Share this article on Facebook" title="Share this article on Facebook"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M22.5 12c0-5.799-4.701-10.5-10.5-10.5S1.5 6.201 1.5 12c0 5.301 3.901 9.699 9 10.401V14.4h-2.7v-2.7h2.7v-2.1c0-2.7 1.8-4.2 4.2-4.2 1.2 0 2.1.1 2.4.2v2.4h-1.5c-1.2 0-1.5.6-1.5 1.5v1.8h3l-.3 2.7h-2.7V22C18.599 21.3 22.5 17.301 22.5 12z"></path></svg><span>Facebook</span></a><a class="flex items-center space-x-2 button" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.elastic.co/security-labs/attack-chain-leads-to-xworm-and-agenttesla&amp;title=Attack chain leads to XWORM and AGENTTESLA" target="_blank" rel="noopener noreferrer" aria-label="Share this article on LinkedIn" title="Share this article on LinkedIn"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg><span>LinkedIn</span></a><a class="flex items-center space-x-2 button" href="https://reddit.com/submit?url=https://www.elastic.co/security-labs/attack-chain-leads-to-xworm-and-agenttesla&amp;title=Attack chain leads to XWORM and AGENTTESLA" target="_blank" rel="noopener noreferrer" aria-label="Share this article on Reddit" title="Share this article on Reddit"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M24 12C24 18.6274 18.6274 24 12 24C5.37258 24 0 18.6274 0 12C0 5.37258 5.37258 0 12 0C18.6274 0 24 5.37258 24 12ZM19.6879 11.0584C19.8819 11.3352 19.9916 11.6622 20.004 12C20.0091 12.3306 19.9205 12.656 19.7485 12.9384C19.5765 13.2208 19.3281 13.4488 19.032 13.596C19.0455 13.7717 19.0455 13.9483 19.032 14.124C19.032 16.812 15.9 18.996 12.036 18.996C8.172 18.996 5.04 16.812 5.04 14.124C5.02649 13.9483 5.02649 13.7717 5.04 13.596C4.80919 13.49 4.6042 13.335 4.43923 13.1419C4.27427 12.9487 4.15327 12.722 4.08462 12.4775C4.01598 12.2329 4.00133 11.9764 4.04169 11.7256C4.08205 11.4748 4.17646 11.2358 4.31837 11.0251C4.46028 10.8145 4.6463 10.6372 4.86354 10.5056C5.08078 10.3739 5.32404 10.2911 5.57646 10.2629C5.82889 10.2346 6.08444 10.2616 6.32541 10.3419C6.56638 10.4222 6.78701 10.5539 6.972 10.728C8.35473 9.79023 9.98146 9.27718 11.652 9.252L12.54 5.088C12.55 5.03979 12.5694 4.99405 12.5972 4.95341C12.625 4.91277 12.6605 4.87805 12.7018 4.85127C12.7431 4.82448 12.7894 4.80615 12.8378 4.79735C12.8862 4.78855 12.9359 4.78945 12.984 4.8L15.924 5.388C16.0676 5.14132 16.2944 4.9539 16.5637 4.85937C16.833 4.76484 17.1272 4.7694 17.3934 4.87222C17.6597 4.97505 17.8806 5.1694 18.0164 5.42041C18.1523 5.67141 18.1942 5.96262 18.1348 6.24177C18.0753 6.52092 17.9182 6.76972 17.6918 6.94352C17.4654 7.11732 17.1845 7.20473 16.8995 7.19006C16.6144 7.1754 16.3439 7.05962 16.1366 6.8635C15.9292 6.66738 15.7985 6.40378 15.768 6.12L13.2 5.58L12.42 9.324C14.0702 9.3594 15.6749 9.87206 17.04 10.8C17.2839 10.566 17.5902 10.4074 17.9221 10.3436C18.254 10.2797 18.5973 10.3132 18.9106 10.4401C19.2239 10.5669 19.4939 10.7817 19.6879 11.0584ZM8.20624 12.5333C8.07438 12.7307 8.004 12.9627 8.004 13.2C8.004 13.5183 8.13043 13.8235 8.35547 14.0485C8.58051 14.2736 8.88574 14.4 9.204 14.4C9.44134 14.4 9.67335 14.3296 9.87068 14.1978C10.068 14.0659 10.2218 13.8785 10.3127 13.6592C10.4035 13.4399 10.4272 13.1987 10.3809 12.9659C10.3346 12.7331 10.2204 12.5193 10.0525 12.3515C9.8847 12.1836 9.67089 12.0694 9.43811 12.0231C9.20533 11.9768 8.96405 12.0005 8.74478 12.0913C8.52551 12.1822 8.33809 12.336 8.20624 12.5333ZM12.012 17.424C13.0771 17.4681 14.1246 17.1416 14.976 16.5V16.548C15.0075 16.5173 15.0327 16.4806 15.05 16.4402C15.0674 16.3997 15.0766 16.3563 15.0772 16.3122C15.0777 16.2682 15.0696 16.2245 15.0533 16.1837C15.0369 16.1428 15.0127 16.1055 14.982 16.074C14.9513 16.0425 14.9146 16.0173 14.8742 16C14.8337 15.9826 14.7903 15.9734 14.7462 15.9728C14.7022 15.9723 14.6585 15.9804 14.6177 15.9967C14.5768 16.0131 14.5395 16.0373 14.508 16.068C13.7797 16.5904 12.895 16.8487 12 16.8C11.1061 16.8399 10.2255 16.5732 9.504 16.044C9.44182 15.993 9.36289 15.9669 9.28256 15.9708C9.20222 15.9748 9.12622 16.0085 9.06935 16.0653C9.01247 16.1222 8.97879 16.1982 8.97484 16.2786C8.97089 16.3589 8.99697 16.4378 9.048 16.5C9.89937 17.1416 10.9469 17.4681 12.012 17.424ZM14.0933 14.2458C14.2907 14.3776 14.5227 14.448 14.76 14.448L14.748 14.496C14.9107 14.4978 15.0721 14.4664 15.2223 14.4038C15.3725 14.3413 15.5084 14.2488 15.6218 14.1321C15.7352 14.0154 15.8236 13.8768 15.8818 13.7248C15.9399 13.5728 15.9665 13.4106 15.96 13.248C15.96 13.0107 15.8896 12.7787 15.7578 12.5813C15.6259 12.384 15.4385 12.2302 15.2192 12.1393C14.9999 12.0485 14.7587 12.0248 14.5259 12.0711C14.2931 12.1174 14.0793 12.2316 13.9115 12.3995C13.7436 12.5673 13.6294 12.7811 13.5831 13.0139C13.5368 13.2467 13.5605 13.4879 13.6513 13.7072C13.7422 13.9265 13.896 14.1139 14.0933 14.2458Z" fill="currentColor"></path></svg><span>Reddit</span></a></div></div></article></main><footer class="mt-auto text-xs md:text-sm"><div class="container py-6 flex flex-col md:flex-row gap-2 md:gap-0 justify-between items-center"><div class="text-zinc-300"><nav><ul class="flex space-x-4"><li><a class="hover:text-white font-medium" href="/security-labs/sitemap.xml">Sitemap</a></li><li><a class="hover:text-white font-medium flex items-center space-x-1" href="https://elastic.co?utm_source=elastic-search-labs&amp;utm_medium=referral&amp;utm_campaign=search-labs&amp;utm_content=footer"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="inline-block w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"></path></svg><span>Elastic.co</span></a></li><li><a class="hover:text-white font-medium flex items-center space-x-1" href="https://twitter.com/elasticseclabs"><svg class="w-4 h-4 inline-block w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M23.954 4.569c-.885.389-1.83.653-2.825.772a4.98 4.98 0 002.187-2.746 9.955 9.955 0 01-3.157 1.204 4.98 4.98 0 00-8.49 4.54A14.128 14.128 0 011.69 3.05a4.98 4.98 0 001.54 6.638A4.94 4.94 0 011.2 8.62v.06a4.98 4.98 0 004 4.87 4.94 4.94 0 01-2.24.086 4.98 4.98 0 004.64 3.45A9.97 9.97 0 010 20.35a14.075 14.075 0 007.59 2.22c9.16 0 14.17-7.583 14.17-14.17 0-.217-.005-.434-.015-.65a10.128 10.128 0 002.485-2.58l-.001-.001z"></path></svg><span>@elasticseclabs</span></a></li></ul></nav></div><div class="flex flex-col space-y-1 text-zinc-300"><p>© <!-- -->2023<!-- -->. Elasticsearch B.V. All Rights Reserved.</p></div></div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"title":"Attack chain leads to XWORM and AGENTTESLA","slug":"attack-chain-leads-to-xworm-and-agenttesla","date":"2023-04-10","description":"Our team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate.","image":"blog-thumb-coin-stacks.jpg","tags":["xworm","agenttesla"],"body":{"raw":"\n## Key Takeaways\n\n- Threat actors are deploying known malware using their own custom .NET loaders\n- The threat actors employ simple and well-known tactics such as bypassing AMSI through patching and a basic custom .NET loader\n- The threat actors are abusing legitimate free file hosting services\n\n## Preamble\n\nOur team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate, but are in fact fake, the adversary leverages weaponized word documents to execute malicious PowerShell scripts, and also utilizes a custom obfuscated .NET loader to load various malware strains, including XWORM and AGENTTESLA.\n\n## RTF loader code analysis\n\n### Overview\n\nDuring a recent investigation, we discovered a malicious word document named `Card \u0026 Booking Details.docx`. This document has been designed with the intent to deceive the victim and includes two falsified scanned documents, namely a credit card and a passport.\n\nUpon opening the document, an RTF object hosted at `www.mediafire[.]com/file/79jzbqigitjp2v2/p2.rtf` is fetched.\n\nThis RTF object contains a macro-enabled Excel object. When opened, this macro downloads an obfuscated powerShell script which in turn deploys different malware families.\n\nAt the time of this writing, we have observed two distinct malware families, namely XWORM and AGENTTESLA, have been deployed through this execution chain. Both malware families mentioned above are loaded into the compromised system's memory by the same custom .NET loader. Once loaded, the malicious payload can carry out a range of functions, such as stealing sensitive data and executing commands on the compromised system.\n\n![Execution flow diagram](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image8.png)\n\nIn this research post, we will walk through the initial execution of the malware and detail the capabilities we discovered.\n\n### Extracting the malicious VBA\n\nThe RTF document contains multiple embedded objects, including an interesting one that caught our attention: `Excel.SheetMacroEnabled`.\n\n![Listing objects embedded in the RTF document](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image1.jpg)\n\nWe can use [`rtfdumpy.py`](https://github.com/DidierStevens/DidierStevensSuite/blob/master/rtfdump.py), a script developed by Didier Stevens to analyze RTF files, to dump the object and [`olevba.py`](https://www.decalage.info/python/olevba), a script developed by Philippe Lagadec, to extract any embedded VBA scripts from an [OLE](https://en.wikipedia.org/wiki/Object_Linking_and_Embedding) object. The extracted VBA script shown below downloads and executes a malicious powershell script from `https://www.mediafire[.]com/file/xnqxmqlcj51501d/7000m.txt/file`.\n\n![Extracting the VBA script from the Excel sheet object](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image2.png)\n\n### Powershell script analysis\n\nThe malicious PowerShell script is obfuscated using string substitution to evade detection and make analysis more difficult.\n\n![Powershell script obfuscated using string substitution](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image13.png)\n\nIt contains additional powershell script blocks in hex format that will be deployed in the infected machine designed to prepare the environment by setting up persistence, bypassing AMSI, disabling Windows defender and creating a mechanism to update the malware. The ultimate objective is to install two .NET binaries, namely a loader and a payload (XWORM / AGENTTESLA).\n\n### Deleting the malicious document\n\nThe malware starts by deleting the original Word document, first killing the process `Winword.exe` and then deleting all .DOCX files located in the default `Downloads` and `Desktop` folders of every user. This initial step shows the malware's destructive nature and how it can potentially harm the user's data.\n\n![Powershell command to delete the malicious word document](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image5.jpg)\n\n### Persistence\n\nThe malware creates a directory in the path `C:\\ProgramData\\MinMinons` , which is used to store other Powershell scripts and binaries. The currently running Powershell script is then copied to `C:\\ProgramData\\MinMinons\\Candlegraphy.\\_\\_\\_`.\n\nNext, the malware deobfuscates the first embedded Powershell script which is used to create persistence. It first writes a JScript file that invokes the original Powershell script saved in `C:\\ProgramData\\MinMinons\\Candlegraphy.\\_\\_\\_` through the activeXObject shell, then a scheduled task named “MOperaChrome” is created to run the JScript file using the Microsoft signed [Windows Script Host (WSH) utility](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wscript), `wscript.exe`.\n\n![Persistence through task scheduling](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image10.jpg)\n\n### AMSI bypass\n\nThe second embedded powershell script is responsible for bypassing AMSI by patching the `amsiInitFailed` flag. In doing so, the initialization of AMSI fails, leading to the prevention of any scan being initiated for the ongoing process. Furthermore, the PowerShell script proceeds to disable the Microsoft Windows Defender service.\n\n![Disabling WinDefend service](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image5.jpg)\n\n### User creation\n\nThe script creates a local administrator account named “System32” and adds it to the Remote Desktop Users group. This enables the attacker to log in via Remote Desktop Protocol (RDP). Next, the script disables the machine's firewall to allow inbound RDP connection attempts which aren’t filtered by edge controls.\n\n![Creating a backdoor user](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image9.jpg)\n\n### Malware update persistence\n\nThe third embedded script stores a secondary JScript file, whose purpose is downloading a revised or updated version of the malware. This file is saved to a predetermined location at `C:\\ProgramData\\MinMinons\\miguan.js`. Furthermore, a scheduled task with the name (“miguaned”) is created to execute the JScript file through `wscript.exe` , similar to the previously described task.\n\nThe JScript creates an instance of `WScript.Shell` object by calling ActiveXObject with the following CLSID `{F935DC22-1CF0-11D0-ADB9-00C04FD58A0B}` which corresponds to Shell Object, then downloads from the URL `https://billielishhui.blogspot[.]com/atom.xml` the update powershell malware.\n\n![JScript script used for updating the malware](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image4.jpg)\n\n### .NET loader\n\nThe custom DOTNET loader employs the [P/INVOKE technique](https://learn.microsoft.com/en-us/dotnet/standard/native-interop/pinvoke) to call the native Windows API and inject a payload into a signed microsoft binary via [process hollowing](https://attack.mitre.org/techniques/T1055/012/).\n\nThe loader’s code employs various obfuscation techniques to hinder analysis, including the use of dead instruction, renamed symbols to make the code less readable and more confusion and encoded strings. Fortunately a tool like [de4dot](https://github.com/de4dot/de4dot) can be used to output a human-readable version of it.\n\n![.NET loader code obfuscation](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image12.jpg)\n\nThe malware leverages the `LoadLibrary` and `GetProcAddress` APIs to access the required Windows APIs. To obscure the names of these APIs, the loader stores them in an encoded format within the binary file, utilizing a sequence of substitution and string reversal methods.\n\n![.NET loader string obfuscation](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image3.jpg)\n\nThe loader then starts a process in a suspended state using `CreateProcessA` API. The following is the list of executables it uses as a host for it’s malicious code:\n\n- `C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\RegSvcs.exe`\n- `C:\\Windows\\Microsoft.NET\\Framework\\v2.0.50727\\RegSvcs.exe`\n- `C:\\Windows\\Microsoft.NET\\Framework\\v3.5\\Msbuild.exe`\n\nThese binaries are signed and trusted by the system and can evade detection by security software that relies on whitelisting system processes. It then uses `Zwunmapviewofsection` to unmap the memory of the target process, writes the payload to the suspended process and then resume the thread using `ResumeThread` API.\n\n### Final payload\n\nDuring our research we discovered that the threat actor has been deploying different payloads. Namely, we observed 2 families: XWORM and AGENTTESLA.\n\nXWORM has gained notoriety in the underground criminal marketplace due to its ability to employ sophisticated capabilities like virtualization and sandbox detection, used to avoid detection and support persistence within an infected system.\n\nOf particular concern is the fact that XWORM is readily available on the internet as a cracked version, with version 2.1 being especially prevalent. This highlights the dangers of underground cybercrime markets and the ease with which malicious actors can access and utilize powerful tools.\n\nTwo different versions of the XWORM family were observed versions 2.2 and 3.1. The following is the configuration of a XWORM sample in plain text.\n\n![XWorm configuration](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image14.jpg)\n\nAGENTTESLA is a trojan and credential stealer written in .NET. While it first emerged in 2014, it is now among the most active and malicious software. AGENTTESLA is affordably priced and includes support from the developers, making it easily accessible to cybercriminals with limited technical skills.\n\nThe sample we analyzed was heavily obfuscated, masqueraded as an AVG installer,and leverages discord for C2. It uploads stolen information to the attacker’s Discord channel via the following webhook: `https://discord[.]com/api/webhooks/1089956337733087274/uYNA_D8Ns1z9NZ3B1mGp0XXyGq-785KLGIfEAZsrz3TJd5fvOjXA927F7bUTTzbNT6Zk`.\n\n![Agent Tesla masquerading as an AVG installer](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image6.jpg)\n\n![The discord webhook extracted dynamically](/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image7.png)\n\n## Observed adversary tactics and techniques\n\nElastic uses the MITRE ATT\u0026CK framework to document common tactics, techniques, and procedures that threats use.\n\n## Tactics\n\nTactics represent the “why” of a technique or sub-technique. They represent the adversary’s tactical goals: the reason for performing an action.\n\n- [Initial access](https://attack.mitre.org/tactics/TA0001)\n- [Execution](https://attack.mitre.org/tactics/TA0002)\n- [Persistence](https://attack.mitre.org/tactics/TA0003)\n- [Command and control](https://attack.mitre.org/tactics/TA0011)\n- [Defense evasion](https://attack.mitre.org/tactics/TA0005)\n\n## Techniques/subtechniques\n\nTechniques and Subtechniques represent how an adversary achieves a tactical goal by performing an action.\n\n- [Process injection](https://attack.mitre.org/techniques/T1055/)\n- [Indicator removal: File deletion](https://attack.mitre.org/techniques/T1070/004/)\n- [Scheduled task/job: Scheduled task](https://attack.mitre.org/techniques/T1053/005/)\n- [User Execution: Malicious File](https://attack.mitre.org/techniques/T1204/002/)\n- [Phishing: Spearphishing Attachment](https://attack.mitre.org/techniques/T1566/001/)\n- [Command and Scripting Interpreter: Powershell](https://attack.mitre.org/techniques/T1059/003/)\n- [Obfuscated Files or Information](https://attack.mitre.org/techniques/T1027/)\n- [Impair Defenses: Disable or Modify Tools](https://attack.mitre.org/techniques/T1629/003/)\n- [Create Account](https://attack.mitre.org/techniques/T1136/)\n\n## Detection logic\n\n### YARA\n\nElastic Security has created YARA rules to identify this activity. Below are YARA rules to identify XWORM and [AGENTTESLA](https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_AgentTesla.yar) malware families.\n\n```\nrule Windows_Trojan_Xworm_732e6c12 {\nmeta:\n    author = \"Elastic Security\"\n    id = \"732e6c12-9ee0-4d04-a6e4-9eef874e2716\"\n    fingerprint = \"afbef8e590105e16bbd87bd726f4a3391cd6a4489f7a4255ba78a3af761ad2f0\"\n    creation_date = \"2023-04-03\"\n    last_modified = \"2023-04-03\"\n    os = \"Windows\"\n    arch = \"x86\"\n    category_type = \"Trojan\"\n    family = \"Xworm\"\n    threat_name = \"Windows.Trojan.Xworm\"\n    source = \"Manual\"\n    maturity = \"Diagnostic\"\n    reference_sample = \"bf5ea8d5fd573abb86de0f27e64df194e7f9efbaadd5063dee8ff9c5c3baeaa2\"\n    scan_type = \"File, Memory\"\n    severity = 100\n\nstrings:\n    $str1 = \"startsp\" ascii wide fullword\n    $str2 = \"injRun\" ascii wide fullword\n    $str3 = \"getinfo\" ascii wide fullword\n    $str4 = \"Xinfo\" ascii wide fullword\n    $str5 = \"openhide\" ascii wide fullword\n    $str6 = \"WScript.Shell\" ascii wide fullword\n    $str7 = \"hidefolderfile\" ascii wide fullword\ncondition:\n    all of them}\n\nrule Windows_Trojan_AgentTesla_d3ac2b2f {\nmeta:\n    author = \"Elastic Security\"\n    id = \"d3ac2b2f-14fc-4851-8a57-41032e386aeb\"\n    fingerprint = \"cbbb56fe6cd7277ae9595a10e05e2ce535a4e6bf205810be0bbce3a883b6f8bc\"\n    creation_date = \"2021-03-22\"\n    last_modified = \"2022-06-20\"\n    os = \"Windows\"\n    arch = \"x86\"\n    category_type = \"Trojan\"\n    family = \"AgentTesla\"\n    threat_name = \"Windows.Trojan.AgentTesla\"\n    source = \"Manual\"\n    maturity = \"Diagnostic, Production\"\n    reference_sample = \"65463161760af7ab85f5c475a0f7b1581234a1e714a2c5a555783bdd203f85f4\"\n    scan_type = \"File, Memory\"\n    severity = 100\n\nstrings:\n    $a1 = \"GetMozillaFromLogins\" ascii fullword\n    $a2 = \"AccountConfiguration+username\" wide fullword\n    $a3 = \"MailAccountConfiguration\" ascii fullword\n    $a4 = \"KillTorProcess\" ascii fullword\n    $a5 = \"SmtpAccountConfiguration\" ascii fullword\n    $a6 = \"GetMozillaFromSQLite\" ascii fullword\n```\n","code":"var Component=(()=\u003e{var h=Object.create;var s=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,g=Object.prototype.hasOwnProperty;var f=(i,e)=\u003e()=\u003e(e||i((e={exports:{}}).exports,e),e.exports),w=(i,e)=\u003e{for(var a in e)s(i,a,{get:e[a],enumerable:!0})},o=(i,e,a,r)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let n of p(e))!g.call(i,n)\u0026\u0026n!==a\u0026\u0026s(i,n,{get:()=\u003ee[n],enumerable:!(r=m(e,n))||r.enumerable});return i};var b=(i,e,a)=\u003e(a=i!=null?h(u(i)):{},o(e||!i||!i.__esModule?s(a,\"default\",{value:i,enumerable:!0}):a,i)),y=i=\u003eo(s({},\"__esModule\",{value:!0}),i);var l=f((j,c)=\u003e{c.exports=_jsx_runtime});var A={};w(A,{default:()=\u003ek,frontmatter:()=\u003eT});var t=b(l()),T={title:\"Attack chain leads to XWORM and AGENTTESLA\",slug:\"attack-chain-leads-to-xworm-and-agenttesla\",date:\"2023-04-10\",description:\"Our team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate.\",author:[{slug:\"salim-bitam\"}],image:\"blog-thumb-coin-stacks.jpg\",category:[{slug:\"attack-pattern\"},{slug:\"malware-analysis\"}],tags:[\"xworm\",\"agenttesla\"]};function d(i){let e=Object.assign({h2:\"h2\",ul:\"ul\",li:\"li\",p:\"p\",h3:\"h3\",code:\"code\",img:\"img\",a:\"a\",pre:\"pre\"},i.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.h2,{id:\"key-takeaways\",children:\"Key Takeaways\"}),`\n`,(0,t.jsxs)(e.ul,{children:[`\n`,(0,t.jsx)(e.li,{children:\"Threat actors are deploying known malware using their own custom .NET loaders\"}),`\n`,(0,t.jsx)(e.li,{children:\"The threat actors employ simple and well-known tactics such as bypassing AMSI through patching and a basic custom .NET loader\"}),`\n`,(0,t.jsx)(e.li,{children:\"The threat actors are abusing legitimate free file hosting services\"}),`\n`]}),`\n`,(0,t.jsx)(e.h2,{id:\"preamble\",children:\"Preamble\"}),`\n`,(0,t.jsx)(e.p,{children:\"Our team has recently observed a new malware campaign that employs a well-developed process with multiple stages. The campaign is designed to trick unsuspecting users into clicking on the documents, which appear to be legitimate, but are in fact fake, the adversary leverages weaponized word documents to execute malicious PowerShell scripts, and also utilizes a custom obfuscated .NET loader to load various malware strains, including XWORM and AGENTTESLA.\"}),`\n`,(0,t.jsx)(e.h2,{id:\"rtf-loader-code-analysis\",children:\"RTF loader code analysis\"}),`\n`,(0,t.jsx)(e.h3,{id:\"overview\",children:\"Overview\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"During a recent investigation, we discovered a malicious word document named \",(0,t.jsx)(e.code,{children:\"Card \u0026 Booking Details.docx\"}),\". This document has been designed with the intent to deceive the victim and includes two falsified scanned documents, namely a credit card and a passport.\"]}),`\n`,(0,t.jsxs)(e.p,{children:[\"Upon opening the document, an RTF object hosted at \",(0,t.jsx)(e.code,{children:\"www.mediafire[.]com/file/79jzbqigitjp2v2/p2.rtf\"}),\" is fetched.\"]}),`\n`,(0,t.jsx)(e.p,{children:\"This RTF object contains a macro-enabled Excel object. When opened, this macro downloads an obfuscated powerShell script which in turn deploys different malware families.\"}),`\n`,(0,t.jsx)(e.p,{children:\"At the time of this writing, we have observed two distinct malware families, namely XWORM and AGENTTESLA, have been deployed through this execution chain. Both malware families mentioned above are loaded into the compromised system's memory by the same custom .NET loader. Once loaded, the malicious payload can carry out a range of functions, such as stealing sensitive data and executing commands on the compromised system.\"}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image8.png\",alt:\"Execution flow diagram\",width:\"1999\",height:\"979\"})}),`\n`,(0,t.jsx)(e.p,{children:\"In this research post, we will walk through the initial execution of the malware and detail the capabilities we discovered.\"}),`\n`,(0,t.jsx)(e.h3,{id:\"extracting-the-malicious-vba\",children:\"Extracting the malicious VBA\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"The RTF document contains multiple embedded objects, including an interesting one that caught our attention: \",(0,t.jsx)(e.code,{children:\"Excel.SheetMacroEnabled\"}),\".\"]}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image1.jpg\",alt:\"Listing objects embedded in the RTF document\",width:\"1440\",height:\"80\"})}),`\n`,(0,t.jsxs)(e.p,{children:[\"We can use \",(0,t.jsx)(e.a,{href:\"https://github.com/DidierStevens/DidierStevensSuite/blob/master/rtfdump.py\",rel:\"nofollow\",children:(0,t.jsx)(e.code,{children:\"rtfdumpy.py\"})}),\", a script developed by Didier Stevens to analyze RTF files, to dump the object and \",(0,t.jsx)(e.a,{href:\"https://www.decalage.info/python/olevba\",rel:\"nofollow\",children:(0,t.jsx)(e.code,{children:\"olevba.py\"})}),\", a script developed by Philippe Lagadec, to extract any embedded VBA scripts from an \",(0,t.jsx)(e.a,{href:\"https://en.wikipedia.org/wiki/Object_Linking_and_Embedding\",rel:\"nofollow\",children:\"OLE\"}),\" object. The extracted VBA script shown below downloads and executes a malicious powershell script from \",(0,t.jsx)(e.code,{children:\"https://www.mediafire[.]com/file/xnqxmqlcj51501d/7000m.txt/file\"}),\".\"]}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image2.png\",alt:\"Extracting the VBA script from the Excel sheet object\",width:\"1999\",height:\"1211\"})}),`\n`,(0,t.jsx)(e.h3,{id:\"powershell-script-analysis\",children:\"Powershell script analysis\"}),`\n`,(0,t.jsx)(e.p,{children:\"The malicious PowerShell script is obfuscated using string substitution to evade detection and make analysis more difficult.\"}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image13.png\",alt:\"Powershell script obfuscated using string substitution\",width:\"1999\",height:\"737\"})}),`\n`,(0,t.jsx)(e.p,{children:\"It contains additional powershell script blocks in hex format that will be deployed in the infected machine designed to prepare the environment by setting up persistence, bypassing AMSI, disabling Windows defender and creating a mechanism to update the malware. The ultimate objective is to install two .NET binaries, namely a loader and a payload (XWORM / AGENTTESLA).\"}),`\n`,(0,t.jsx)(e.h3,{id:\"deleting-the-malicious-document\",children:\"Deleting the malicious document\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"The malware starts by deleting the original Word document, first killing the process \",(0,t.jsx)(e.code,{children:\"Winword.exe\"}),\" and then deleting all .DOCX files located in the default \",(0,t.jsx)(e.code,{children:\"Downloads\"}),\" and \",(0,t.jsx)(e.code,{children:\"Desktop\"}),\" folders of every user. This initial step shows the malware's destructive nature and how it can potentially harm the user's data.\"]}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image5.jpg\",alt:\"Powershell command to delete the malicious word document\",width:\"830\",height:\"194\"})}),`\n`,(0,t.jsx)(e.h3,{id:\"persistence\",children:\"Persistence\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"The malware creates a directory in the path \",(0,t.jsx)(e.code,{children:\"C:\\\\ProgramData\\\\MinMinons\"}),\" , which is used to store other Powershell scripts and binaries. The currently running Powershell script is then copied to \",(0,t.jsx)(e.code,{children:\"C:\\\\ProgramData\\\\MinMinons\\\\Candlegraphy.\\\\_\\\\_\\\\_\"}),\".\"]}),`\n`,(0,t.jsxs)(e.p,{children:[\"Next, the malware deobfuscates the first embedded Powershell script which is used to create persistence. It first writes a JScript file that invokes the original Powershell script saved in \",(0,t.jsx)(e.code,{children:\"C:\\\\ProgramData\\\\MinMinons\\\\Candlegraphy.\\\\_\\\\_\\\\_\"}),\" through the activeXObject shell, then a scheduled task named \\u201CMOperaChrome\\u201D is created to run the JScript file using the Microsoft signed \",(0,t.jsx)(e.a,{href:\"https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wscript\",rel:\"nofollow\",children:\"Windows Script Host (WSH) utility\"}),\", \",(0,t.jsx)(e.code,{children:\"wscript.exe\"}),\".\"]}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image10.jpg\",alt:\"Persistence through task scheduling\",width:\"1132\",height:\"101\"})}),`\n`,(0,t.jsx)(e.h3,{id:\"amsi-bypass\",children:\"AMSI bypass\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"The second embedded powershell script is responsible for bypassing AMSI by patching the \",(0,t.jsx)(e.code,{children:\"amsiInitFailed\"}),\" flag. In doing so, the initialization of AMSI fails, leading to the prevention of any scan being initiated for the ongoing process. Furthermore, the PowerShell script proceeds to disable the Microsoft Windows Defender service.\"]}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image5.jpg\",alt:\"Disabling WinDefend service\",width:\"830\",height:\"194\"})}),`\n`,(0,t.jsx)(e.h3,{id:\"user-creation\",children:\"User creation\"}),`\n`,(0,t.jsx)(e.p,{children:\"The script creates a local administrator account named \\u201CSystem32\\u201D and adds it to the Remote Desktop Users group. This enables the attacker to log in via Remote Desktop Protocol (RDP). Next, the script disables the machine's firewall to allow inbound RDP connection attempts which aren\\u2019t filtered by edge controls.\"}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image9.jpg\",alt:\"Creating a backdoor user\",width:\"756\",height:\"182\"})}),`\n`,(0,t.jsx)(e.h3,{id:\"malware-update-persistence\",children:\"Malware update persistence\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"The third embedded script stores a secondary JScript file, whose purpose is downloading a revised or updated version of the malware. This file is saved to a predetermined location at \",(0,t.jsx)(e.code,{children:\"C:\\\\ProgramData\\\\MinMinons\\\\miguan.js\"}),\". Furthermore, a scheduled task with the name (\\u201Cmiguaned\\u201D) is created to execute the JScript file through \",(0,t.jsx)(e.code,{children:\"wscript.exe\"}),\" , similar to the previously described task.\"]}),`\n`,(0,t.jsxs)(e.p,{children:[\"The JScript creates an instance of \",(0,t.jsx)(e.code,{children:\"WScript.Shell\"}),\" object by calling ActiveXObject with the following CLSID \",(0,t.jsx)(e.code,{children:\"{F935DC22-1CF0-11D0-ADB9-00C04FD58A0B}\"}),\" which corresponds to Shell Object, then downloads from the URL \",(0,t.jsx)(e.code,{children:\"https://billielishhui.blogspot[.]com/atom.xml\"}),\" the update powershell malware.\"]}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image4.jpg\",alt:\"JScript script used for updating the malware\",width:\"1146\",height:\"136\"})}),`\n`,(0,t.jsx)(e.h3,{id:\"net-loader\",children:\".NET loader\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"The custom DOTNET loader employs the \",(0,t.jsx)(e.a,{href:\"https://learn.microsoft.com/en-us/dotnet/standard/native-interop/pinvoke\",rel:\"nofollow\",children:\"P/INVOKE technique\"}),\" to call the native Windows API and inject a payload into a signed microsoft binary via \",(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1055/012/\",rel:\"nofollow\",children:\"process hollowing\"}),\".\"]}),`\n`,(0,t.jsxs)(e.p,{children:[\"The loader\\u2019s code employs various obfuscation techniques to hinder analysis, including the use of dead instruction, renamed symbols to make the code less readable and more confusion and encoded strings. Fortunately a tool like \",(0,t.jsx)(e.a,{href:\"https://github.com/de4dot/de4dot\",rel:\"nofollow\",children:\"de4dot\"}),\" can be used to output a human-readable version of it.\"]}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image12.jpg\",alt:\".NET loader code obfuscation\",width:\"1239\",height:\"1009\"})}),`\n`,(0,t.jsxs)(e.p,{children:[\"The malware leverages the \",(0,t.jsx)(e.code,{children:\"LoadLibrary\"}),\" and \",(0,t.jsx)(e.code,{children:\"GetProcAddress\"}),\" APIs to access the required Windows APIs. To obscure the names of these APIs, the loader stores them in an encoded format within the binary file, utilizing a sequence of substitution and string reversal methods.\"]}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image3.jpg\",alt:\".NET loader string obfuscation\",width:\"1440\",height:\"657\"})}),`\n`,(0,t.jsxs)(e.p,{children:[\"The loader then starts a process in a suspended state using \",(0,t.jsx)(e.code,{children:\"CreateProcessA\"}),\" API. The following is the list of executables it uses as a host for it\\u2019s malicious code:\"]}),`\n`,(0,t.jsxs)(e.ul,{children:[`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:\"C:\\\\Windows\\\\Microsoft.NET\\\\Framework\\\\v4.0.30319\\\\RegSvcs.exe\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:\"C:\\\\Windows\\\\Microsoft.NET\\\\Framework\\\\v2.0.50727\\\\RegSvcs.exe\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:\"C:\\\\Windows\\\\Microsoft.NET\\\\Framework\\\\v3.5\\\\Msbuild.exe\"})}),`\n`]}),`\n`,(0,t.jsxs)(e.p,{children:[\"These binaries are signed and trusted by the system and can evade detection by security software that relies on whitelisting system processes. It then uses \",(0,t.jsx)(e.code,{children:\"Zwunmapviewofsection\"}),\" to unmap the memory of the target process, writes the payload to the suspended process and then resume the thread using \",(0,t.jsx)(e.code,{children:\"ResumeThread\"}),\" API.\"]}),`\n`,(0,t.jsx)(e.h3,{id:\"final-payload\",children:\"Final payload\"}),`\n`,(0,t.jsx)(e.p,{children:\"During our research we discovered that the threat actor has been deploying different payloads. Namely, we observed 2 families: XWORM and AGENTTESLA.\"}),`\n`,(0,t.jsx)(e.p,{children:\"XWORM has gained notoriety in the underground criminal marketplace due to its ability to employ sophisticated capabilities like virtualization and sandbox detection, used to avoid detection and support persistence within an infected system.\"}),`\n`,(0,t.jsx)(e.p,{children:\"Of particular concern is the fact that XWORM is readily available on the internet as a cracked version, with version 2.1 being especially prevalent. This highlights the dangers of underground cybercrime markets and the ease with which malicious actors can access and utilize powerful tools.\"}),`\n`,(0,t.jsx)(e.p,{children:\"Two different versions of the XWORM family were observed versions 2.2 and 3.1. The following is the configuration of a XWORM sample in plain text.\"}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image14.jpg\",alt:\"XWorm configuration\",width:\"1020\",height:\"727\"})}),`\n`,(0,t.jsx)(e.p,{children:\"AGENTTESLA is a trojan and credential stealer written in .NET. While it first emerged in 2014, it is now among the most active and malicious software. AGENTTESLA is affordably priced and includes support from the developers, making it easily accessible to cybercriminals with limited technical skills.\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"The sample we analyzed was heavily obfuscated, masqueraded as an AVG installer,and leverages discord for C2. It uploads stolen information to the attacker\\u2019s Discord channel via the following webhook: \",(0,t.jsx)(e.code,{children:\"https://discord[.]com/api/webhooks/1089956337733087274/uYNA_D8Ns1z9NZ3B1mGp0XXyGq-785KLGIfEAZsrz3TJd5fvOjXA927F7bUTTzbNT6Zk\"}),\".\"]}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image6.jpg\",alt:\"Agent Tesla masquerading as an AVG installer\",width:\"740\",height:\"304\"})}),`\n`,(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{src:\"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/image7.png\",alt:\"The discord webhook extracted dynamically\",width:\"1999\",height:\"390\"})}),`\n`,(0,t.jsx)(e.h2,{id:\"observed-adversary-tactics-and-techniques\",children:\"Observed adversary tactics and techniques\"}),`\n`,(0,t.jsx)(e.p,{children:\"Elastic uses the MITRE ATT\u0026CK framework to document common tactics, techniques, and procedures that threats use.\"}),`\n`,(0,t.jsx)(e.h2,{id:\"tactics\",children:\"Tactics\"}),`\n`,(0,t.jsx)(e.p,{children:\"Tactics represent the \\u201Cwhy\\u201D of a technique or sub-technique. They represent the adversary\\u2019s tactical goals: the reason for performing an action.\"}),`\n`,(0,t.jsxs)(e.ul,{children:[`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/tactics/TA0001\",rel:\"nofollow\",children:\"Initial access\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/tactics/TA0002\",rel:\"nofollow\",children:\"Execution\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/tactics/TA0003\",rel:\"nofollow\",children:\"Persistence\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/tactics/TA0011\",rel:\"nofollow\",children:\"Command and control\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/tactics/TA0005\",rel:\"nofollow\",children:\"Defense evasion\"})}),`\n`]}),`\n`,(0,t.jsx)(e.h2,{id:\"techniquessubtechniques\",children:\"Techniques/subtechniques\"}),`\n`,(0,t.jsx)(e.p,{children:\"Techniques and Subtechniques represent how an adversary achieves a tactical goal by performing an action.\"}),`\n`,(0,t.jsxs)(e.ul,{children:[`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1055/\",rel:\"nofollow\",children:\"Process injection\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1070/004/\",rel:\"nofollow\",children:\"Indicator removal: File deletion\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1053/005/\",rel:\"nofollow\",children:\"Scheduled task/job: Scheduled task\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1204/002/\",rel:\"nofollow\",children:\"User Execution: Malicious File\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1566/001/\",rel:\"nofollow\",children:\"Phishing: Spearphishing Attachment\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1059/003/\",rel:\"nofollow\",children:\"Command and Scripting Interpreter: Powershell\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1027/\",rel:\"nofollow\",children:\"Obfuscated Files or Information\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1629/003/\",rel:\"nofollow\",children:\"Impair Defenses: Disable or Modify Tools\"})}),`\n`,(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1136/\",rel:\"nofollow\",children:\"Create Account\"})}),`\n`]}),`\n`,(0,t.jsx)(e.h2,{id:\"detection-logic\",children:\"Detection logic\"}),`\n`,(0,t.jsx)(e.h3,{id:\"yara\",children:\"YARA\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"Elastic Security has created YARA rules to identify this activity. Below are YARA rules to identify XWORM and \",(0,t.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_AgentTesla.yar\",rel:\"nofollow\",children:\"AGENTTESLA\"}),\" malware families.\"]}),`\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`rule Windows_Trojan_Xworm_732e6c12 {\nmeta:\n    author = \"Elastic Security\"\n    id = \"732e6c12-9ee0-4d04-a6e4-9eef874e2716\"\n    fingerprint = \"afbef8e590105e16bbd87bd726f4a3391cd6a4489f7a4255ba78a3af761ad2f0\"\n    creation_date = \"2023-04-03\"\n    last_modified = \"2023-04-03\"\n    os = \"Windows\"\n    arch = \"x86\"\n    category_type = \"Trojan\"\n    family = \"Xworm\"\n    threat_name = \"Windows.Trojan.Xworm\"\n    source = \"Manual\"\n    maturity = \"Diagnostic\"\n    reference_sample = \"bf5ea8d5fd573abb86de0f27e64df194e7f9efbaadd5063dee8ff9c5c3baeaa2\"\n    scan_type = \"File, Memory\"\n    severity = 100\n\nstrings:\n    $str1 = \"startsp\" ascii wide fullword\n    $str2 = \"injRun\" ascii wide fullword\n    $str3 = \"getinfo\" ascii wide fullword\n    $str4 = \"Xinfo\" ascii wide fullword\n    $str5 = \"openhide\" ascii wide fullword\n    $str6 = \"WScript.Shell\" ascii wide fullword\n    $str7 = \"hidefolderfile\" ascii wide fullword\ncondition:\n    all of them}\n\nrule Windows_Trojan_AgentTesla_d3ac2b2f {\nmeta:\n    author = \"Elastic Security\"\n    id = \"d3ac2b2f-14fc-4851-8a57-41032e386aeb\"\n    fingerprint = \"cbbb56fe6cd7277ae9595a10e05e2ce535a4e6bf205810be0bbce3a883b6f8bc\"\n    creation_date = \"2021-03-22\"\n    last_modified = \"2022-06-20\"\n    os = \"Windows\"\n    arch = \"x86\"\n    category_type = \"Trojan\"\n    family = \"AgentTesla\"\n    threat_name = \"Windows.Trojan.AgentTesla\"\n    source = \"Manual\"\n    maturity = \"Diagnostic, Production\"\n    reference_sample = \"65463161760af7ab85f5c475a0f7b1581234a1e714a2c5a555783bdd203f85f4\"\n    scan_type = \"File, Memory\"\n    severity = 100\n\nstrings:\n    $a1 = \"GetMozillaFromLogins\" ascii fullword\n    $a2 = \"AccountConfiguration+username\" wide fullword\n    $a3 = \"MailAccountConfiguration\" ascii fullword\n    $a4 = \"KillTorProcess\" ascii fullword\n    $a5 = \"SmtpAccountConfiguration\" ascii fullword\n    $a6 = \"GetMozillaFromSQLite\" ascii fullword\n`})})]})}function v(i={}){let{wrapper:e}=i.components||{};return e?(0,t.jsx)(e,Object.assign({},i,{children:(0,t.jsx)(d,i)})):d(i)}var k=v;return y(A);})();\n;return Component;"},"_id":"articles/attack-chain-leads-to-xworm-and-agenttesla.mdx","_raw":{"sourceFilePath":"articles/attack-chain-leads-to-xworm-and-agenttesla.mdx","sourceFileName":"attack-chain-leads-to-xworm-and-agenttesla.mdx","sourceFileDir":"articles","contentType":"mdx","flattenedPath":"articles/attack-chain-leads-to-xworm-and-agenttesla"},"type":"Article","imageUrl":"/assets/images/attack-chain-leads-to-xworm-and-agenttesla/blog-thumb-coin-stacks.jpg","readingTime":"10 min read","series":"","url":"/attack-chain-leads-to-xworm-and-agenttesla","headings":[{"level":2,"title":"Key Takeaways","href":"#key-takeaways"},{"level":2,"title":"Preamble","href":"#preamble"},{"level":2,"title":"RTF loader code analysis","href":"#rtf-loader-code-analysis"},{"level":3,"title":"Overview","href":"#overview"},{"level":3,"title":"Extracting the malicious VBA","href":"#extracting-the-malicious-vba"},{"level":3,"title":"Powershell script analysis","href":"#powershell-script-analysis"},{"level":3,"title":"Deleting the malicious document","href":"#deleting-the-malicious-document"},{"level":3,"title":"Persistence","href":"#persistence"},{"level":3,"title":"AMSI bypass","href":"#amsi-bypass"},{"level":3,"title":"User creation","href":"#user-creation"},{"level":3,"title":"Malware update persistence","href":"#malware-update-persistence"},{"level":3,"title":".NET loader","href":"#net-loader"},{"level":3,"title":"Final payload","href":"#final-payload"},{"level":2,"title":"Observed adversary tactics and techniques","href":"#observed-adversary-tactics-and-techniques"},{"level":2,"title":"Tactics","href":"#tactics"},{"level":2,"title":"Techniques/subtechniques","href":"#techniquessubtechniques"},{"level":2,"title":"Detection logic","href":"#detection-logic"},{"level":3,"title":"YARA","href":"#yara"}],"author":[{"title":"Salim Bitam","slug":"salim-bitam","description":"Elastic","body":{"raw":"","code":"var Component=(()=\u003e{var l=Object.create;var i=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,d=Object.prototype.hasOwnProperty;var g=(t,n)=\u003e()=\u003e(n||t((n={exports:{}}).exports,n),n.exports),j=(t,n)=\u003e{for(var e in n)i(t,e,{get:n[e],enumerable:!0})},s=(t,n,e,o)=\u003e{if(n\u0026\u0026typeof n==\"object\"||typeof n==\"function\")for(let a of f(n))!d.call(t,a)\u0026\u0026a!==e\u0026\u0026i(t,a,{get:()=\u003en[a],enumerable:!(o=x(n,a))||o.enumerable});return t};var p=(t,n,e)=\u003e(e=t!=null?l(_(t)):{},s(n||!t||!t.__esModule?i(e,\"default\",{value:t,enumerable:!0}):e,t)),M=t=\u003es(i({},\"__esModule\",{value:!0}),t);var c=g((h,m)=\u003e{m.exports=_jsx_runtime});var F={};j(F,{default:()=\u003eD,frontmatter:()=\u003eb});var r=p(c()),b={title:\"Salim Bitam\",description:\"Elastic\",slug:\"salim-bitam\"};function u(t){return(0,r.jsx)(r.Fragment,{})}function C(t={}){let{wrapper:n}=t.components||{};return n?(0,r.jsx)(n,Object.assign({},t,{children:(0,r.jsx)(u,t)})):u(t)}var D=C;return M(F);})();\n;return Component;"},"_id":"authors/salim-bitam.mdx","_raw":{"sourceFilePath":"authors/salim-bitam.mdx","sourceFileName":"salim-bitam.mdx","sourceFileDir":"authors","contentType":"mdx","flattenedPath":"authors/salim-bitam"},"type":"Author","imageUrl":"","url":"/authors/salim-bitam"}],"category":[{"title":"Attack pattern","slug":"attack-pattern","body":{"raw":"","code":"var Component=(()=\u003e{var x=Object.create;var o=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,g=Object.prototype.hasOwnProperty;var j=(t,n)=\u003e()=\u003e(n||t((n={exports:{}}).exports,n),n.exports),l=(t,n)=\u003e{for(var e in n)o(t,e,{get:n[e],enumerable:!0})},s=(t,n,e,c)=\u003e{if(n\u0026\u0026typeof n==\"object\"||typeof n==\"function\")for(let a of p(n))!g.call(t,a)\u0026\u0026a!==e\u0026\u0026o(t,a,{get:()=\u003en[a],enumerable:!(c=f(n,a))||c.enumerable});return t};var d=(t,n,e)=\u003e(e=t!=null?x(_(t)):{},s(n||!t||!t.__esModule?o(e,\"default\",{value:t,enumerable:!0}):e,t)),M=t=\u003es(o({},\"__esModule\",{value:!0}),t);var i=j((b,u)=\u003e{u.exports=_jsx_runtime});var F={};l(F,{default:()=\u003eD,frontmatter:()=\u003ek});var r=d(i()),k={title:\"Attack pattern\",slug:\"attack-pattern\"};function m(t){return(0,r.jsx)(r.Fragment,{})}function C(t={}){let{wrapper:n}=t.components||{};return n?(0,r.jsx)(n,Object.assign({},t,{children:(0,r.jsx)(m,t)})):m(t)}var D=C;return M(F);})();\n;return Component;"},"_id":"categories/attack-pattern.mdx","_raw":{"sourceFilePath":"categories/attack-pattern.mdx","sourceFileName":"attack-pattern.mdx","sourceFileDir":"categories","contentType":"mdx","flattenedPath":"categories/attack-pattern"},"type":"Category","url":"/categories/attack-pattern"},{"title":"Malware analysis","slug":"malware-analysis","body":{"raw":"","code":"var Component=(()=\u003e{var u=Object.create;var s=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,g=Object.prototype.hasOwnProperty;var j=(t,n)=\u003e()=\u003e(n||t((n={exports:{}}).exports,n),n.exports),M=(t,n)=\u003e{for(var e in n)s(t,e,{get:n[e],enumerable:!0})},i=(t,n,e,o)=\u003e{if(n\u0026\u0026typeof n==\"object\"||typeof n==\"function\")for(let r of f(n))!g.call(t,r)\u0026\u0026r!==e\u0026\u0026s(t,r,{get:()=\u003en[r],enumerable:!(o=x(n,r))||o.enumerable});return t};var d=(t,n,e)=\u003e(e=t!=null?u(_(t)):{},i(n||!t||!t.__esModule?s(e,\"default\",{value:t,enumerable:!0}):e,t)),p=t=\u003ei(s({},\"__esModule\",{value:!0}),t);var l=j((X,c)=\u003e{c.exports=_jsx_runtime});var D={};M(D,{default:()=\u003eC,frontmatter:()=\u003ew});var a=d(l()),w={title:\"Malware analysis\",slug:\"malware-analysis\"};function m(t){return(0,a.jsx)(a.Fragment,{})}function y(t={}){let{wrapper:n}=t.components||{};return n?(0,a.jsx)(n,Object.assign({},t,{children:(0,a.jsx)(m,t)})):m(t)}var C=y;return p(D);})();\n;return Component;"},"_id":"categories/malware-analysis.mdx","_raw":{"sourceFilePath":"categories/malware-analysis.mdx","sourceFileName":"malware-analysis.mdx","sourceFileDir":"categories","contentType":"mdx","flattenedPath":"categories/malware-analysis"},"type":"Category","url":"/categories/malware-analysis"}]},"seriesArticles":null},"__N_SSG":true},"page":"/[slug]","query":{"slug":"attack-chain-leads-to-xworm-and-agenttesla"},"buildId":"LbZ9DZ1J4YuByupgUw5Qo","assetPrefix":"/security-labs","isFallback":false,"gsp":true,"scriptLoader":[{"id":"google-tag-manager","strategy":"afterInteractive","dangerouslySetInnerHTML":{"__html":"\n          (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':\n          new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],\n          j=d.createElement(s),dl=l!='dataLayer'?'\u0026l='+l:'';j.async=true;j.src=\n          'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);\n          })(window,document,'script','dataLayer','GTM-KNJMG2M');\n          "}}]}</script></body></html>