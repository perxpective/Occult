<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>QBOT Malware Analysis — Elastic Security Labs</title><meta name="description" content="Elastic Security Labs releases a QBOT malware analysis report covering the execution chain. From this research, the team has produced a YARA rule, configuration-extractor, and indicators of compromises (IOCs)."/><meta property="og:title" content="QBOT Malware Analysis — Elastic Security Labs"/><meta property="og:description" content="Elastic Security Labs releases a QBOT malware analysis report covering the execution chain. From this research, the team has produced a YARA rule, configuration-extractor, and indicators of compromises (IOCs)."/><meta property="og:image" content="https://www.elastic.co/security-labs/assets/images/qbot-malware-analysis/blog-thumb-drill-bit.jpg?787ccfad40d9339df687eb41c247aa34"/><meta property="og:image:alt" content="Elastic Security Labs releases a QBOT malware analysis report covering the execution chain. From this research, the team has produced a YARA rule, configuration-extractor, and indicators of compromises (IOCs)."/><meta property="og:site_name"/><meta property="og:url" content="https://www.elastic.co/security-labs"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="QBOT Malware Analysis — Elastic Security Labs"/><meta name="twitter:description" content="Elastic Security Labs releases a QBOT malware analysis report covering the execution chain. From this research, the team has produced a YARA rule, configuration-extractor, and indicators of compromises (IOCs)."/><meta name="twitter:image" content="https://www.elastic.co/security-labs/assets/images/qbot-malware-analysis/blog-thumb-drill-bit.jpg?787ccfad40d9339df687eb41c247aa34"/><meta name="twitter:image:alt" content="Elastic Security Labs releases a QBOT malware analysis report covering the execution chain. From this research, the team has produced a YARA rule, configuration-extractor, and indicators of compromises (IOCs)."/><link rel="preload" href="/security-labs/logo.svg" as="image" fetchpriority="high"/><link rel="preload" as="image" imageSrcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=640&amp;q=75 640w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=750&amp;q=75 750w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=828&amp;q=75 828w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=1080&amp;q=75 1080w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=1200&amp;q=75 1200w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=1920&amp;q=75 1920w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=2048&amp;q=75 2048w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=3840&amp;q=75 3840w" imageSizes="100vw" fetchpriority="high"/><meta name="next-head-count" content="18"/><script src="https://play.vidyard.com/embed/v4.js" type="text/javascript" async=""></script><link rel="icon" href="/security-labs/favicon.svg"/><link rel="mask-icon" href="/security-labs/favicon.svg" color="#1C1E23"/><link rel="apple-touch-icon" href="/security-labs/favicon.svg"/><meta name="theme-color" content="#1C1E23"/><link rel="preload" href="/security-labs/_next/static/media/d6b16ce4a6175f26-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/369c6e283c5acc6e-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/92f44bb82993d879-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/ee71530a747ff30b-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/9fac010bc1f02be0-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/cbf5fbad4d73afac-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/css/73b298dbda1d9875.css" as="style"/><link rel="stylesheet" href="/security-labs/_next/static/css/73b298dbda1d9875.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/security-labs/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/security-labs/_next/static/chunks/webpack-7987c6fda769d510.js" defer=""></script><script src="/security-labs/_next/static/chunks/framework-7a7e500878b44665.js" defer=""></script><script src="/security-labs/_next/static/chunks/main-f3a0ceda7ea49cbc.js" defer=""></script><script src="/security-labs/_next/static/chunks/pages/_app-2ec74491d5ced2ab.js" defer=""></script><script src="/security-labs/_next/static/chunks/fec483df-43ee602fabdfe3a4.js" defer=""></script><script src="/security-labs/_next/static/chunks/456-3e57b712955777f8.js" defer=""></script><script src="/security-labs/_next/static/chunks/63-f16c4b34a05eccc7.js" defer=""></script><script src="/security-labs/_next/static/chunks/402-c32fd975f91b0692.js" defer=""></script><script src="/security-labs/_next/static/chunks/313-8601898b29843738.js" defer=""></script><script src="/security-labs/_next/static/chunks/pages/%5Bslug%5D-0154f8439a66bef9.js" defer=""></script><script src="/security-labs/_next/static/LbZ9DZ1J4YuByupgUw5Qo/_buildManifest.js" defer=""></script><script src="/security-labs/_next/static/LbZ9DZ1J4YuByupgUw5Qo/_ssgManifest.js" defer=""></script></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__next"><main class="__variable_0351a5 __variable_96e9ea __variable_f5ba7a flex flex-col min-h-screen"><div class="scroll-percentage-container"><div class="scroll-percentage-bar" style="width:0%"></div></div><nav class="fixed w-full z-40" data-headlessui-state=""><div class="bg-gradient-to-b from-zinc-900 from-20% h-[200%] to-transparent absolute inset-0 z-0 pointer-events-none"></div><div class="container relative z-10"><div class="flex h-16 items-center justify-between"><div class="flex items-center justify-start w-full"><div><a class="hover:opacity-50 transition" href="/security-labs"><img alt="elastic security labs logo" fetchpriority="high" width="200" height="30" decoding="async" data-nimg="1" style="color:transparent" src="/security-labs/logo.svg"/></a></div><div class="hidden lg:ml-6 lg:block"><div class="flex space-x-4"><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/about"><span>About</span></a><div class="relative" data-headlessui-state=""><div><button class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" id="headlessui-menu-button-:R2kpm:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state="">Topics<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="ml-1 -mr-1 h-4 w-4 text-zinc-400 relative top-[1px]"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div></div><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/category/vulnerability-updates"><span>Vulnerability updates</span></a><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/category/reports"><span>Reports</span></a><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/category/tools"><span>Tools</span></a></div></div><div class="hidden lg:ml-auto lg:block"><div class="flex space-x-4"><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="https://www.elastic.co/security-labs/rss/feed.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="h-4 w-4 mr-1"><path d="M3.75 3a.75.75 0 00-.75.75v.5c0 .414.336.75.75.75H4c6.075 0 11 4.925 11 11v.25c0 .414.336.75.75.75h.5a.75.75 0 00.75-.75V16C17 8.82 11.18 3 4 3h-.25z"></path><path d="M3 8.75A.75.75 0 013.75 8H4a8 8 0 018 8v.25a.75.75 0 01-.75.75h-.5a.75.75 0 01-.75-.75V16a6 6 0 00-6-6h-.25A.75.75 0 013 9.25v-.5zM7 15a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Subscribe</span></a></div></div></div><div class="-mr-2 flex lg:hidden"><button class="inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" id="headlessui-disclosure-button-:R19m:" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open navigation menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="block h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div></div></div></nav><main class="mb-20 flex-1 flex flex-col"><div class="h-48 md:h-64"><div class="after:absolute after:block after:bg-blue-400 after:blur-3xl after:content-[&#x27; &#x27;] after:h-96 after:opacity-5 after:right-0 after:rounded-full after:top-20 after:w-1/2 after:z-0 before:absolute before:block before:blur-3xl before:bg-orange-400 before:content-[&#x27; &#x27;] before:h-96 before:left-0 before:opacity-5 before:rounded-full before:w-1/2 before:z-0 w-full h-full relative"><div class="relative z-10 w-full h-[125%] -top-[25%] bg-no-repeat bg-cover bg-bottom flex items-center justify-center" style="background-image:url(/security-labs/grid.svg)"></div></div></div><article class="px-4"><div class="max-w-5xl mx-auto relative z-10 flex flex-col space-y-4"><div class="eyebrow break-words"><time class="block mb-2 md:mb-0 md:inline-block article-published-date" dateTime="2023-02-14T00:00:00.000Z">14 February 2023</time><span class="hidden md:inline-block md:mx-2">•</span><a class="hover:text-blue-400 text-xs md:text-sm whitespace-nowrap author-name" href="/security-labs/author/cyril-francois">Cyril François</a></div><h1 class="font-bold leading-tighter text-3xl md:text-5xl"><span>QBOT Malware&nbsp;Analysis</span></h1><p class="text-zinc-200 text-base md:text-xl">Elastic Security Labs releases a QBOT malware analysis report covering the execution chain. From this research, the team has produced a YARA rule, configuration-extractor, and indicators of compromises (IOCs).</p><div class="flex items-center mt-4 text-zinc-200 text-sm space-x-4 border-t border-white/25 pt-4"><span class="flex items-center space-x-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-4 w-4 text-zinc-400"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>44 min read</span></span><span class="flex items-center space-x-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-4 w-4 text-zinc-400"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z"></path></svg><span><a class="hover:text-blue-400 whitespace-nowrap" href="/security-labs/category/malware-analysis">Malware analysis</a></span></span></div></div><div class="max-w-6xl mx-auto"><div class="bg-zinc-900 border border-zinc-800 drop-shadow-lg p-5 sm:p-8 md:p-10 rounded-3xl mt-5 md:mt-10"><div class="relative w-full rounded-lg overflow-hidden aspect-video"><img alt="QBOT Malware Analysis" fetchpriority="high" decoding="async" data-nimg="fill" class="object-cover absolute h-full w-full" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;color:transparent" sizes="100vw" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=640&amp;q=75 640w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=750&amp;q=75 750w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=828&amp;q=75 828w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=1080&amp;q=75 1080w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=1200&amp;q=75 1200w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=1920&amp;q=75 1920w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=2048&amp;q=75 2048w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=3840&amp;q=75 3840w" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2Fblog-thumb-drill-bit.jpg&amp;w=3840&amp;q=75"/><div class="absolute border border-white/50 inset-0 mix-blend-overlay rounded-lg z-10"></div></div></div></div><div class="lg:max-w-5xl mx-auto relative mt-12 lg:grid lg:grid-cols-4 lg:gap-8 items-start"><div class="flex justify-center mx-auto lg:col-span-3"><div class="prose prose-invert w-full article-content"><div><h2 class="font-bold text-xl md:text-3xl relative"><span id="key-takeaways" class="absolute -top-32"></span>Key takeaways</h2>
<ul>
<li>Elastic Security Labs is releasing a QBOT malware analysis report from a recent <a href="https://www.elastic.co/security-labs/exploring-the-qbot-attack-pattern">campaign</a></li>
<li>This report covers the execution chain from initial infection to communication with its command and control containing details about in depth features such as its injection mechanism and dynamic persistence mechanism.</li>
<li>From this research we produced a <a href="https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_Qbot.yar">YARA rule</a>, <a href="https://www.elastic.co/security-labs/qbot-configuration-extractor">configuration-extractor</a>, and indicators of compromises (IOCs)</li>
</ul>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="preamble" class="absolute -top-32"></span>Preamble</h2>
<p>As part of our mission to build knowledge about the most common malware families targeting institutions and individuals, the Elastic Malware and Reverse Engineering team (MARE) completed the analysis of the core component of the banking trojan QBOT/QAKBOT V4 from a previously reported <a href="https://www.elastic.co/security-labs/exploring-the-qbot-attack-pattern">campaign</a>.</p>
<p>QBOT — also known as QAKBOT — is a modular Trojan active since 2007 used to download and run binaries on a target machine. This document describes the in-depth reverse engineering of the QBOT V4 core components. It covers the execution flow of the binary from launch to communication with its command and control (C2).</p>
<p>QBOT is a multistage, multiprocess binary that has capabilities for evading detection, escalating privileges, configuring persistence, and communicating with C2 through a set of IP addresses. The C2 can update QBOT, upload new IP addresses, upload and run fileless binaries, and execute shell commands.</p>
<p>As a result of this analysis, MARE has produced a new yara rule based on the core component of QBOT as well as a static configuration extractor able to extract and decrypt its strings, its configuration, and its C2 IP address list.</p>
<blockquote>
<p>For information on the QBOT configuration extractor and malware analysis, check out our blog posts detailing this:</p>
<ul>
<li><a href="https://www.elastic.co/security-labs/qbot-configuration-extractor">QBOT Configuration Extractor</a></li>
<li><a href="https://www.elastic.co/security-labs/exploring-the-qbot-attack-pattern">QBOT Attack Pattern</a></li>
</ul>
</blockquote>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="execution-flow" class="absolute -top-32"></span>Execution flow</h2>
<p>This section describes the QBOT execution flow in the following three stages:</p>
<ul>
<li>First Stage: Initialization</li>
<li>Second Stage: Installation</li>
<li>Third Stage: Communication</li>
</ul>
<h3 class="font-bold leading-tight text-xl relative"><span id="stage-1" class="absolute -top-32"></span>Stage 1</h3>
<p><img alt="First stage execution flow" loading="lazy" width="715" height="495" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F1qbot.png&amp;w=750&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F1qbot.png&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F1qbot.png&amp;w=1920&amp;q=90"/></p>
<p>The sample is executed with the <strong>regsvr32.exe</strong> binary, which in turn will call QBOT’s <strong>DllRegisterServer</strong> export:</p>
<p><img alt="regsvr32.exe loading QBOT and calling its DllRegisterServer export." loading="lazy" width="861" height="418" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F2qbot.png&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F2qbot.png&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F2qbot.png&amp;w=1920&amp;q=90"/></p>
<p>After execution, QBOT checks if it’s running under the Windows Defender sandbox by checking the existence of a specific subdirectory titled: <strong>C:\INTERNAL\__empty</strong> , if this folder exists, the malware terminates itself:</p>
<p><img alt="QBOT checking if it is running and Windows Defender sandbox." loading="lazy" width="789" height="38" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F3qbot.jpg&amp;w=828&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F3qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F3qbot.jpg&amp;w=1920&amp;q=90"/></p>
<p>The malware will then enumerate running processes to detect any antivirus (AV) products on the machine. The image below contains a list of AV vendors QBOT reacts to:</p>
<p><img alt="Enum of vendors QBOT can detect." loading="lazy" width="320" height="274" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F4qbot.jpg&amp;w=384&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F4qbot.jpg&amp;w=640&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F4qbot.jpg&amp;w=640&amp;q=90"/></p>
<p>AV detection will not prevent QBOT from running. However, it will change its behavior in later stages. In order to generate a seed for its pseudorandom number generator (PRNG), QBOT generates a fingerprint of the computer by using the following expression:</p>
<pre><code>**fingerprint = CRC32(computerName + CVolumeSerialNumber + AccountName)**
</code></pre>
<p>If the <strong>“C:”</strong> volume doesn’t exist the expression below is used instead:</p>
<pre><code>**fingerprint = CRC32(computerName + AccountName)**
</code></pre>
<p>Finally, QBOT will choose a set of targets to inject into depending on the AVs previously detected and the machine architecture:</p>
<p>|                            |                                                                                                               |
| -------------------------- | ------------------------------------------------------------------------------------------------------------- | ---------------------- | ----------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------ |
| AV detected &amp; architecture | Targets                                                                                                       |
| BitDefender                | Kaspersky                                                                                                     | Sophos                 | TrendMicro                                                                                                                    | &amp; x86                                                                                                        | %SystemRoot%\SysWOW64\mobsync.exe %SystemRoot%\SysWOW64\explorer.exe |
| BitDefender                | Kaspersky                                                                                                     | Sophos                 | TrendMicro &amp; x64                                                                                                              | %SystemRoot%\System32\mobsync.exe%SystemRoot%\explorer.exe%ProgramFiles%\Internet Explorer\iexplore.exe |
| Avast                      | AVG                                                                                                           | Windows Defender &amp; x86 | %SystemRoot%\SysWOW64\OneDriveSetup.exe%SystemRoot%\SysWOW64\msra.exe%ProgramFiles(x86)%\Internet Explorer\iexplore.exe |
| Avast                      | AVG                                                                                                           | Windows Defender &amp; x64 | %SystemRoot%\System32\OneDriveSetup.exe%SystemRoot%\System32\msra.exe                                                     |
| x86                        | &#x27;%SystemRoot%\explorer.exe%SystemRoot%\System32\msra.exe%SystemRoot%\System32\OneDriveSetup.exe          |
| x64                        | %SystemRoot%\SysWOW64\explorer.exe%SystemRoot%\SysWOW64\msra.exe%SystemRoot%\System32\OneDriveSetup.exe |</p>
<p>QBOT will try to inject itself iteratively, using its second stage as an entry point, into one of its targets– choosing the next target process if the injection fails. Below is an example of QBOT injecting into <strong>explorer.exe</strong>.</p>
<p><img alt="QBOT injecting itself into explorer.exe" loading="lazy" width="1032" height="591" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F7qbot.png&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F7qbot.png&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F7qbot.png&amp;w=3840&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="stage-2" class="absolute -top-32"></span>Stage 2</h3>
<p><img alt="Second stage execution flow" loading="lazy" width="725" height="565" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F8qbot.png&amp;w=750&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F8qbot.png&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F8qbot.png&amp;w=1920&amp;q=90"/></p>
<p>QBOT begins its second stage by saving the content of its binary in memory and then corrupting the file on disk:</p>
<p><img alt="QBOT corrupting its binary file" loading="lazy" width="872" height="438" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F0.jpg&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F0.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F0.jpg&amp;w=1920&amp;q=90"/></p>
<p>The malware then loads its configuration from one of its resource sections:</p>
<p><img alt="QBOT loading its configuration from resource" loading="lazy" width="912" height="264" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F10qbot.jpg&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F10qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F10qbot.jpg&amp;w=1920&amp;q=90"/></p>
<p>QBOT also has the capability to load its configuration from a <strong>.cfg</strong> file if available in the process root directory:</p>
<p><img alt="QBOT trying to load its configuration from a file" loading="lazy" width="1426" height="175" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F1.jpg&amp;w=1920&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F1.jpg&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F1.jpg&amp;w=3840&amp;q=90"/></p>
<p>After loading its configuration, QBOT proceeds to install itself on the machine– initially by writing its internal configuration to the registry:</p>
<p><img alt="QBOT writing its configuration to the registry" loading="lazy" width="1440" height="266" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F2.jpg&amp;w=1920&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F2.jpg&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F2.jpg&amp;w=3840&amp;q=90"/></p>
<p>Shortly after, QBOT creates a persistence subdirectory with a randomly-generated name under the <strong>%APPDATA%\Microsoft</strong> directory. This folder is used to drop the in-memory QBOT binary for persistence across reboot:</p>
<p><img alt="QBOT creating its persistence folder" loading="lazy" width="1329" height="197" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F3.jpg&amp;w=1920&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F3.jpg&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F3.jpg&amp;w=3840&amp;q=90"/></p>
<p>At this point, the folder will be empty because the malware will only drop the binary if a shutdown/reboot event is detected. This “contingency” binary will be deleted after reboot.</p>
<p>QBOT will attempt the same install process for all users and try to either execute the malware within the user session if it exists, or create a value under the <strong>CurrentVersion\Run</strong> registry key for the targeted user to launch the malware at the next login. Our analysis didn’t manage to reproduce this behavior on an updated Windows 10 machine. The only artifact observed is the randomly generated persistence folder created under the user <strong>%APPDATA%\Microsoft</strong> directory:</p>
<p><img alt="Persistence folder is empty when QBOT is running" loading="lazy" width="320" height="274" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F4qbot.jpg&amp;w=384&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F4qbot.jpg&amp;w=640&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F4qbot.jpg&amp;w=640&amp;q=90"/></p>
<p>QBOT finishes its second stage by restoring the content of its corrupted binary and registering a task via <strong>Schtask</strong> to launch a QBOT service under the <strong>NT AUTHORITY\SYSTEM</strong> account.</p>
<p>The first stage has a special execution path where it registers a service handler if the process is running under the <strong>SYSTEM</strong> account. The QBOT service then executes stages 2 and 3 as normal, corrupting the binary yet again and executing commands on behalf of other QBOT processes via messages received through a randomly generated named pipe:</p>
<p><img alt="QBOT running as SYSTEM service" loading="lazy" width="1121" height="711" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F15qbot.png&amp;w=1200&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F15qbot.png&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F15qbot.png&amp;w=3840&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="stage-3" class="absolute -top-32"></span>Stage 3</h3>
<p><img alt="Third stage execution flow" loading="lazy" width="1295" height="735" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F16qbot.png&amp;w=1920&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F16qbot.png&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F16qbot.png&amp;w=3840&amp;q=90"/></p>
<p>QBOT begins its third stage by registering a window and console event handler to monitor suspend/resume and shutdown/reboot events. Monitoring these events enables the malware to install persistence dynamically by dropping a copy of the QBOT binary in the persistence folder and creating a value under the <strong>CurrentVersion\Run</strong> registry key:</p>
<p><img alt="QBOT install persistence when suspend/resume or shutdown/reboot event occurs" loading="lazy" width="1032" height="591" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F7qbot.png&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F7qbot.png&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F7qbot.png&amp;w=3840&amp;q=90"/></p>
<p>At reboot, QBOT will take care of deleting any persistence artifacts.</p>
<p>The malware will proceed to creating a watchdog thread to monitor running processes against a hardcoded list of binaries every second. If any process matches, a registry value is set that will then change QBOT behavior to use randomly generated IP addresses instead of the real one, thus never reaching its command and control:</p>
<div class="table-container"><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>frida-winjector-helper-32.exefrida-winjector-helper-64.exeTcpdump.exewindump.exeethereal.exewireshark.exeettercap.exertsniff.exepacketcapture.execapturenet.exeqak_proxy</td><td>dumpcap.exeCFF Explorer.exenot_rundll32.exeProcessHacker.exetcpview.exefilemon.exeprocmon.exeidaq64.exePETools.exeImportREC.exeLordPE.exe</td><td>SysInspector.exeproc_analyzer.exesysAnalyzer.exesniff_hit.exejoeboxcontrol.exejoeboxserver.exeResourceHacker.exex64dbg.exeFiddler.exesniff_hit.exesysAnalyzer.exe</td></tr></tbody></table></div>
<p>QBOT will then load its domains from one of its <strong>.rsrc</strong> files and from the registry as every domain update received from its C2 will be part of its configuration written to the registry. See Extracted Network Infrastructure in Appendix A.</p>
<p>Finally, the malware starts communicating with C2 via HTTP and TLS. The underlying protocol uses a JSON object encapsulated within an enciphered message which is then base64-encoded:</p>
<p><img alt="QBOT message format" loading="lazy" width="725" height="565" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F8qbot.png&amp;w=750&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F8qbot.png&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F8qbot.png&amp;w=1920&amp;q=90"/></p>
<p>Below an example of a HTTP POST request sent by QBOT to its C2:</p>
<pre><code>Accept: application/x-shockwave-flash, image/gif, image/jpeg, image/pjpeg, */*
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko
Host: 181.118.183.98
Content-Length: 77
Cache-Control: no-cache

qxlbjrbj=NnySaFAKLt+YgjH3UET8U6AUwT9Lg51z6zC+ufeAjt4amZAXkIyDup74MImUA4do4Q==
</code></pre>
<p>Through this communication channel, QBOT receives commands from C2 — see Appendix B (Command Handlers). Aside from management commands (update, configuration knobs), our sample only handles binary execution-related commands, but we know that the malware is modular and can be built with additional features like a VNC server, a reverse shell server, proxy support (to be part of the domains list), and numerous other capabilities are feasible.</p>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="features" class="absolute -top-32"></span>Features</h2>
<h3 class="font-bold leading-tight text-xl relative"><span id="mersenne-twister-random-number-generator" class="absolute -top-32"></span>Mersenne Twister Random Number Generator</h3>
<p>QBOT uses an implementation of <a href="https://www.sciencedirect.com/topics/computer-science/mersenne-twister">Mersenne Twister Random Number Generator</a> (MTRNG) to generate random values:</p>
<p><img alt="QBOT&#x27;s Mersenne Twister Random Number Generator implementation" loading="lazy" width="729" height="256" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F19qbot.jpg&amp;w=750&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F19qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F19qbot.jpg&amp;w=1920&amp;q=90"/></p>
<p>The MTRNG engine is then used by various functions to generate different types of data, for example for generating registry key values and persistence folders. As QBOT needs to reproduce values, it will almost always use the computer fingerprint and a “salt” specific to the value it wants to generate:</p>
<p><img alt="QBOT generating random event name with fixed seed and salt" loading="lazy" width="625" height="51" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F20qbot.jpg&amp;w=640&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F20qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F20qbot.jpg&amp;w=1920&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="string-obfuscation" class="absolute -top-32"></span>String obfuscation</h3>
<p>All QBOT strings are XOR-encrypted and concatenated in a single blob we call a “string bank”. To get a specific string the malware needs a string identifier (identifier being an offset in the string bank), a decryption key, and the targeted string bank.</p>
<p><img alt="GetStringAux function prototype." loading="lazy" width="715" height="495" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F1qbot.png&amp;w=750&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F1qbot.png&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F1qbot.png&amp;w=1920&amp;q=90"/></p>
<p>As this sample has two string banks, it has four <strong>GetString</strong>&#x27; functions currying the string bank and the decryption key parameters: One C string function and one wide string function for each string bank. Wide string functions use the same string banks, but convert the data to <strong>utf-16</strong>.</p>
<p><img alt="QBOT calling GetString function" loading="lazy" width="861" height="418" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F2qbot.png&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F2qbot.png&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F2qbot.png&amp;w=1920&amp;q=90"/></p>
<p><img alt="GetString function currying GetStringAux with string bank and key parameters" loading="lazy" width="789" height="38" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F3qbot.jpg&amp;w=828&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F3qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F3qbot.jpg&amp;w=1920&amp;q=90"/></p>
<p>See Appendix C (String Deciphering Implementation).</p>
<h3 class="font-bold leading-tight text-xl relative"><span id="import-obfuscation" class="absolute -top-32"></span>Import obfuscation</h3>
<p>QBOT resolves its imports using a hash table:</p>
<p><img alt="QBOT calling GetApi function" loading="lazy" width="320" height="274" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F4qbot.jpg&amp;w=384&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F4qbot.jpg&amp;w=640&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F4qbot.jpg&amp;w=640&amp;q=90"/></p>
<p><img alt="GetApi function prototype" loading="lazy" width="632" height="20" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F25qbot.jpg&amp;w=640&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F25qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F25qbot.jpg&amp;w=1920&amp;q=90"/></p>
<p>The malware resolves the library name through its GetString function and then resolves the hash table with a classic library’s exports via manual parsing, comparing each export to the expected hash. In this sample, the hashing comparison algorithm use this formula:</p>
<pre><code>**CRC32(exportName) XOR 0x218fe95b == hash**
</code></pre>
<h3 class="font-bold leading-tight text-xl relative"><span id="resource-obfuscation" class="absolute -top-32"></span>Resource obfuscation</h3>
<p>The malware is embedded with different resources, the common ones are the configuration and the domains list. Resources are encrypted the same way: The decryption key may be either embedded within the data blob or provided. Once the resource is decrypted, an embedded hash is used to check data validity.</p>
<p><img alt="QBOT decrypting its resource with embedded or provided key" loading="lazy" width="815" height="275" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F26qbot.jpg&amp;w=828&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F26qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F26qbot.jpg&amp;w=1920&amp;q=90"/></p>
<p>See Appendix D (Resource Deciphering Implementation).</p>
<h3 class="font-bold leading-tight text-xl relative"><span id="cyrillic-keyboard-language-detection" class="absolute -top-32"></span>Cyrillic keyboard language detection</h3>
<p>At different stages, QBOT will check if the computer uses a Cyrillic language keyboard. If it does, it prevents further execution.</p>
<p><img alt="Set of languages QBOT is looking to stop its execution" loading="lazy" width="1032" height="591" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F7qbot.png&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F7qbot.png&amp;w=3840&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F7qbot.png&amp;w=3840&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="avgavast-special-behavior" class="absolute -top-32"></span>AVG/AVAST special behavior</h3>
<p>AVG and Avast share the same antivirus engine. Thus if QBOT detects one of those antivirus running, it will also check at the installation stage if one of their DLLs is loaded within the malware memory space. If so, QBOT will skip the installation phase.</p>
<p><img alt="QBOT checking if AVG/AVAST has hooked its process" loading="lazy" width="725" height="565" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F8qbot.png&amp;w=750&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F8qbot.png&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F8qbot.png&amp;w=1920&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="windows-defender-special-behavior" class="absolute -top-32"></span>Windows Defender special behavior</h3>
<p>If QBOT is running under <strong>SYSTEM</strong> account, it will add its persistence folder to the Windows Defender exclusion path in the registry. It will also do this for the legacy Microsoft Security Essential (MSE) exclusion path if detected.</p>
<p><img alt="QBOT adding its persistence folder to Windows Defender and MSE exclusion paths" loading="lazy" width="583" height="190" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F29qbot.jpg&amp;w=640&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F29qbot.jpg&amp;w=1200&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F29qbot.jpg&amp;w=1200&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="exception-list-process-watchdog" class="absolute -top-32"></span>Exception list process watchdog</h3>
<p>Each second, QBOT parses running processes looking for one matching the hardcoded exception list. If any is found, a “fuse” value is set in the registry and the watchdog stops. If this fuse value is set, QBOT will not stop execution– but at the third stage, the malware will use randomly generated IP and won&#x27;t be able to contact C2.</p>
<p><img alt="Watchdog thread setting fuse if any Exceptionlisted process is detected" loading="lazy" width="936" height="166" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F30qbot.jpg&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F30qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F30qbot.jpg&amp;w=1920&amp;q=90"/></p>
<p>![QBOT using randomly generated IP address if fuse is set]/assets/images/qbot-malware-analysis/1qbot.png)</p>
<h3 class="font-bold leading-tight text-xl relative"><span id="qbot-process-injection" class="absolute -top-32"></span>QBOT process injection</h3>
<h4 class="font-bold leading-tight text-lg relative"><span id="second-stage-injection" class="absolute -top-32"></span>Second stage injection</h4>
<p>To inject its second stage into one of a hardcoded target, QBOT uses a classic <strong>CreateProcess</strong> , <strong>WriteProcessMemory</strong> , <strong>ResumeProcess</strong> DLL injection technique. The malware will create a process, allocate and write the QBOT binary within the process memory, write a copy of its engine, and patch the entry point to jump to a special function. This function performs a light initialization of QBOT and its engine within the new process environment, alerts the main process of its success, and then execute the second stage.</p>
<p>![QBOT second stage injection]/assets/images/qbot-malware-analysis/2qbot.png)</p>
<p>![QBOT injection entry point]/assets/images/qbot-malware-analysis/3qbot.jpg)</p>
<h4 class="font-bold leading-tight text-lg relative"><span id="injecting-library-from-command-and-control" class="absolute -top-32"></span>Injecting library from command and control</h4>
<p>QBOT uses the aforementioned method to inject libraries received from C2. The difference is that as well as mapping itself, the malware will also map the received binary and use a library loader as entry point.</p>
<p>![QBOT DLL loader injection]/assets/images/qbot-malware-analysis/4qbot.jpg)</p>
<p><img alt="QBOT Dll loader entrypoint" loading="lazy" width="662" height="183" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F35qbot.jpg&amp;w=750&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F35qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F35qbot.jpg&amp;w=1920&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="multi-user-installation" class="absolute -top-32"></span>Multi-user installation</h3>
<p>Part of the QBOT installation process is installing itself within others users’ accounts. To do so, the malware enumerates each user with an account on the machine (local and domain), then dumps its configuration under the user’s <strong>Software\Microsoft</strong> registry key, creates a persistence folder under the users’ <strong>%APPDATA%\Microsoft</strong> folder, and finally tries to either launch QBOT under the user session if the session exist, or else creates a run key to launch the malware when the user will log in.</p>
<p><img alt="QBOT installation &amp; run for one user" loading="lazy" width="871" height="327" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F36qbot.jpg&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F36qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F36qbot.jpg&amp;w=1920&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="dynamic-persistence" class="absolute -top-32"></span>Dynamic persistence</h3>
<p>QBOT registers a window handler to monitor suspend/resume events. When they occur, the malware will install/uninstall persistence.</p>
<p>![QBOT window handler registration]/assets/images/qbot-malware-analysis/7qbot.png)</p>
<p>![QBOT window handler catching suspend/resume event]/assets/images/qbot-malware-analysis/8qbot.png)</p>
<p>QBOT registers a console event to handle shutdown/reboot events as well.</p>
<p><img alt="QBOT registering console handler" loading="lazy" width="785" height="136" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F39qbot.jpg&amp;w=828&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F39qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F39qbot.jpg&amp;w=1920&amp;q=90"/></p>
<p><img alt="QBOT console handler catching shutdown/reboot event" loading="lazy" width="645" height="168" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F40qbot.jpg&amp;w=750&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F40qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F40qbot.jpg&amp;w=1920&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="command-and-control-public-key-pinning" class="absolute -top-32"></span>Command and control public key pinning</h3>
<p>QBOT has a mechanism to verify the signature of every message received from its command and control. The verification mechanism is based on a public key embedded in the sample. This public key could be used to identify the campaign the sample belongs to, but this mechanism may not always be present.</p>
<p>![QBOT command and control message processing]/assets/images/qbot-malware-analysis/1qbot.png)</p>
<p>![Message signature verification with hardcoded command and control public key]/assets/images/qbot-malware-analysis/2qbot.png)</p>
<p>The public key comes from a hardcoded XOR-encrypted data blob.</p>
<p>![Hardcoded command and control public key being XOR-decrypted]/assets/images/qbot-malware-analysis/3qbot.jpg)</p>
<h3 class="font-bold leading-tight text-xl relative"><span id="computer-information-gathering" class="absolute -top-32"></span>Computer information gathering</h3>
<p>Part of QBOT communication with its command and control is sending information about the computer. Information are gathered through a set Windows API calls, shell commands and Windows Management Instrumentation (WMI) commands:</p>
<p>![Computer information gathering 1/2]/assets/images/qbot-malware-analysis/4qbot.jpg)</p>
<p><img alt="Computer information gathering 2/2" loading="lazy" width="950" height="176" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F45qbot.jpg&amp;w=1080&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F45qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F45qbot.jpg&amp;w=1920&amp;q=90"/></p>
<p>One especially interesting procedure listed installed antivirus via WMI:</p>
<p><img alt="QBOT listing installed antivirus via a WMI command" loading="lazy" width="639" height="332" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F46qbot.jpg&amp;w=640&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F46qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F46qbot.jpg&amp;w=1920&amp;q=90"/></p>
<h3 class="font-bold leading-tight text-xl relative"><span id="update-mechanism" class="absolute -top-32"></span>Update mechanism</h3>
<p>QBOT can receive updates from its command and control. The new binary will be written to disk, executed through a command line, and the main process will terminate.</p>
<p>![QBOT writing to disk and running the updated binary]/assets/images/qbot-malware-analysis/7qbot.png)</p>
<p>![QBOT stopping execution if update is running]/assets/images/qbot-malware-analysis/8qbot.png)</p>
<h3 class="font-bold leading-tight text-xl relative"><span id="process-injection-manager" class="absolute -top-32"></span>Process injection manager</h3>
<p>QBOT has a system to keep track of processes injected with binaries received from its command and control in order to manage them as the malware receives subsequent commands. It also has a way to serialize and save those binaries on disk in case it has to stop execution and recover execution when restarted.</p>
<p>To do this bookkeeping, QBOT maintains two global structures — a list of all binaries received from its command and control, and a list of running injected processes:</p>
<p><img alt="QBOT’s list of DLL to inject received from its command and control." loading="lazy" width="702" height="243" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F49qbot.jpg&amp;w=750&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F49qbot.jpg&amp;w=1920&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F49qbot.jpg&amp;w=1920&amp;q=90"/></p>
<p><img alt="QBOT’s list of running injected processes" loading="lazy" width="543" height="61" decoding="async" data-nimg="1" style="color:transparent" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F50qbot.jpg&amp;w=640&amp;q=90 1x, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F50qbot.jpg&amp;w=1200&amp;q=90 2x" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fqbot-malware-analysis%2F50qbot.jpg&amp;w=1200&amp;q=90"/></p>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="conclusion" class="absolute -top-32"></span>Conclusion</h2>
<p>The QBOT malware family is highly active and still part of the threat landscape in 2022 due to its features and its powerful modular system. While initially characterized as an information stealer in 2007, this family has been leveraged as a delivery mechanism for additional malware and post-compromise activity.</p>
<p>Elastic Security provides out-of-the-box prevention capabilities against this threat. Existing Elastic Security users can access these capabilities within the product. If you’re new to Elastic Security, take a look at our <a href="https://www.elastic.co/training/free#quick-starts">Quick Start guides</a> (bite-sized training videos to get you started quickly) or our <a href="https://www.elastic.co/training/free#fundamentals">free fundamentals training courses</a>. You can always get started with a <a href="https://cloud.elastic.co/registration?elektra=whats-new-elastic-security-7-16-blog">free 14-day trial of Elastic Cloud</a>.</p>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="mitre-attck-tactics-and-techniques" class="absolute -top-32"></span>MITRE ATT&amp;CK Tactics and Techniques</h2>
<p>MITRE ATT&amp;CK is a globally-accessible knowledge base of adversary tactics and techniques based on real-world observations. The ATT&amp;CK knowledge base is used as a foundation for the development of specific threat models and methodologies in the private sector, in government, and in the cybersecurity product and service community.</p>
<h3 class="font-bold leading-tight text-xl relative"><span id="tactics" class="absolute -top-32"></span>Tactics</h3>
<p>Tactics represent the why of a technique or sub-technique. It is the adversary’s tactical goal: the reason for performing an action.</p>
<ul>
<li>Tactic: <a href="https://attack.mitre.org/tactics/TA0004">Privilege Escalation</a></li>
<li>Tactic: <a href="https://attack.mitre.org/tactics/TA0005">Defense Evasion</a></li>
<li>Tactic: <a href="https://attack.mitre.org/tactics/TA0007">Discovery</a></li>
<li>Tactic: <a href="https://attack.mitre.org/tactics/TA0011">Command and Control</a></li>
</ul>
<h3 class="font-bold leading-tight text-xl relative"><span id="techniques--sub-techniques" class="absolute -top-32"></span>Techniques / Sub Techniques</h3>
<p>Techniques and Sub techniques represent how an adversary achieves a tactical goal by performing an action.</p>
<ul>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1055">Process Injection</a> (T1055)</li>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1112">Modify Registry</a> (T1112)</li>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1027">Obfuscated Files or Information</a> (T1027)</li>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1027/005">Obfuscated Files or Information: Indicator Removal from Tools</a> (T1027.005)</li>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1218/010">System Binary Proxy Execution: Regsvr32</a> (T1218.010)<br/>
<!-- -->Technique: <a href="https://attack.mitre.org/techniques/T1010">Application Window Discovery</a> (T1010)</li>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1083">File and Directory Discovery</a> (T1083)</li>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1082">System Information Discovery</a> (T1082)</li>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1614">System Location Discovery</a> (T1614)</li>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1518/001">Software Discovery: Security Software Discovery</a> (T1518.001)</li>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1033">System Owner/User Discovery</a> (T1033)</li>
<li>Technique: <a href="https://attack.mitre.org/techniques/T1071/001">Application Layer Protocol: Web Protocols</a> (T1071.001)</li>
</ul>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="observations" class="absolute -top-32"></span>Observations</h2>
<p>While not specific enough to be considered indicators of compromise, the following information was observed during analysis that can help when investigating suspicious events.</p>
<h3 class="font-bold leading-tight text-xl relative"><span id="file-system" class="absolute -top-32"></span>File System</h3>
<p><strong>Persistence folder</strong></p>
<pre><code>**%APPDATA%\Microsoft\[Random Folder]**
</code></pre>
<p><strong>Example:</strong></p>
<pre><code>**C:\Users\Arx\AppData\Roaming\Microsoft\Vuhys**
</code></pre>
<h3 class="font-bold leading-tight text-xl relative"><span id="registry" class="absolute -top-32"></span>Registry</h3>
<p><strong>Scan Exclusion</strong></p>
<pre><code>**HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths\[Persistence Folder]**
</code></pre>
<p><strong>Example:</strong></p>
<pre><code>**HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths\C:\Users\Arx\AppData\Roaming\Microsoft\Blqgeaf**
</code></pre>
<h3 class="font-bold leading-tight text-xl relative"><span id="configuration" class="absolute -top-32"></span>Configuration</h3>
<p><strong>Configuration</strong></p>
<pre><code>**HKU\[User SID]\Software\Microsoft\[Random Key]\[Random Value 0]**
</code></pre>
<p><strong>Example:</strong></p>
<pre><code>**HKU\S-1-5-21-2844492762-1358964462-3296191067-1000\Software\Microsoft\Silhmfua\28e2a7e8**
</code></pre>
<h2 class="font-bold text-xl md:text-3xl relative"><span id="appendices" class="absolute -top-32"></span>Appendices</h2>
<h3 class="font-bold leading-tight text-xl relative"><span id="appendix-a-extracted-network-infrastructure" class="absolute -top-32"></span>Appendix A (extracted network infrastructure)</h3>
<div class="table-container"><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>1.161.71.109:4431.161.71.109:995100.1.108.246:443101.50.103.193:995102.182.232.3:995103.107.113.120:443103.139.243.207:990103.246.242.202:443103.87.95.133:2222103.88.226.30:443105.226.83.196:995108.60.213.141:443109.12.111.14:443109.228.220.196:443113.11.89.165:995117.248.109.38:21120.150.218.241:995120.61.2.95:443121.74.167.191:995125.168.47.127:2222138.204.24.70:443140.82.49.12:443140.82.63.183:443140.82.63.183:995143.0.34.185:443144.202.2.175:443144.202.2.175:995144.202.3.39:443144.202.3.39:995148.64.96.100:443149.28.238.199:443149.28.238.199:995172.114.160.81:995172.115.177.204:2222173.174.216.62:443173.21.10.71:2222174.69.215.101:443175.145.235.37:443176.205.119.81:2078176.67.56.94:443176.88.238.122:995179.158.105.44:443180.129.102.214:995180.183.128.80:2222181.118.183.98:443181.208.248.227:443181.62.0.59:443182.191.92.203:995182.253.189.74:2222185.69.144.209:443</td><td>186.105.121.166:443187.102.135.142:2222187.207.48.194:61202187.250.114.15:443187.251.132.144:22190.252.242.69:443190.73.3.148:2222191.17.223.93:32101191.34.199.129:443191.99.191.28:443196.233.79.3:80197.167.62.14:993197.205.127.234:443197.89.108.252:4432.50.137.197:443201.145.189.252:443201.211.64.196:2222202.134.152.2:2222203.122.46.130:443208.107.221.224:443209.197.176.40:995217.128.122.65:2222217.164.210.192:443217.165.147.83:99324.178.196.158:222224.43.99.75:44331.35.28.29:44331.48.166.122:207832.221.224.140:99537.186.54.254:99537.34.253.233:44338.70.253.226:222239.41.158.185:99539.44.144.159:99539.52.75.201:99539.57.76.82:99540.134.246.185:99541.228.22.180:44341.230.62.211:99341.38.167.179:99541.84.237.10:99542.235.146.7:222245.241.232.25:99545.46.53.140:222245.63.1.12:44345.63.1.12:99545.76.167.26:44345.76.167.26:99545.9.20.200:44346.107.48.202:443</td><td>47.156.191.217:44347.180.172.159:44347.180.172.159:5001047.23.89.62:99347.23.89.62:9955.32.41.45:4435.95.58.211:208766.98.42.102:44367.209.195.198:44368.204.7.158:44370.46.220.114:44370.51.138.126:222271.13.93.154:222271.74.12.34:44372.12.115.90:2272.252.201.34:99572.76.94.99:44373.151.236.31:44373.67.152.98:222274.15.2.252:222275.113.214.234:222275.99.168.194:44375.99.168.194:6120176.169.147.192:3210376.25.142.196:44376.69.155.202:222276.70.9.169:222278.87.206.213:99580.11.74.81:222281.215.196.174:44382.152.39.39:44383.110.75.97:222284.241.8.23:3210385.246.82.244:44386.97.11.43:44386.98.208.214:222286.98.33.141:44386.98.33.141:99588.228.250.126:44389.211.181.64:222290.120.65.153:207891.177.173.10:99592.132.172.197:222293.48.80.198:99594.36.195.250:222294.59.138.62:119494.59.138.62:222296.21.251.127:222296.29.208.97:44396.37.113.36:993</td></tr></tbody></table></div>
<h3 class="font-bold leading-tight text-xl relative"><span id="appendix-b-command-handlers" class="absolute -top-32"></span>Appendix B (command handlers)</h3>
<div class="table-container"><table><thead><tr><th>Id</th><th>Handler</th></tr></thead><tbody><tr><td>0x1</td><td>MARE::rpc::handler::CommunicateWithC2</td></tr><tr><td>0x6</td><td>MARE::rpc::handler::EnableGlobalRegistryConfigurationValuek0x14</td></tr><tr><td>0x7</td><td>MARE::rpc::handler::DisableGlobalRegistryConfigurationValuek0x14</td></tr><tr><td>0xa</td><td>MARE::rpc::handler::KillProcess</td></tr><tr><td>0xc</td><td>MARE::rpc::handler::SetBunchOfGlobalRegistryConfigurationValuesAndTriggerEvent1</td></tr><tr><td>0xd</td><td>MARE::rpc::handler::SetBunchOfGlobalRegistryConfigurationValuesAndTriggerEvent0</td></tr><tr><td>0xe</td><td>MARE::rpc::handler::DoEvasionMove</td></tr><tr><td>0x12</td><td>MARE::rpc::handler::NotImplemented</td></tr><tr><td>0x13</td><td>MARE::rpc::handler::UploadAndRunUpdatedQBOT0</td></tr><tr><td>0x14</td><td>MARE::rpc::handler::Unk0</td></tr><tr><td>0x15</td><td>MARE::rpc::handler::Unk1</td></tr><tr><td>0x19</td><td>MARE::rpc::handler::UploadAndExecuteBinary</td></tr><tr><td>0x1A</td><td>MARE::rpc::handler::UploadAndInjectDll0</td></tr><tr><td>0x1B</td><td>MARE::rpc::handler::DoInjectionFromDllToInjectByStr</td></tr><tr><td>0x1C</td><td>MARE::rpc::handler::KillInjectedProcessAndDisableDllToInject</td></tr><tr><td>0x1D</td><td>MARE::rpc::handler::Unk3</td></tr><tr><td>0x1E</td><td>MARE::rpc::handler::KillInjectedProcessAndDoInjectionAgainByStr</td></tr><tr><td>0x1F</td><td>MARE::rpc::handler::FastInjectdll</td></tr><tr><td>0x21</td><td>MARE::rpc::handler::ExecuteShellCmd</td></tr><tr><td>0x23</td><td>MARE::rpc::handler::UploadAndInjectDll1</td></tr><tr><td>0x24</td><td>MARE::rpc::handler::UploadAndRunUpdatedQBOT1</td></tr><tr><td>0x25</td><td>MARE::rpc::handler::SetValueToGlobalRegistryConfiguration</td></tr><tr><td>0x26</td><td>MARE::rpc::handler::DeleteValueFromGlobalRegistryConfiguration</td></tr><tr><td>0x27</td><td>MARE::rpc::handler::ExecutePowershellCmd</td></tr><tr><td>0x28</td><td>MARE::rpc::handler::UploadAndRunDllWithRegsvr32</td></tr><tr><td>0x29</td><td>MARE::rpc::handler::UploadAndRunDllWithRundll32</td></tr></tbody></table></div>
<h3 class="font-bold leading-tight text-xl relative"><span id="appendix-c-string-deciphering-implementation" class="absolute -top-32"></span>Appendix C (string deciphering implementation)</h3>
<pre><code>def decipher_strings(data: bytes, key: bytes) -&gt; bytes:
   result = dict()
   current_index = 0
   current_string = list()
   for i in range(len(data)):
       current_string.append(data[i] ^ key[i % len(key)])
       if data[i] == key[i % len(key)]:
              result[current_index] = bytes(current_string)
              current_string = list()
              current_index = i + 1
   return result
</code></pre>
<h3 class="font-bold leading-tight text-xl relative"><span id="appendix-d-resource-deciphering-implementation" class="absolute -top-32"></span>Appendix D (resource deciphering implementation)</h3>
<pre><code>from Crypto.Cipher import ARC4
from Crypto.Hash import SHA1

def decipher_data(data: bytes, key: bytes) -&gt; tuple[bytes, bytes]:
   data = ARC4.ARC4Cipher(SHA1.SHA1Hash(key).digest()).decrypt(data)
   return data[20:], data[:20]


def verify_hash(data: bytes, expected_hash: bytes) -&gt; bool:
   return SHA1.SHA1Hash(data).digest() == expected_hash


def decipher_rsrc(rsrc: bytes, key: bytes) -&gt; bytes:
   deciphered_rsrc, expected_hash = decipher_data(rsrc[20:], rsrc[:20])
   if not verify_hash(deciphered_rsrc, expected_hash):
       deciphered_rsrc, expected_hash = decipher_data(rsrc, key)
       if not verify_hash(deciphered_rsrc, expected_hash):
              raise RuntimeError(&#x27;Failed to decipher rsrc: Mismatching hashes.&#x27;)
   return deciphered_rsrc
</code></pre></div></div></div><div class="hidden lg:flex lg:col-span-1 text-sm lg:flex-col lg:space-y-6"><div class="toc"><h4 class="font-bold leading-tight text-lg mb-3">Jump to section</h4><ul class="flex flex-col space-y-2"><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/qbot-malware-analysis#key-takeaways"><span>Key&nbsp;takeaways</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/qbot-malware-analysis#preamble"><span>Preamble</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/qbot-malware-analysis#execution-flow"><span>Execution&nbsp;flow</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/qbot-malware-analysis#stage-1"><span>Stage&nbsp;1</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/qbot-malware-analysis#stage-2"><span>Stage&nbsp;2</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/qbot-malware-analysis#stage-3"><span>Stage&nbsp;3</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/qbot-malware-analysis#features"><span>Features</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/qbot-malware-analysis#mersenne-twister-random-number-generator"><span>Mersenne Twister Random Number&nbsp;Generator</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/qbot-malware-analysis#string-obfuscation"><span>String&nbsp;obfuscation</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/qbot-malware-analysis#import-obfuscation"><span>Import&nbsp;obfuscation</span></a></li></ul><button class="border-t border-white/20 w-full mt-3 py-2 flex items-center space-x-1 text-xs font-medium uppercase tracking-wide hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="w-3 h-3"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg><span>Show more</span></button></div><div class="bg-zinc-900 border border-zinc-800 drop-shadow-lg p-5 md:p-2 sm:p-4 md:px-6 md:py-4 rounded-xl"><h4 class="font-bold leading-tight text-lg mb-3">Elastic Security Labs Newsletter</h4><div><a target="_blank" class="button inline-flex" href="https://www.elastic.co/security-labs/newsletter?utm_source=security-labs">Sign Up</a></div></div></div></div><div class="bg-zinc-900 border border-zinc-800 drop-shadow-lg p-5 md:p-2 sm:p-4 md:px-6 md:py-4 rounded-xl my-5 md:my-10 max-w-3xl mx-auto flex flex-col items-center shadow-2xl"><h4 class="font-bold leading-tight text-lg">Share this article</h4><div class="flex flex-wrap items-center justify-center mt-4 space-x-4"><a class="flex items-center space-x-2 button" href="https://twitter.com/intent/tweet?text=QBOT Malware Analysis&amp;url=https://www.elastic.co/security-labs/qbot-malware-analysis" target="_blank" rel="noopener noreferrer" aria-label="Share this article on Twitter" title="Share this article on Twitter"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M23.954 4.569c-.885.389-1.83.653-2.825.772a4.98 4.98 0 002.187-2.746 9.955 9.955 0 01-3.157 1.204 4.98 4.98 0 00-8.49 4.54A14.128 14.128 0 011.69 3.05a4.98 4.98 0 001.54 6.638A4.94 4.94 0 011.2 8.62v.06a4.98 4.98 0 004 4.87 4.94 4.94 0 01-2.24.086 4.98 4.98 0 004.64 3.45A9.97 9.97 0 010 20.35a14.075 14.075 0 007.59 2.22c9.16 0 14.17-7.583 14.17-14.17 0-.217-.005-.434-.015-.65a10.128 10.128 0 002.485-2.58l-.001-.001z"></path></svg><span>Twitter</span></a><a class="flex items-center space-x-2 button" href="https://www.facebook.com/sharer/sharer.php?u=https://www.elastic.co/security-labs/qbot-malware-analysis" target="_blank" rel="noopener noreferrer" aria-label="Share this article on Facebook" title="Share this article on Facebook"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M22.5 12c0-5.799-4.701-10.5-10.5-10.5S1.5 6.201 1.5 12c0 5.301 3.901 9.699 9 10.401V14.4h-2.7v-2.7h2.7v-2.1c0-2.7 1.8-4.2 4.2-4.2 1.2 0 2.1.1 2.4.2v2.4h-1.5c-1.2 0-1.5.6-1.5 1.5v1.8h3l-.3 2.7h-2.7V22C18.599 21.3 22.5 17.301 22.5 12z"></path></svg><span>Facebook</span></a><a class="flex items-center space-x-2 button" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.elastic.co/security-labs/qbot-malware-analysis&amp;title=QBOT Malware Analysis" target="_blank" rel="noopener noreferrer" aria-label="Share this article on LinkedIn" title="Share this article on LinkedIn"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg><span>LinkedIn</span></a><a class="flex items-center space-x-2 button" href="https://reddit.com/submit?url=https://www.elastic.co/security-labs/qbot-malware-analysis&amp;title=QBOT Malware Analysis" target="_blank" rel="noopener noreferrer" aria-label="Share this article on Reddit" title="Share this article on Reddit"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M24 12C24 18.6274 18.6274 24 12 24C5.37258 24 0 18.6274 0 12C0 5.37258 5.37258 0 12 0C18.6274 0 24 5.37258 24 12ZM19.6879 11.0584C19.8819 11.3352 19.9916 11.6622 20.004 12C20.0091 12.3306 19.9205 12.656 19.7485 12.9384C19.5765 13.2208 19.3281 13.4488 19.032 13.596C19.0455 13.7717 19.0455 13.9483 19.032 14.124C19.032 16.812 15.9 18.996 12.036 18.996C8.172 18.996 5.04 16.812 5.04 14.124C5.02649 13.9483 5.02649 13.7717 5.04 13.596C4.80919 13.49 4.6042 13.335 4.43923 13.1419C4.27427 12.9487 4.15327 12.722 4.08462 12.4775C4.01598 12.2329 4.00133 11.9764 4.04169 11.7256C4.08205 11.4748 4.17646 11.2358 4.31837 11.0251C4.46028 10.8145 4.6463 10.6372 4.86354 10.5056C5.08078 10.3739 5.32404 10.2911 5.57646 10.2629C5.82889 10.2346 6.08444 10.2616 6.32541 10.3419C6.56638 10.4222 6.78701 10.5539 6.972 10.728C8.35473 9.79023 9.98146 9.27718 11.652 9.252L12.54 5.088C12.55 5.03979 12.5694 4.99405 12.5972 4.95341C12.625 4.91277 12.6605 4.87805 12.7018 4.85127C12.7431 4.82448 12.7894 4.80615 12.8378 4.79735C12.8862 4.78855 12.9359 4.78945 12.984 4.8L15.924 5.388C16.0676 5.14132 16.2944 4.9539 16.5637 4.85937C16.833 4.76484 17.1272 4.7694 17.3934 4.87222C17.6597 4.97505 17.8806 5.1694 18.0164 5.42041C18.1523 5.67141 18.1942 5.96262 18.1348 6.24177C18.0753 6.52092 17.9182 6.76972 17.6918 6.94352C17.4654 7.11732 17.1845 7.20473 16.8995 7.19006C16.6144 7.1754 16.3439 7.05962 16.1366 6.8635C15.9292 6.66738 15.7985 6.40378 15.768 6.12L13.2 5.58L12.42 9.324C14.0702 9.3594 15.6749 9.87206 17.04 10.8C17.2839 10.566 17.5902 10.4074 17.9221 10.3436C18.254 10.2797 18.5973 10.3132 18.9106 10.4401C19.2239 10.5669 19.4939 10.7817 19.6879 11.0584ZM8.20624 12.5333C8.07438 12.7307 8.004 12.9627 8.004 13.2C8.004 13.5183 8.13043 13.8235 8.35547 14.0485C8.58051 14.2736 8.88574 14.4 9.204 14.4C9.44134 14.4 9.67335 14.3296 9.87068 14.1978C10.068 14.0659 10.2218 13.8785 10.3127 13.6592C10.4035 13.4399 10.4272 13.1987 10.3809 12.9659C10.3346 12.7331 10.2204 12.5193 10.0525 12.3515C9.8847 12.1836 9.67089 12.0694 9.43811 12.0231C9.20533 11.9768 8.96405 12.0005 8.74478 12.0913C8.52551 12.1822 8.33809 12.336 8.20624 12.5333ZM12.012 17.424C13.0771 17.4681 14.1246 17.1416 14.976 16.5V16.548C15.0075 16.5173 15.0327 16.4806 15.05 16.4402C15.0674 16.3997 15.0766 16.3563 15.0772 16.3122C15.0777 16.2682 15.0696 16.2245 15.0533 16.1837C15.0369 16.1428 15.0127 16.1055 14.982 16.074C14.9513 16.0425 14.9146 16.0173 14.8742 16C14.8337 15.9826 14.7903 15.9734 14.7462 15.9728C14.7022 15.9723 14.6585 15.9804 14.6177 15.9967C14.5768 16.0131 14.5395 16.0373 14.508 16.068C13.7797 16.5904 12.895 16.8487 12 16.8C11.1061 16.8399 10.2255 16.5732 9.504 16.044C9.44182 15.993 9.36289 15.9669 9.28256 15.9708C9.20222 15.9748 9.12622 16.0085 9.06935 16.0653C9.01247 16.1222 8.97879 16.1982 8.97484 16.2786C8.97089 16.3589 8.99697 16.4378 9.048 16.5C9.89937 17.1416 10.9469 17.4681 12.012 17.424ZM14.0933 14.2458C14.2907 14.3776 14.5227 14.448 14.76 14.448L14.748 14.496C14.9107 14.4978 15.0721 14.4664 15.2223 14.4038C15.3725 14.3413 15.5084 14.2488 15.6218 14.1321C15.7352 14.0154 15.8236 13.8768 15.8818 13.7248C15.9399 13.5728 15.9665 13.4106 15.96 13.248C15.96 13.0107 15.8896 12.7787 15.7578 12.5813C15.6259 12.384 15.4385 12.2302 15.2192 12.1393C14.9999 12.0485 14.7587 12.0248 14.5259 12.0711C14.2931 12.1174 14.0793 12.2316 13.9115 12.3995C13.7436 12.5673 13.6294 12.7811 13.5831 13.0139C13.5368 13.2467 13.5605 13.4879 13.6513 13.7072C13.7422 13.9265 13.896 14.1139 14.0933 14.2458Z" fill="currentColor"></path></svg><span>Reddit</span></a></div></div></article></main><footer class="mt-auto text-xs md:text-sm"><div class="container py-6 flex flex-col md:flex-row gap-2 md:gap-0 justify-between items-center"><div class="text-zinc-300"><nav><ul class="flex space-x-4"><li><a class="hover:text-white font-medium" href="/security-labs/sitemap.xml">Sitemap</a></li><li><a class="hover:text-white font-medium flex items-center space-x-1" href="https://elastic.co?utm_source=elastic-search-labs&amp;utm_medium=referral&amp;utm_campaign=search-labs&amp;utm_content=footer"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="inline-block w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"></path></svg><span>Elastic.co</span></a></li><li><a class="hover:text-white font-medium flex items-center space-x-1" href="https://twitter.com/elasticseclabs"><svg class="w-4 h-4 inline-block w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M23.954 4.569c-.885.389-1.83.653-2.825.772a4.98 4.98 0 002.187-2.746 9.955 9.955 0 01-3.157 1.204 4.98 4.98 0 00-8.49 4.54A14.128 14.128 0 011.69 3.05a4.98 4.98 0 001.54 6.638A4.94 4.94 0 011.2 8.62v.06a4.98 4.98 0 004 4.87 4.94 4.94 0 01-2.24.086 4.98 4.98 0 004.64 3.45A9.97 9.97 0 010 20.35a14.075 14.075 0 007.59 2.22c9.16 0 14.17-7.583 14.17-14.17 0-.217-.005-.434-.015-.65a10.128 10.128 0 002.485-2.58l-.001-.001z"></path></svg><span>@elasticseclabs</span></a></li></ul></nav></div><div class="flex flex-col space-y-1 text-zinc-300"><p>© <!-- -->2023<!-- -->. Elasticsearch B.V. All Rights Reserved.</p></div></div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"title":"QBOT Malware Analysis","slug":"qbot-malware-analysis","date":"2023-02-14","description":"Elastic Security Labs releases a QBOT malware analysis report covering the execution chain. From this research, the team has produced a YARA rule, configuration-extractor, and indicators of compromises (IOCs).","image":"blog-thumb-drill-bit.jpg","tags":["ref3726","qbot","qakbot"],"body":{"raw":"\n## Key takeaways\n\n- Elastic Security Labs is releasing a QBOT malware analysis report from a recent [campaign](https://www.elastic.co/security-labs/exploring-the-qbot-attack-pattern)\n- This report covers the execution chain from initial infection to communication with its command and control containing details about in depth features such as its injection mechanism and dynamic persistence mechanism.\n- From this research we produced a [YARA rule](https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_Qbot.yar), [configuration-extractor](https://www.elastic.co/security-labs/qbot-configuration-extractor), and indicators of compromises (IOCs)\n\n## Preamble\n\nAs part of our mission to build knowledge about the most common malware families targeting institutions and individuals, the Elastic Malware and Reverse Engineering team (MARE) completed the analysis of the core component of the banking trojan QBOT/QAKBOT V4 from a previously reported [campaign](https://www.elastic.co/security-labs/exploring-the-qbot-attack-pattern).\n\nQBOT — also known as QAKBOT — is a modular Trojan active since 2007 used to download and run binaries on a target machine. This document describes the in-depth reverse engineering of the QBOT V4 core components. It covers the execution flow of the binary from launch to communication with its command and control (C2).\n\nQBOT is a multistage, multiprocess binary that has capabilities for evading detection, escalating privileges, configuring persistence, and communicating with C2 through a set of IP addresses. The C2 can update QBOT, upload new IP addresses, upload and run fileless binaries, and execute shell commands.\n\nAs a result of this analysis, MARE has produced a new yara rule based on the core component of QBOT as well as a static configuration extractor able to extract and decrypt its strings, its configuration, and its C2 IP address list.\n\n\u003e For information on the QBOT configuration extractor and malware analysis, check out our blog posts detailing this:\n\u003e\n\u003e - [QBOT Configuration Extractor](https://www.elastic.co/security-labs/qbot-configuration-extractor)\n\u003e - [QBOT Attack Pattern](https://www.elastic.co/security-labs/exploring-the-qbot-attack-pattern)\n\n## Execution flow\n\nThis section describes the QBOT execution flow in the following three stages:\n\n- First Stage: Initialization\n- Second Stage: Installation\n- Third Stage: Communication\n\n### Stage 1\n\n![First stage execution flow](/assets/images/qbot-malware-analysis/1qbot.png)\n\nThe sample is executed with the **regsvr32.exe** binary, which in turn will call QBOT’s **DllRegisterServer** export:\n\n![regsvr32.exe loading QBOT and calling its DllRegisterServer export.](/assets/images/qbot-malware-analysis/2qbot.png)\n\nAfter execution, QBOT checks if it’s running under the Windows Defender sandbox by checking the existence of a specific subdirectory titled: **C:\\\\INTERNAL\\\\\\_\\_empty** , if this folder exists, the malware terminates itself:\n\n![QBOT checking if it is running and Windows Defender sandbox.](/assets/images/qbot-malware-analysis/3qbot.jpg)\n\nThe malware will then enumerate running processes to detect any antivirus (AV) products on the machine. The image below contains a list of AV vendors QBOT reacts to:\n\n![Enum of vendors QBOT can detect.](/assets/images/qbot-malware-analysis/4qbot.jpg)\n\nAV detection will not prevent QBOT from running. However, it will change its behavior in later stages. In order to generate a seed for its pseudorandom number generator (PRNG), QBOT generates a fingerprint of the computer by using the following expression:\n\n```\n**fingerprint = CRC32(computerName + CVolumeSerialNumber + AccountName)**\n```\n\nIf the **“C:”** volume doesn’t exist the expression below is used instead:\n\n```\n**fingerprint = CRC32(computerName + AccountName)**\n```\n\nFinally, QBOT will choose a set of targets to inject into depending on the AVs previously detected and the machine architecture:\n\n|                            |                                                                                                               |\n| -------------------------- | ------------------------------------------------------------------------------------------------------------- | ---------------------- | ----------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------ |\n| AV detected \u0026 architecture | Targets                                                                                                       |\n| BitDefender                | Kaspersky                                                                                                     | Sophos                 | TrendMicro                                                                                                                    | \u0026 x86                                                                                                        | %SystemRoot%\\\\SysWOW64\\\\mobsync.exe %SystemRoot%\\\\SysWOW64\\\\explorer.exe |\n| BitDefender                | Kaspersky                                                                                                     | Sophos                 | TrendMicro \u0026 x64                                                                                                              | %SystemRoot%\\\\System32\\\\mobsync.exe%SystemRoot%\\\\explorer.exe%ProgramFiles%\\\\Internet Explorer\\\\iexplore.exe |\n| Avast                      | AVG                                                                                                           | Windows Defender \u0026 x86 | %SystemRoot%\\\\SysWOW64\\\\OneDriveSetup.exe%SystemRoot%\\\\SysWOW64\\\\msra.exe%ProgramFiles(x86)%\\\\Internet Explorer\\\\iexplore.exe |\n| Avast                      | AVG                                                                                                           | Windows Defender \u0026 x64 | %SystemRoot%\\\\System32\\\\OneDriveSetup.exe%SystemRoot%\\\\System32\\\\msra.exe                                                     |\n| x86                        | '%SystemRoot%\\\\explorer.exe%SystemRoot%\\\\System32\\\\msra.exe%SystemRoot%\\\\System32\\\\OneDriveSetup.exe          |\n| x64                        | %SystemRoot%\\\\SysWOW64\\\\explorer.exe%SystemRoot%\\\\SysWOW64\\\\msra.exe%SystemRoot%\\\\System32\\\\OneDriveSetup.exe |\n\nQBOT will try to inject itself iteratively, using its second stage as an entry point, into one of its targets– choosing the next target process if the injection fails. Below is an example of QBOT injecting into **explorer.exe**.\n\n![QBOT injecting itself into explorer.exe](/assets/images/qbot-malware-analysis/7qbot.png)\n\n### Stage 2\n\n![Second stage execution flow](/assets/images/qbot-malware-analysis/8qbot.png)\n\nQBOT begins its second stage by saving the content of its binary in memory and then corrupting the file on disk:\n\n![QBOT corrupting its binary file](/assets/images/qbot-malware-analysis/0.jpg)\n\nThe malware then loads its configuration from one of its resource sections:\n\n![QBOT loading its configuration from resource](/assets/images/qbot-malware-analysis/10qbot.jpg)\n\nQBOT also has the capability to load its configuration from a **.cfg** file if available in the process root directory:\n\n![QBOT trying to load its configuration from a file](/assets/images/qbot-malware-analysis/1.jpg)\n\nAfter loading its configuration, QBOT proceeds to install itself on the machine– initially by writing its internal configuration to the registry:\n\n![QBOT writing its configuration to the registry](/assets/images/qbot-malware-analysis/2.jpg)\n\nShortly after, QBOT creates a persistence subdirectory with a randomly-generated name under the **%APPDATA%\\Microsoft** directory. This folder is used to drop the in-memory QBOT binary for persistence across reboot:\n\n![QBOT creating its persistence folder](/assets/images/qbot-malware-analysis/3.jpg)\n\nAt this point, the folder will be empty because the malware will only drop the binary if a shutdown/reboot event is detected. This “contingency” binary will be deleted after reboot.\n\nQBOT will attempt the same install process for all users and try to either execute the malware within the user session if it exists, or create a value under the **CurrentVersion\\Run** registry key for the targeted user to launch the malware at the next login. Our analysis didn’t manage to reproduce this behavior on an updated Windows 10 machine. The only artifact observed is the randomly generated persistence folder created under the user **%APPDATA%\\Microsoft** directory:\n\n![Persistence folder is empty when QBOT is running](/assets/images/qbot-malware-analysis/4qbot.jpg)\n\nQBOT finishes its second stage by restoring the content of its corrupted binary and registering a task via **Schtask** to launch a QBOT service under the **NT AUTHORITY\\SYSTEM** account.\n\nThe first stage has a special execution path where it registers a service handler if the process is running under the **SYSTEM** account. The QBOT service then executes stages 2 and 3 as normal, corrupting the binary yet again and executing commands on behalf of other QBOT processes via messages received through a randomly generated named pipe:\n\n![QBOT running as SYSTEM service](/assets/images/qbot-malware-analysis/15qbot.png)\n\n### Stage 3\n\n![Third stage execution flow](/assets/images/qbot-malware-analysis/16qbot.png)\n\nQBOT begins its third stage by registering a window and console event handler to monitor suspend/resume and shutdown/reboot events. Monitoring these events enables the malware to install persistence dynamically by dropping a copy of the QBOT binary in the persistence folder and creating a value under the **CurrentVersion\\Run** registry key:\n\n![QBOT install persistence when suspend/resume or shutdown/reboot event occurs](/assets/images/qbot-malware-analysis/7qbot.png)\n\nAt reboot, QBOT will take care of deleting any persistence artifacts.\n\nThe malware will proceed to creating a watchdog thread to monitor running processes against a hardcoded list of binaries every second. If any process matches, a registry value is set that will then change QBOT behavior to use randomly generated IP addresses instead of the real one, thus never reaching its command and control:\n\n|                                                                                                                                                                          |                                                                                                                                           |                                                                                                                                                                   |\n| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| frida-winjector-helper-32.exefrida-winjector-helper-64.exeTcpdump.exewindump.exeethereal.exewireshark.exeettercap.exertsniff.exepacketcapture.execapturenet.exeqak_proxy | dumpcap.exeCFF Explorer.exenot_rundll32.exeProcessHacker.exetcpview.exefilemon.exeprocmon.exeidaq64.exePETools.exeImportREC.exeLordPE.exe | SysInspector.exeproc_analyzer.exesysAnalyzer.exesniff_hit.exejoeboxcontrol.exejoeboxserver.exeResourceHacker.exex64dbg.exeFiddler.exesniff_hit.exesysAnalyzer.exe |\n\nQBOT will then load its domains from one of its **.rsrc** files and from the registry as every domain update received from its C2 will be part of its configuration written to the registry. See Extracted Network Infrastructure in Appendix A.\n\nFinally, the malware starts communicating with C2 via HTTP and TLS. The underlying protocol uses a JSON object encapsulated within an enciphered message which is then base64-encoded:\n\n![QBOT message format](/assets/images/qbot-malware-analysis/8qbot.png)\n\nBelow an example of a HTTP POST request sent by QBOT to its C2:\n\n```\nAccept: application/x-shockwave-flash, image/gif, image/jpeg, image/pjpeg, */*\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\nHost: 181.118.183.98\nContent-Length: 77\nCache-Control: no-cache\n\nqxlbjrbj=NnySaFAKLt+YgjH3UET8U6AUwT9Lg51z6zC+ufeAjt4amZAXkIyDup74MImUA4do4Q==\n```\n\nThrough this communication channel, QBOT receives commands from C2 — see Appendix B (Command Handlers). Aside from management commands (update, configuration knobs), our sample only handles binary execution-related commands, but we know that the malware is modular and can be built with additional features like a VNC server, a reverse shell server, proxy support (to be part of the domains list), and numerous other capabilities are feasible.\n\n## Features\n\n### Mersenne Twister Random Number Generator\n\nQBOT uses an implementation of [Mersenne Twister Random Number Generator](https://www.sciencedirect.com/topics/computer-science/mersenne-twister) (MTRNG) to generate random values:\n\n![QBOT's Mersenne Twister Random Number Generator implementation](/assets/images/qbot-malware-analysis/19qbot.jpg)\n\nThe MTRNG engine is then used by various functions to generate different types of data, for example for generating registry key values and persistence folders. As QBOT needs to reproduce values, it will almost always use the computer fingerprint and a “salt” specific to the value it wants to generate:\n\n![QBOT generating random event name with fixed seed and salt](/assets/images/qbot-malware-analysis/20qbot.jpg)\n\n### String obfuscation\n\nAll QBOT strings are XOR-encrypted and concatenated in a single blob we call a “string bank”. To get a specific string the malware needs a string identifier (identifier being an offset in the string bank), a decryption key, and the targeted string bank.\n\n![GetStringAux function prototype.](/assets/images/qbot-malware-analysis/1qbot.png)\n\nAs this sample has two string banks, it has four **GetString**' functions currying the string bank and the decryption key parameters: One C string function and one wide string function for each string bank. Wide string functions use the same string banks, but convert the data to **utf-16**.\n\n![QBOT calling GetString function](/assets/images/qbot-malware-analysis/2qbot.png)\n\n![GetString function currying GetStringAux with string bank and key parameters](/assets/images/qbot-malware-analysis/3qbot.jpg)\n\nSee Appendix C (String Deciphering Implementation).\n\n### Import obfuscation\n\nQBOT resolves its imports using a hash table:\n\n![QBOT calling GetApi function](/assets/images/qbot-malware-analysis/4qbot.jpg)\n\n![GetApi function prototype](/assets/images/qbot-malware-analysis/25qbot.jpg)\n\nThe malware resolves the library name through its GetString function and then resolves the hash table with a classic library’s exports via manual parsing, comparing each export to the expected hash. In this sample, the hashing comparison algorithm use this formula:\n\n```\n**CRC32(exportName) XOR 0x218fe95b == hash**\n```\n\n### Resource obfuscation\n\nThe malware is embedded with different resources, the common ones are the configuration and the domains list. Resources are encrypted the same way: The decryption key may be either embedded within the data blob or provided. Once the resource is decrypted, an embedded hash is used to check data validity.\n\n![QBOT decrypting its resource with embedded or provided key](/assets/images/qbot-malware-analysis/26qbot.jpg)\n\nSee Appendix D (Resource Deciphering Implementation).\n\n### Cyrillic keyboard language detection\n\nAt different stages, QBOT will check if the computer uses a Cyrillic language keyboard. If it does, it prevents further execution.\n\n![Set of languages QBOT is looking to stop its execution](/assets/images/qbot-malware-analysis/7qbot.png)\n\n### AVG/AVAST special behavior\n\nAVG and Avast share the same antivirus engine. Thus if QBOT detects one of those antivirus running, it will also check at the installation stage if one of their DLLs is loaded within the malware memory space. If so, QBOT will skip the installation phase.\n\n![QBOT checking if AVG/AVAST has hooked its process](/assets/images/qbot-malware-analysis/8qbot.png)\n\n### Windows Defender special behavior\n\nIf QBOT is running under **SYSTEM** account, it will add its persistence folder to the Windows Defender exclusion path in the registry. It will also do this for the legacy Microsoft Security Essential (MSE) exclusion path if detected.\n\n![QBOT adding its persistence folder to Windows Defender and MSE exclusion paths](/assets/images/qbot-malware-analysis/29qbot.jpg)\n\n### Exception list process watchdog\n\nEach second, QBOT parses running processes looking for one matching the hardcoded exception list. If any is found, a “fuse” value is set in the registry and the watchdog stops. If this fuse value is set, QBOT will not stop execution– but at the third stage, the malware will use randomly generated IP and won't be able to contact C2.\n\n![Watchdog thread setting fuse if any Exceptionlisted process is detected](/assets/images/qbot-malware-analysis/30qbot.jpg)\n\n![QBOT using randomly generated IP address if fuse is set]/assets/images/qbot-malware-analysis/1qbot.png)\n\n### QBOT process injection\n\n#### Second stage injection\n\nTo inject its second stage into one of a hardcoded target, QBOT uses a classic **CreateProcess** , **WriteProcessMemory** , **ResumeProcess** DLL injection technique. The malware will create a process, allocate and write the QBOT binary within the process memory, write a copy of its engine, and patch the entry point to jump to a special function. This function performs a light initialization of QBOT and its engine within the new process environment, alerts the main process of its success, and then execute the second stage.\n\n![QBOT second stage injection]/assets/images/qbot-malware-analysis/2qbot.png)\n\n![QBOT injection entry point]/assets/images/qbot-malware-analysis/3qbot.jpg)\n\n#### Injecting library from command and control\n\nQBOT uses the aforementioned method to inject libraries received from C2. The difference is that as well as mapping itself, the malware will also map the received binary and use a library loader as entry point.\n\n![QBOT DLL loader injection]/assets/images/qbot-malware-analysis/4qbot.jpg)\n\n![QBOT Dll loader entrypoint](/assets/images/qbot-malware-analysis/35qbot.jpg)\n\n### Multi-user installation\n\nPart of the QBOT installation process is installing itself within others users’ accounts. To do so, the malware enumerates each user with an account on the machine (local and domain), then dumps its configuration under the user’s **Software\\Microsoft** registry key, creates a persistence folder under the users’ **%APPDATA%\\Microsoft** folder, and finally tries to either launch QBOT under the user session if the session exist, or else creates a run key to launch the malware when the user will log in.\n\n![QBOT installation \u0026 run for one user](/assets/images/qbot-malware-analysis/36qbot.jpg)\n\n### Dynamic persistence\n\nQBOT registers a window handler to monitor suspend/resume events. When they occur, the malware will install/uninstall persistence.\n\n![QBOT window handler registration]/assets/images/qbot-malware-analysis/7qbot.png)\n\n![QBOT window handler catching suspend/resume event]/assets/images/qbot-malware-analysis/8qbot.png)\n\nQBOT registers a console event to handle shutdown/reboot events as well.\n\n![QBOT registering console handler](/assets/images/qbot-malware-analysis/39qbot.jpg)\n\n![QBOT console handler catching shutdown/reboot event](/assets/images/qbot-malware-analysis/40qbot.jpg)\n\n### Command and control public key pinning\n\nQBOT has a mechanism to verify the signature of every message received from its command and control. The verification mechanism is based on a public key embedded in the sample. This public key could be used to identify the campaign the sample belongs to, but this mechanism may not always be present.\n\n![QBOT command and control message processing]/assets/images/qbot-malware-analysis/1qbot.png)\n\n![Message signature verification with hardcoded command and control public key]/assets/images/qbot-malware-analysis/2qbot.png)\n\nThe public key comes from a hardcoded XOR-encrypted data blob.\n\n![Hardcoded command and control public key being XOR-decrypted]/assets/images/qbot-malware-analysis/3qbot.jpg)\n\n### Computer information gathering\n\nPart of QBOT communication with its command and control is sending information about the computer. Information are gathered through a set Windows API calls, shell commands and Windows Management Instrumentation (WMI) commands:\n\n![Computer information gathering 1/2]/assets/images/qbot-malware-analysis/4qbot.jpg)\n\n![Computer information gathering 2/2](/assets/images/qbot-malware-analysis/45qbot.jpg)\n\nOne especially interesting procedure listed installed antivirus via WMI:\n\n![QBOT listing installed antivirus via a WMI command](/assets/images/qbot-malware-analysis/46qbot.jpg)\n\n### Update mechanism\n\nQBOT can receive updates from its command and control. The new binary will be written to disk, executed through a command line, and the main process will terminate.\n\n![QBOT writing to disk and running the updated binary]/assets/images/qbot-malware-analysis/7qbot.png)\n\n![QBOT stopping execution if update is running]/assets/images/qbot-malware-analysis/8qbot.png)\n\n### Process injection manager\n\nQBOT has a system to keep track of processes injected with binaries received from its command and control in order to manage them as the malware receives subsequent commands. It also has a way to serialize and save those binaries on disk in case it has to stop execution and recover execution when restarted.\n\nTo do this bookkeeping, QBOT maintains two global structures — a list of all binaries received from its command and control, and a list of running injected processes:\n\n![QBOT’s list of DLL to inject received from its command and control.](/assets/images/qbot-malware-analysis/49qbot.jpg)\n\n![QBOT’s list of running injected processes](/assets/images/qbot-malware-analysis/50qbot.jpg)\n\n## Conclusion\n\nThe QBOT malware family is highly active and still part of the threat landscape in 2022 due to its features and its powerful modular system. While initially characterized as an information stealer in 2007, this family has been leveraged as a delivery mechanism for additional malware and post-compromise activity.\n\nElastic Security provides out-of-the-box prevention capabilities against this threat. Existing Elastic Security users can access these capabilities within the product. If you’re new to Elastic Security, take a look at our [Quick Start guides](https://www.elastic.co/training/free#quick-starts) (bite-sized training videos to get you started quickly) or our [free fundamentals training courses](https://www.elastic.co/training/free#fundamentals). You can always get started with a [free 14-day trial of Elastic Cloud](https://cloud.elastic.co/registration?elektra=whats-new-elastic-security-7-16-blog).\n\n## MITRE ATT\u0026CK Tactics and Techniques\n\nMITRE ATT\u0026CK is a globally-accessible knowledge base of adversary tactics and techniques based on real-world observations. The ATT\u0026CK knowledge base is used as a foundation for the development of specific threat models and methodologies in the private sector, in government, and in the cybersecurity product and service community.\n\n### Tactics\n\nTactics represent the why of a technique or sub-technique. It is the adversary’s tactical goal: the reason for performing an action.\n\n- Tactic: [Privilege Escalation](https://attack.mitre.org/tactics/TA0004)\n- Tactic: [Defense Evasion](https://attack.mitre.org/tactics/TA0005)\n- Tactic: [Discovery](https://attack.mitre.org/tactics/TA0007)\n- Tactic: [Command and Control](https://attack.mitre.org/tactics/TA0011)\n\n### Techniques / Sub Techniques\n\nTechniques and Sub techniques represent how an adversary achieves a tactical goal by performing an action.\n\n- Technique: [Process Injection](https://attack.mitre.org/techniques/T1055) (T1055)\n- Technique: [Modify Registry](https://attack.mitre.org/techniques/T1112) (T1112)\n- Technique: [Obfuscated Files or Information](https://attack.mitre.org/techniques/T1027) (T1027)\n- Technique: [Obfuscated Files or Information: Indicator Removal from Tools](https://attack.mitre.org/techniques/T1027/005) (T1027.005)\n- Technique: [System Binary Proxy Execution: Regsvr32](https://attack.mitre.org/techniques/T1218/010) (T1218.010)  \n  Technique: [Application Window Discovery](https://attack.mitre.org/techniques/T1010) (T1010)\n- Technique: [File and Directory Discovery](https://attack.mitre.org/techniques/T1083) (T1083)\n- Technique: [System Information Discovery](https://attack.mitre.org/techniques/T1082) (T1082)\n- Technique: [System Location Discovery](https://attack.mitre.org/techniques/T1614) (T1614)\n- Technique: [Software Discovery: Security Software Discovery](https://attack.mitre.org/techniques/T1518/001) (T1518.001)\n- Technique: [System Owner/User Discovery](https://attack.mitre.org/techniques/T1033) (T1033)\n- Technique: [Application Layer Protocol: Web Protocols](https://attack.mitre.org/techniques/T1071/001) (T1071.001)\n\n## Observations\n\nWhile not specific enough to be considered indicators of compromise, the following information was observed during analysis that can help when investigating suspicious events.\n\n### File System\n\n**Persistence folder**\n\n```\n**%APPDATA%\\Microsoft\\[Random Folder]**\n```\n\n**Example:**\n\n```\n**C:\\Users\\Arx\\AppData\\Roaming\\Microsoft\\Vuhys**\n```\n\n### Registry\n\n**Scan Exclusion**\n\n```\n**HKLM\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Paths\\[Persistence Folder]**\n```\n\n**Example:**\n\n```\n**HKLM\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Paths\\C:\\Users\\Arx\\AppData\\Roaming\\Microsoft\\Blqgeaf**\n```\n\n### Configuration\n\n**Configuration**\n\n```\n**HKU\\[User SID]\\Software\\Microsoft\\[Random Key]\\[Random Value 0]**\n```\n\n**Example:**\n\n```\n**HKU\\S-1-5-21-2844492762-1358964462-3296191067-1000\\Software\\Microsoft\\Silhmfua\\28e2a7e8**\n```\n\n## Appendices\n\n### Appendix A (extracted network infrastructure)\n\n|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |\n| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| 1.161.71.109:4431.161.71.109:995100.1.108.246:443101.50.103.193:995102.182.232.3:995103.107.113.120:443103.139.243.207:990103.246.242.202:443103.87.95.133:2222103.88.226.30:443105.226.83.196:995108.60.213.141:443109.12.111.14:443109.228.220.196:443113.11.89.165:995117.248.109.38:21120.150.218.241:995120.61.2.95:443121.74.167.191:995125.168.47.127:2222138.204.24.70:443140.82.49.12:443140.82.63.183:443140.82.63.183:995143.0.34.185:443144.202.2.175:443144.202.2.175:995144.202.3.39:443144.202.3.39:995148.64.96.100:443149.28.238.199:443149.28.238.199:995172.114.160.81:995172.115.177.204:2222173.174.216.62:443173.21.10.71:2222174.69.215.101:443175.145.235.37:443176.205.119.81:2078176.67.56.94:443176.88.238.122:995179.158.105.44:443180.129.102.214:995180.183.128.80:2222181.118.183.98:443181.208.248.227:443181.62.0.59:443182.191.92.203:995182.253.189.74:2222185.69.144.209:443 | 186.105.121.166:443187.102.135.142:2222187.207.48.194:61202187.250.114.15:443187.251.132.144:22190.252.242.69:443190.73.3.148:2222191.17.223.93:32101191.34.199.129:443191.99.191.28:443196.233.79.3:80197.167.62.14:993197.205.127.234:443197.89.108.252:4432.50.137.197:443201.145.189.252:443201.211.64.196:2222202.134.152.2:2222203.122.46.130:443208.107.221.224:443209.197.176.40:995217.128.122.65:2222217.164.210.192:443217.165.147.83:99324.178.196.158:222224.43.99.75:44331.35.28.29:44331.48.166.122:207832.221.224.140:99537.186.54.254:99537.34.253.233:44338.70.253.226:222239.41.158.185:99539.44.144.159:99539.52.75.201:99539.57.76.82:99540.134.246.185:99541.228.22.180:44341.230.62.211:99341.38.167.179:99541.84.237.10:99542.235.146.7:222245.241.232.25:99545.46.53.140:222245.63.1.12:44345.63.1.12:99545.76.167.26:44345.76.167.26:99545.9.20.200:44346.107.48.202:443 | 47.156.191.217:44347.180.172.159:44347.180.172.159:5001047.23.89.62:99347.23.89.62:9955.32.41.45:4435.95.58.211:208766.98.42.102:44367.209.195.198:44368.204.7.158:44370.46.220.114:44370.51.138.126:222271.13.93.154:222271.74.12.34:44372.12.115.90:2272.252.201.34:99572.76.94.99:44373.151.236.31:44373.67.152.98:222274.15.2.252:222275.113.214.234:222275.99.168.194:44375.99.168.194:6120176.169.147.192:3210376.25.142.196:44376.69.155.202:222276.70.9.169:222278.87.206.213:99580.11.74.81:222281.215.196.174:44382.152.39.39:44383.110.75.97:222284.241.8.23:3210385.246.82.244:44386.97.11.43:44386.98.208.214:222286.98.33.141:44386.98.33.141:99588.228.250.126:44389.211.181.64:222290.120.65.153:207891.177.173.10:99592.132.172.197:222293.48.80.198:99594.36.195.250:222294.59.138.62:119494.59.138.62:222296.21.251.127:222296.29.208.97:44396.37.113.36:993 |\n\n### Appendix B (command handlers)\n\n| Id   | Handler                                                                         |\n| ---- | ------------------------------------------------------------------------------- |\n| 0x1  | MARE::rpc::handler::CommunicateWithC2                                           |\n| 0x6  | MARE::rpc::handler::EnableGlobalRegistryConfigurationValuek0x14                 |\n| 0x7  | MARE::rpc::handler::DisableGlobalRegistryConfigurationValuek0x14                |\n| 0xa  | MARE::rpc::handler::KillProcess                                                 |\n| 0xc  | MARE::rpc::handler::SetBunchOfGlobalRegistryConfigurationValuesAndTriggerEvent1 |\n| 0xd  | MARE::rpc::handler::SetBunchOfGlobalRegistryConfigurationValuesAndTriggerEvent0 |\n| 0xe  | MARE::rpc::handler::DoEvasionMove                                               |\n| 0x12 | MARE::rpc::handler::NotImplemented                                              |\n| 0x13 | MARE::rpc::handler::UploadAndRunUpdatedQBOT0                                    |\n| 0x14 | MARE::rpc::handler::Unk0                                                        |\n| 0x15 | MARE::rpc::handler::Unk1                                                        |\n| 0x19 | MARE::rpc::handler::UploadAndExecuteBinary                                      |\n| 0x1A | MARE::rpc::handler::UploadAndInjectDll0                                         |\n| 0x1B | MARE::rpc::handler::DoInjectionFromDllToInjectByStr                             |\n| 0x1C | MARE::rpc::handler::KillInjectedProcessAndDisableDllToInject                    |\n| 0x1D | MARE::rpc::handler::Unk3                                                        |\n| 0x1E | MARE::rpc::handler::KillInjectedProcessAndDoInjectionAgainByStr                 |\n| 0x1F | MARE::rpc::handler::FastInjectdll                                               |\n| 0x21 | MARE::rpc::handler::ExecuteShellCmd                                             |\n| 0x23 | MARE::rpc::handler::UploadAndInjectDll1                                         |\n| 0x24 | MARE::rpc::handler::UploadAndRunUpdatedQBOT1                                    |\n| 0x25 | MARE::rpc::handler::SetValueToGlobalRegistryConfiguration                       |\n| 0x26 | MARE::rpc::handler::DeleteValueFromGlobalRegistryConfiguration                  |\n| 0x27 | MARE::rpc::handler::ExecutePowershellCmd                                        |\n| 0x28 | MARE::rpc::handler::UploadAndRunDllWithRegsvr32                                 |\n| 0x29 | MARE::rpc::handler::UploadAndRunDllWithRundll32                                 |\n\n### Appendix C (string deciphering implementation)\n\n```\ndef decipher_strings(data: bytes, key: bytes) -\u003e bytes:\n   result = dict()\n   current_index = 0\n   current_string = list()\n   for i in range(len(data)):\n       current_string.append(data[i] ^ key[i % len(key)])\n       if data[i] == key[i % len(key)]:\n              result[current_index] = bytes(current_string)\n              current_string = list()\n              current_index = i + 1\n   return result\n```\n\n### Appendix D (resource deciphering implementation)\n\n```\nfrom Crypto.Cipher import ARC4\nfrom Crypto.Hash import SHA1\n\ndef decipher_data(data: bytes, key: bytes) -\u003e tuple[bytes, bytes]:\n   data = ARC4.ARC4Cipher(SHA1.SHA1Hash(key).digest()).decrypt(data)\n   return data[20:], data[:20]\n\n\ndef verify_hash(data: bytes, expected_hash: bytes) -\u003e bool:\n   return SHA1.SHA1Hash(data).digest() == expected_hash\n\n\ndef decipher_rsrc(rsrc: bytes, key: bytes) -\u003e bytes:\n   deciphered_rsrc, expected_hash = decipher_data(rsrc[20:], rsrc[:20])\n   if not verify_hash(deciphered_rsrc, expected_hash):\n       deciphered_rsrc, expected_hash = decipher_data(rsrc, key)\n       if not verify_hash(deciphered_rsrc, expected_hash):\n              raise RuntimeError('Failed to decipher rsrc: Mismatching hashes.')\n   return deciphered_rsrc\n```\n","code":"var Component=(()=\u003e{var h=Object.create;var a=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty;var f=(t,e)=\u003e()=\u003e(e||t((e={exports:{}}).exports,e),e.exports),y=(t,e)=\u003e{for(var i in e)a(t,i,{get:e[i],enumerable:!0})},o=(t,e,i,s)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let r of g(e))!u.call(t,r)\u0026\u0026r!==i\u0026\u0026a(t,r,{get:()=\u003ee[r],enumerable:!(s=p(e,r))||s.enumerable});return t};var w=(t,e,i)=\u003e(i=t!=null?h(m(t)):{},o(e||!t||!t.__esModule?a(i,\"default\",{value:t,enumerable:!0}):i,t)),b=t=\u003eo(a({},\"__esModule\",{value:!0}),t);var c=f((O,l)=\u003e{l.exports=_jsx_runtime});var q={};y(q,{default:()=\u003ev,frontmatter:()=\u003eT});var n=w(c()),T={title:\"QBOT Malware Analysis\",slug:\"qbot-malware-analysis\",date:\"2023-02-14\",description:\"Elastic Security Labs releases a QBOT malware analysis report covering the execution chain. From this research, the team has produced a YARA rule, configuration-extractor, and indicators of compromises (IOCs).\",author:[{slug:\"cyril-francois\"}],image:\"blog-thumb-drill-bit.jpg\",category:[{slug:\"malware-analysis\"}],tags:[\"ref3726\",\"qbot\",\"qakbot\"]};function d(t){let e=Object.assign({h2:\"h2\",ul:\"ul\",li:\"li\",a:\"a\",p:\"p\",blockquote:\"blockquote\",h3:\"h3\",img:\"img\",strong:\"strong\",pre:\"pre\",code:\"code\",div:\"div\",table:\"table\",thead:\"thead\",tr:\"tr\",th:\"th\",tbody:\"tbody\",td:\"td\",h4:\"h4\",br:\"br\"},t.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.h2,{id:\"key-takeaways\",children:\"Key takeaways\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Elastic Security Labs is releasing a QBOT malware analysis report from a recent \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/exploring-the-qbot-attack-pattern\",rel:\"nofollow\",children:\"campaign\"})]}),`\n`,(0,n.jsx)(e.li,{children:\"This report covers the execution chain from initial infection to communication with its command and control containing details about in depth features such as its injection mechanism and dynamic persistence mechanism.\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"From this research we produced a \",(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_Qbot.yar\",rel:\"nofollow\",children:\"YARA rule\"}),\", \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/qbot-configuration-extractor\",rel:\"nofollow\",children:\"configuration-extractor\"}),\", and indicators of compromises (IOCs)\"]}),`\n`]}),`\n`,(0,n.jsx)(e.h2,{id:\"preamble\",children:\"Preamble\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"As part of our mission to build knowledge about the most common malware families targeting institutions and individuals, the Elastic Malware and Reverse Engineering team (MARE) completed the analysis of the core component of the banking trojan QBOT/QAKBOT V4 from a previously reported \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/exploring-the-qbot-attack-pattern\",rel:\"nofollow\",children:\"campaign\"}),\".\"]}),`\n`,(0,n.jsx)(e.p,{children:\"QBOT \\u2014 also known as QAKBOT \\u2014 is a modular Trojan active since 2007 used to download and run binaries on a target machine. This document describes the in-depth reverse engineering of the QBOT V4 core components. It covers the execution flow of the binary from launch to communication with its command and control (C2).\"}),`\n`,(0,n.jsx)(e.p,{children:\"QBOT is a multistage, multiprocess binary that has capabilities for evading detection, escalating privileges, configuring persistence, and communicating with C2 through a set of IP addresses. The C2 can update QBOT, upload new IP addresses, upload and run fileless binaries, and execute shell commands.\"}),`\n`,(0,n.jsx)(e.p,{children:\"As a result of this analysis, MARE has produced a new yara rule based on the core component of QBOT as well as a static configuration extractor able to extract and decrypt its strings, its configuration, and its C2 IP address list.\"}),`\n`,(0,n.jsxs)(e.blockquote,{children:[`\n`,(0,n.jsx)(e.p,{children:\"For information on the QBOT configuration extractor and malware analysis, check out our blog posts detailing this:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/qbot-configuration-extractor\",rel:\"nofollow\",children:\"QBOT Configuration Extractor\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/exploring-the-qbot-attack-pattern\",rel:\"nofollow\",children:\"QBOT Attack Pattern\"})}),`\n`]}),`\n`]}),`\n`,(0,n.jsx)(e.h2,{id:\"execution-flow\",children:\"Execution flow\"}),`\n`,(0,n.jsx)(e.p,{children:\"This section describes the QBOT execution flow in the following three stages:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"First Stage: Initialization\"}),`\n`,(0,n.jsx)(e.li,{children:\"Second Stage: Installation\"}),`\n`,(0,n.jsx)(e.li,{children:\"Third Stage: Communication\"}),`\n`]}),`\n`,(0,n.jsx)(e.h3,{id:\"stage-1\",children:\"Stage 1\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/1qbot.png\",alt:\"First stage execution flow\",width:\"715\",height:\"495\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"The sample is executed with the \",(0,n.jsx)(e.strong,{children:\"regsvr32.exe\"}),\" binary, which in turn will call QBOT\\u2019s \",(0,n.jsx)(e.strong,{children:\"DllRegisterServer\"}),\" export:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/2qbot.png\",alt:\"regsvr32.exe loading QBOT and calling its DllRegisterServer export.\",width:\"861\",height:\"418\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"After execution, QBOT checks if it\\u2019s running under the Windows Defender sandbox by checking the existence of a specific subdirectory titled: \",(0,n.jsx)(e.strong,{children:\"C:\\\\INTERNAL\\\\__empty\"}),\" , if this folder exists, the malware terminates itself:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/3qbot.jpg\",alt:\"QBOT checking if it is running and Windows Defender sandbox.\",width:\"789\",height:\"38\"})}),`\n`,(0,n.jsx)(e.p,{children:\"The malware will then enumerate running processes to detect any antivirus (AV) products on the machine. The image below contains a list of AV vendors QBOT reacts to:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/4qbot.jpg\",alt:\"Enum of vendors QBOT can detect.\",width:\"320\",height:\"274\"})}),`\n`,(0,n.jsx)(e.p,{children:\"AV detection will not prevent QBOT from running. However, it will change its behavior in later stages. In order to generate a seed for its pseudorandom number generator (PRNG), QBOT generates a fingerprint of the computer by using the following expression:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`**fingerprint = CRC32(computerName + CVolumeSerialNumber + AccountName)**\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"If the \",(0,n.jsx)(e.strong,{children:\"\\u201CC:\\u201D\"}),\" volume doesn\\u2019t exist the expression below is used instead:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`**fingerprint = CRC32(computerName + AccountName)**\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"Finally, QBOT will choose a set of targets to inject into depending on the AVs previously detected and the machine architecture:\"}),`\n`,(0,n.jsx)(e.p,{children:`|                            |                                                                                                               |\n| -------------------------- | ------------------------------------------------------------------------------------------------------------- | ---------------------- | ----------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------ |\n| AV detected \u0026 architecture | Targets                                                                                                       |\n| BitDefender                | Kaspersky                                                                                                     | Sophos                 | TrendMicro                                                                                                                    | \u0026 x86                                                                                                        | %SystemRoot%\\\\SysWOW64\\\\mobsync.exe %SystemRoot%\\\\SysWOW64\\\\explorer.exe |\n| BitDefender                | Kaspersky                                                                                                     | Sophos                 | TrendMicro \u0026 x64                                                                                                              | %SystemRoot%\\\\System32\\\\mobsync.exe%SystemRoot%\\\\explorer.exe%ProgramFiles%\\\\Internet Explorer\\\\iexplore.exe |\n| Avast                      | AVG                                                                                                           | Windows Defender \u0026 x86 | %SystemRoot%\\\\SysWOW64\\\\OneDriveSetup.exe%SystemRoot%\\\\SysWOW64\\\\msra.exe%ProgramFiles(x86)%\\\\Internet Explorer\\\\iexplore.exe |\n| Avast                      | AVG                                                                                                           | Windows Defender \u0026 x64 | %SystemRoot%\\\\System32\\\\OneDriveSetup.exe%SystemRoot%\\\\System32\\\\msra.exe                                                     |\n| x86                        | '%SystemRoot%\\\\explorer.exe%SystemRoot%\\\\System32\\\\msra.exe%SystemRoot%\\\\System32\\\\OneDriveSetup.exe          |\n| x64                        | %SystemRoot%\\\\SysWOW64\\\\explorer.exe%SystemRoot%\\\\SysWOW64\\\\msra.exe%SystemRoot%\\\\System32\\\\OneDriveSetup.exe |`}),`\n`,(0,n.jsxs)(e.p,{children:[\"QBOT will try to inject itself iteratively, using its second stage as an entry point, into one of its targets\\u2013 choosing the next target process if the injection fails. Below is an example of QBOT injecting into \",(0,n.jsx)(e.strong,{children:\"explorer.exe\"}),\".\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/7qbot.png\",alt:\"QBOT injecting itself into explorer.exe\",width:\"1032\",height:\"591\"})}),`\n`,(0,n.jsx)(e.h3,{id:\"stage-2\",children:\"Stage 2\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/8qbot.png\",alt:\"Second stage execution flow\",width:\"725\",height:\"565\"})}),`\n`,(0,n.jsx)(e.p,{children:\"QBOT begins its second stage by saving the content of its binary in memory and then corrupting the file on disk:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/0.jpg\",alt:\"QBOT corrupting its binary file\",width:\"872\",height:\"438\"})}),`\n`,(0,n.jsx)(e.p,{children:\"The malware then loads its configuration from one of its resource sections:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/10qbot.jpg\",alt:\"QBOT loading its configuration from resource\",width:\"912\",height:\"264\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"QBOT also has the capability to load its configuration from a \",(0,n.jsx)(e.strong,{children:\".cfg\"}),\" file if available in the process root directory:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/1.jpg\",alt:\"QBOT trying to load its configuration from a file\",width:\"1426\",height:\"175\"})}),`\n`,(0,n.jsx)(e.p,{children:\"After loading its configuration, QBOT proceeds to install itself on the machine\\u2013 initially by writing its internal configuration to the registry:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/2.jpg\",alt:\"QBOT writing its configuration to the registry\",width:\"1440\",height:\"266\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Shortly after, QBOT creates a persistence subdirectory with a randomly-generated name under the \",(0,n.jsx)(e.strong,{children:\"%APPDATA%\\\\Microsoft\"}),\" directory. This folder is used to drop the in-memory QBOT binary for persistence across reboot:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/3.jpg\",alt:\"QBOT creating its persistence folder\",width:\"1329\",height:\"197\"})}),`\n`,(0,n.jsx)(e.p,{children:\"At this point, the folder will be empty because the malware will only drop the binary if a shutdown/reboot event is detected. This \\u201Ccontingency\\u201D binary will be deleted after reboot.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"QBOT will attempt the same install process for all users and try to either execute the malware within the user session if it exists, or create a value under the \",(0,n.jsx)(e.strong,{children:\"CurrentVersion\\\\Run\"}),\" registry key for the targeted user to launch the malware at the next login. Our analysis didn\\u2019t manage to reproduce this behavior on an updated Windows 10 machine. The only artifact observed is the randomly generated persistence folder created under the user \",(0,n.jsx)(e.strong,{children:\"%APPDATA%\\\\Microsoft\"}),\" directory:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/4qbot.jpg\",alt:\"Persistence folder is empty when QBOT is running\",width:\"320\",height:\"274\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"QBOT finishes its second stage by restoring the content of its corrupted binary and registering a task via \",(0,n.jsx)(e.strong,{children:\"Schtask\"}),\" to launch a QBOT service under the \",(0,n.jsx)(e.strong,{children:\"NT AUTHORITY\\\\SYSTEM\"}),\" account.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"The first stage has a special execution path where it registers a service handler if the process is running under the \",(0,n.jsx)(e.strong,{children:\"SYSTEM\"}),\" account. The QBOT service then executes stages 2 and 3 as normal, corrupting the binary yet again and executing commands on behalf of other QBOT processes via messages received through a randomly generated named pipe:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/15qbot.png\",alt:\"QBOT running as SYSTEM service\",width:\"1121\",height:\"711\"})}),`\n`,(0,n.jsx)(e.h3,{id:\"stage-3\",children:\"Stage 3\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/16qbot.png\",alt:\"Third stage execution flow\",width:\"1295\",height:\"735\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"QBOT begins its third stage by registering a window and console event handler to monitor suspend/resume and shutdown/reboot events. Monitoring these events enables the malware to install persistence dynamically by dropping a copy of the QBOT binary in the persistence folder and creating a value under the \",(0,n.jsx)(e.strong,{children:\"CurrentVersion\\\\Run\"}),\" registry key:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/7qbot.png\",alt:\"QBOT install persistence when suspend/resume or shutdown/reboot event occurs\",width:\"1032\",height:\"591\"})}),`\n`,(0,n.jsx)(e.p,{children:\"At reboot, QBOT will take care of deleting any persistence artifacts.\"}),`\n`,(0,n.jsx)(e.p,{children:\"The malware will proceed to creating a watchdog thread to monitor running processes against a hardcoded list of binaries every second. If any process matches, a registry value is set that will then change QBOT behavior to use randomly generated IP addresses instead of the real one, thus never reaching its command and control:\"}),`\n`,(0,n.jsx)(e.div,{className:\"table-container\",children:(0,n.jsxs)(e.table,{children:[(0,n.jsx)(e.thead,{children:(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.th,{}),(0,n.jsx)(e.th,{}),(0,n.jsx)(e.th,{})]})}),(0,n.jsx)(e.tbody,{children:(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"frida-winjector-helper-32.exefrida-winjector-helper-64.exeTcpdump.exewindump.exeethereal.exewireshark.exeettercap.exertsniff.exepacketcapture.execapturenet.exeqak_proxy\"}),(0,n.jsx)(e.td,{children:\"dumpcap.exeCFF Explorer.exenot_rundll32.exeProcessHacker.exetcpview.exefilemon.exeprocmon.exeidaq64.exePETools.exeImportREC.exeLordPE.exe\"}),(0,n.jsx)(e.td,{children:\"SysInspector.exeproc_analyzer.exesysAnalyzer.exesniff_hit.exejoeboxcontrol.exejoeboxserver.exeResourceHacker.exex64dbg.exeFiddler.exesniff_hit.exesysAnalyzer.exe\"})]})})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"QBOT will then load its domains from one of its \",(0,n.jsx)(e.strong,{children:\".rsrc\"}),\" files and from the registry as every domain update received from its C2 will be part of its configuration written to the registry. See Extracted Network Infrastructure in Appendix A.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Finally, the malware starts communicating with C2 via HTTP and TLS. The underlying protocol uses a JSON object encapsulated within an enciphered message which is then base64-encoded:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/8qbot.png\",alt:\"QBOT message format\",width:\"725\",height:\"565\"})}),`\n`,(0,n.jsx)(e.p,{children:\"Below an example of a HTTP POST request sent by QBOT to its C2:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`Accept: application/x-shockwave-flash, image/gif, image/jpeg, image/pjpeg, */*\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\nHost: 181.118.183.98\nContent-Length: 77\nCache-Control: no-cache\n\nqxlbjrbj=NnySaFAKLt+YgjH3UET8U6AUwT9Lg51z6zC+ufeAjt4amZAXkIyDup74MImUA4do4Q==\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"Through this communication channel, QBOT receives commands from C2 \\u2014 see Appendix B (Command Handlers). Aside from management commands (update, configuration knobs), our sample only handles binary execution-related commands, but we know that the malware is modular and can be built with additional features like a VNC server, a reverse shell server, proxy support (to be part of the domains list), and numerous other capabilities are feasible.\"}),`\n`,(0,n.jsx)(e.h2,{id:\"features\",children:\"Features\"}),`\n`,(0,n.jsx)(e.h3,{id:\"mersenne-twister-random-number-generator\",children:\"Mersenne Twister Random Number Generator\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"QBOT uses an implementation of \",(0,n.jsx)(e.a,{href:\"https://www.sciencedirect.com/topics/computer-science/mersenne-twister\",rel:\"nofollow\",children:\"Mersenne Twister Random Number Generator\"}),\" (MTRNG) to generate random values:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/19qbot.jpg\",alt:\"QBOT's Mersenne Twister Random Number Generator implementation\",width:\"729\",height:\"256\"})}),`\n`,(0,n.jsx)(e.p,{children:\"The MTRNG engine is then used by various functions to generate different types of data, for example for generating registry key values and persistence folders. As QBOT needs to reproduce values, it will almost always use the computer fingerprint and a \\u201Csalt\\u201D specific to the value it wants to generate:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/20qbot.jpg\",alt:\"QBOT generating random event name with fixed seed and salt\",width:\"625\",height:\"51\"})}),`\n`,(0,n.jsx)(e.h3,{id:\"string-obfuscation\",children:\"String obfuscation\"}),`\n`,(0,n.jsx)(e.p,{children:\"All QBOT strings are XOR-encrypted and concatenated in a single blob we call a \\u201Cstring bank\\u201D. To get a specific string the malware needs a string identifier (identifier being an offset in the string bank), a decryption key, and the targeted string bank.\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/1qbot.png\",alt:\"GetStringAux function prototype.\",width:\"715\",height:\"495\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"As this sample has two string banks, it has four \",(0,n.jsx)(e.strong,{children:\"GetString\"}),\"' functions currying the string bank and the decryption key parameters: One C string function and one wide string function for each string bank. Wide string functions use the same string banks, but convert the data to \",(0,n.jsx)(e.strong,{children:\"utf-16\"}),\".\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/2qbot.png\",alt:\"QBOT calling GetString function\",width:\"861\",height:\"418\"})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/3qbot.jpg\",alt:\"GetString function currying GetStringAux with string bank and key parameters\",width:\"789\",height:\"38\"})}),`\n`,(0,n.jsx)(e.p,{children:\"See Appendix C (String Deciphering Implementation).\"}),`\n`,(0,n.jsx)(e.h3,{id:\"import-obfuscation\",children:\"Import obfuscation\"}),`\n`,(0,n.jsx)(e.p,{children:\"QBOT resolves its imports using a hash table:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/4qbot.jpg\",alt:\"QBOT calling GetApi function\",width:\"320\",height:\"274\"})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/25qbot.jpg\",alt:\"GetApi function prototype\",width:\"632\",height:\"20\"})}),`\n`,(0,n.jsx)(e.p,{children:\"The malware resolves the library name through its GetString function and then resolves the hash table with a classic library\\u2019s exports via manual parsing, comparing each export to the expected hash. In this sample, the hashing comparison algorithm use this formula:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`**CRC32(exportName) XOR 0x218fe95b == hash**\n`})}),`\n`,(0,n.jsx)(e.h3,{id:\"resource-obfuscation\",children:\"Resource obfuscation\"}),`\n`,(0,n.jsx)(e.p,{children:\"The malware is embedded with different resources, the common ones are the configuration and the domains list. Resources are encrypted the same way: The decryption key may be either embedded within the data blob or provided. Once the resource is decrypted, an embedded hash is used to check data validity.\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/26qbot.jpg\",alt:\"QBOT decrypting its resource with embedded or provided key\",width:\"815\",height:\"275\"})}),`\n`,(0,n.jsx)(e.p,{children:\"See Appendix D (Resource Deciphering Implementation).\"}),`\n`,(0,n.jsx)(e.h3,{id:\"cyrillic-keyboard-language-detection\",children:\"Cyrillic keyboard language detection\"}),`\n`,(0,n.jsx)(e.p,{children:\"At different stages, QBOT will check if the computer uses a Cyrillic language keyboard. If it does, it prevents further execution.\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/7qbot.png\",alt:\"Set of languages QBOT is looking to stop its execution\",width:\"1032\",height:\"591\"})}),`\n`,(0,n.jsx)(e.h3,{id:\"avgavast-special-behavior\",children:\"AVG/AVAST special behavior\"}),`\n`,(0,n.jsx)(e.p,{children:\"AVG and Avast share the same antivirus engine. Thus if QBOT detects one of those antivirus running, it will also check at the installation stage if one of their DLLs is loaded within the malware memory space. If so, QBOT will skip the installation phase.\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/8qbot.png\",alt:\"QBOT checking if AVG/AVAST has hooked its process\",width:\"725\",height:\"565\"})}),`\n`,(0,n.jsx)(e.h3,{id:\"windows-defender-special-behavior\",children:\"Windows Defender special behavior\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"If QBOT is running under \",(0,n.jsx)(e.strong,{children:\"SYSTEM\"}),\" account, it will add its persistence folder to the Windows Defender exclusion path in the registry. It will also do this for the legacy Microsoft Security Essential (MSE) exclusion path if detected.\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/29qbot.jpg\",alt:\"QBOT adding its persistence folder to Windows Defender and MSE exclusion paths\",width:\"583\",height:\"190\"})}),`\n`,(0,n.jsx)(e.h3,{id:\"exception-list-process-watchdog\",children:\"Exception list process watchdog\"}),`\n`,(0,n.jsx)(e.p,{children:\"Each second, QBOT parses running processes looking for one matching the hardcoded exception list. If any is found, a \\u201Cfuse\\u201D value is set in the registry and the watchdog stops. If this fuse value is set, QBOT will not stop execution\\u2013 but at the third stage, the malware will use randomly generated IP and won't be able to contact C2.\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/30qbot.jpg\",alt:\"Watchdog thread setting fuse if any Exceptionlisted process is detected\",width:\"936\",height:\"166\"})}),`\n`,(0,n.jsx)(e.p,{children:\"![QBOT using randomly generated IP address if fuse is set]/assets/images/qbot-malware-analysis/1qbot.png)\"}),`\n`,(0,n.jsx)(e.h3,{id:\"qbot-process-injection\",children:\"QBOT process injection\"}),`\n`,(0,n.jsx)(e.h4,{id:\"second-stage-injection\",children:\"Second stage injection\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"To inject its second stage into one of a hardcoded target, QBOT uses a classic \",(0,n.jsx)(e.strong,{children:\"CreateProcess\"}),\" , \",(0,n.jsx)(e.strong,{children:\"WriteProcessMemory\"}),\" , \",(0,n.jsx)(e.strong,{children:\"ResumeProcess\"}),\" DLL injection technique. The malware will create a process, allocate and write the QBOT binary within the process memory, write a copy of its engine, and patch the entry point to jump to a special function. This function performs a light initialization of QBOT and its engine within the new process environment, alerts the main process of its success, and then execute the second stage.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"![QBOT second stage injection]/assets/images/qbot-malware-analysis/2qbot.png)\"}),`\n`,(0,n.jsx)(e.p,{children:\"![QBOT injection entry point]/assets/images/qbot-malware-analysis/3qbot.jpg)\"}),`\n`,(0,n.jsx)(e.h4,{id:\"injecting-library-from-command-and-control\",children:\"Injecting library from command and control\"}),`\n`,(0,n.jsx)(e.p,{children:\"QBOT uses the aforementioned method to inject libraries received from C2. The difference is that as well as mapping itself, the malware will also map the received binary and use a library loader as entry point.\"}),`\n`,(0,n.jsx)(e.p,{children:\"![QBOT DLL loader injection]/assets/images/qbot-malware-analysis/4qbot.jpg)\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/35qbot.jpg\",alt:\"QBOT Dll loader entrypoint\",width:\"662\",height:\"183\"})}),`\n`,(0,n.jsx)(e.h3,{id:\"multi-user-installation\",children:\"Multi-user installation\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Part of the QBOT installation process is installing itself within others users\\u2019 accounts. To do so, the malware enumerates each user with an account on the machine (local and domain), then dumps its configuration under the user\\u2019s \",(0,n.jsx)(e.strong,{children:\"Software\\\\Microsoft\"}),\" registry key, creates a persistence folder under the users\\u2019 \",(0,n.jsx)(e.strong,{children:\"%APPDATA%\\\\Microsoft\"}),\" folder, and finally tries to either launch QBOT under the user session if the session exist, or else creates a run key to launch the malware when the user will log in.\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/36qbot.jpg\",alt:\"QBOT installation \u0026 run for one user\",width:\"871\",height:\"327\"})}),`\n`,(0,n.jsx)(e.h3,{id:\"dynamic-persistence\",children:\"Dynamic persistence\"}),`\n`,(0,n.jsx)(e.p,{children:\"QBOT registers a window handler to monitor suspend/resume events. When they occur, the malware will install/uninstall persistence.\"}),`\n`,(0,n.jsx)(e.p,{children:\"![QBOT window handler registration]/assets/images/qbot-malware-analysis/7qbot.png)\"}),`\n`,(0,n.jsx)(e.p,{children:\"![QBOT window handler catching suspend/resume event]/assets/images/qbot-malware-analysis/8qbot.png)\"}),`\n`,(0,n.jsx)(e.p,{children:\"QBOT registers a console event to handle shutdown/reboot events as well.\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/39qbot.jpg\",alt:\"QBOT registering console handler\",width:\"785\",height:\"136\"})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/40qbot.jpg\",alt:\"QBOT console handler catching shutdown/reboot event\",width:\"645\",height:\"168\"})}),`\n`,(0,n.jsx)(e.h3,{id:\"command-and-control-public-key-pinning\",children:\"Command and control public key pinning\"}),`\n`,(0,n.jsx)(e.p,{children:\"QBOT has a mechanism to verify the signature of every message received from its command and control. The verification mechanism is based on a public key embedded in the sample. This public key could be used to identify the campaign the sample belongs to, but this mechanism may not always be present.\"}),`\n`,(0,n.jsx)(e.p,{children:\"![QBOT command and control message processing]/assets/images/qbot-malware-analysis/1qbot.png)\"}),`\n`,(0,n.jsx)(e.p,{children:\"![Message signature verification with hardcoded command and control public key]/assets/images/qbot-malware-analysis/2qbot.png)\"}),`\n`,(0,n.jsx)(e.p,{children:\"The public key comes from a hardcoded XOR-encrypted data blob.\"}),`\n`,(0,n.jsx)(e.p,{children:\"![Hardcoded command and control public key being XOR-decrypted]/assets/images/qbot-malware-analysis/3qbot.jpg)\"}),`\n`,(0,n.jsx)(e.h3,{id:\"computer-information-gathering\",children:\"Computer information gathering\"}),`\n`,(0,n.jsx)(e.p,{children:\"Part of QBOT communication with its command and control is sending information about the computer. Information are gathered through a set Windows API calls, shell commands and Windows Management Instrumentation (WMI) commands:\"}),`\n`,(0,n.jsx)(e.p,{children:\"![Computer information gathering 1/2]/assets/images/qbot-malware-analysis/4qbot.jpg)\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/45qbot.jpg\",alt:\"Computer information gathering 2/2\",width:\"950\",height:\"176\"})}),`\n`,(0,n.jsx)(e.p,{children:\"One especially interesting procedure listed installed antivirus via WMI:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/46qbot.jpg\",alt:\"QBOT listing installed antivirus via a WMI command\",width:\"639\",height:\"332\"})}),`\n`,(0,n.jsx)(e.h3,{id:\"update-mechanism\",children:\"Update mechanism\"}),`\n`,(0,n.jsx)(e.p,{children:\"QBOT can receive updates from its command and control. The new binary will be written to disk, executed through a command line, and the main process will terminate.\"}),`\n`,(0,n.jsx)(e.p,{children:\"![QBOT writing to disk and running the updated binary]/assets/images/qbot-malware-analysis/7qbot.png)\"}),`\n`,(0,n.jsx)(e.p,{children:\"![QBOT stopping execution if update is running]/assets/images/qbot-malware-analysis/8qbot.png)\"}),`\n`,(0,n.jsx)(e.h3,{id:\"process-injection-manager\",children:\"Process injection manager\"}),`\n`,(0,n.jsx)(e.p,{children:\"QBOT has a system to keep track of processes injected with binaries received from its command and control in order to manage them as the malware receives subsequent commands. It also has a way to serialize and save those binaries on disk in case it has to stop execution and recover execution when restarted.\"}),`\n`,(0,n.jsx)(e.p,{children:\"To do this bookkeeping, QBOT maintains two global structures \\u2014 a list of all binaries received from its command and control, and a list of running injected processes:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/49qbot.jpg\",alt:\"QBOT\\u2019s list of DLL to inject received from its command and control.\",width:\"702\",height:\"243\"})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/qbot-malware-analysis/50qbot.jpg\",alt:\"QBOT\\u2019s list of running injected processes\",width:\"543\",height:\"61\"})}),`\n`,(0,n.jsx)(e.h2,{id:\"conclusion\",children:\"Conclusion\"}),`\n`,(0,n.jsx)(e.p,{children:\"The QBOT malware family is highly active and still part of the threat landscape in 2022 due to its features and its powerful modular system. While initially characterized as an information stealer in 2007, this family has been leveraged as a delivery mechanism for additional malware and post-compromise activity.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Elastic Security provides out-of-the-box prevention capabilities against this threat. Existing Elastic Security users can access these capabilities within the product. If you\\u2019re new to Elastic Security, take a look at our \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/training/free#quick-starts\",rel:\"nofollow\",children:\"Quick Start guides\"}),\" (bite-sized training videos to get you started quickly) or our \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/training/free#fundamentals\",rel:\"nofollow\",children:\"free fundamentals training courses\"}),\". You can always get started with a \",(0,n.jsx)(e.a,{href:\"https://cloud.elastic.co/registration?elektra=whats-new-elastic-security-7-16-blog\",rel:\"nofollow\",children:\"free 14-day trial of Elastic Cloud\"}),\".\"]}),`\n`,(0,n.jsx)(e.h2,{id:\"mitre-attck-tactics-and-techniques\",children:\"MITRE ATT\u0026CK Tactics and Techniques\"}),`\n`,(0,n.jsx)(e.p,{children:\"MITRE ATT\u0026CK is a globally-accessible knowledge base of adversary tactics and techniques based on real-world observations. The ATT\u0026CK knowledge base is used as a foundation for the development of specific threat models and methodologies in the private sector, in government, and in the cybersecurity product and service community.\"}),`\n`,(0,n.jsx)(e.h3,{id:\"tactics\",children:\"Tactics\"}),`\n`,(0,n.jsx)(e.p,{children:\"Tactics represent the why of a technique or sub-technique. It is the adversary\\u2019s tactical goal: the reason for performing an action.\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Tactic: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/tactics/TA0004\",rel:\"nofollow\",children:\"Privilege Escalation\"})]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Tactic: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/tactics/TA0005\",rel:\"nofollow\",children:\"Defense Evasion\"})]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Tactic: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/tactics/TA0007\",rel:\"nofollow\",children:\"Discovery\"})]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Tactic: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/tactics/TA0011\",rel:\"nofollow\",children:\"Command and Control\"})]}),`\n`]}),`\n`,(0,n.jsx)(e.h3,{id:\"techniques--sub-techniques\",children:\"Techniques / Sub Techniques\"}),`\n`,(0,n.jsx)(e.p,{children:\"Techniques and Sub techniques represent how an adversary achieves a tactical goal by performing an action.\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1055\",rel:\"nofollow\",children:\"Process Injection\"}),\" (T1055)\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1112\",rel:\"nofollow\",children:\"Modify Registry\"}),\" (T1112)\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1027\",rel:\"nofollow\",children:\"Obfuscated Files or Information\"}),\" (T1027)\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1027/005\",rel:\"nofollow\",children:\"Obfuscated Files or Information: Indicator Removal from Tools\"}),\" (T1027.005)\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1218/010\",rel:\"nofollow\",children:\"System Binary Proxy Execution: Regsvr32\"}),\" (T1218.010)\",(0,n.jsx)(e.br,{}),`\n`,\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1010\",rel:\"nofollow\",children:\"Application Window Discovery\"}),\" (T1010)\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1083\",rel:\"nofollow\",children:\"File and Directory Discovery\"}),\" (T1083)\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1082\",rel:\"nofollow\",children:\"System Information Discovery\"}),\" (T1082)\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1614\",rel:\"nofollow\",children:\"System Location Discovery\"}),\" (T1614)\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1518/001\",rel:\"nofollow\",children:\"Software Discovery: Security Software Discovery\"}),\" (T1518.001)\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1033\",rel:\"nofollow\",children:\"System Owner/User Discovery\"}),\" (T1033)\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Technique: \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1071/001\",rel:\"nofollow\",children:\"Application Layer Protocol: Web Protocols\"}),\" (T1071.001)\"]}),`\n`]}),`\n`,(0,n.jsx)(e.h2,{id:\"observations\",children:\"Observations\"}),`\n`,(0,n.jsx)(e.p,{children:\"While not specific enough to be considered indicators of compromise, the following information was observed during analysis that can help when investigating suspicious events.\"}),`\n`,(0,n.jsx)(e.h3,{id:\"file-system\",children:\"File System\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.strong,{children:\"Persistence folder\"})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`**%APPDATA%\\\\Microsoft\\\\[Random Folder]**\n`})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.strong,{children:\"Example:\"})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`**C:\\\\Users\\\\Arx\\\\AppData\\\\Roaming\\\\Microsoft\\\\Vuhys**\n`})}),`\n`,(0,n.jsx)(e.h3,{id:\"registry\",children:\"Registry\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.strong,{children:\"Scan Exclusion\"})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`**HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows Defender\\\\Exclusions\\\\Paths\\\\[Persistence Folder]**\n`})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.strong,{children:\"Example:\"})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`**HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows Defender\\\\Exclusions\\\\Paths\\\\C:\\\\Users\\\\Arx\\\\AppData\\\\Roaming\\\\Microsoft\\\\Blqgeaf**\n`})}),`\n`,(0,n.jsx)(e.h3,{id:\"configuration\",children:\"Configuration\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.strong,{children:\"Configuration\"})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`**HKU\\\\[User SID]\\\\Software\\\\Microsoft\\\\[Random Key]\\\\[Random Value 0]**\n`})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.strong,{children:\"Example:\"})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`**HKU\\\\S-1-5-21-2844492762-1358964462-3296191067-1000\\\\Software\\\\Microsoft\\\\Silhmfua\\\\28e2a7e8**\n`})}),`\n`,(0,n.jsx)(e.h2,{id:\"appendices\",children:\"Appendices\"}),`\n`,(0,n.jsx)(e.h3,{id:\"appendix-a-extracted-network-infrastructure\",children:\"Appendix A (extracted network infrastructure)\"}),`\n`,(0,n.jsx)(e.div,{className:\"table-container\",children:(0,n.jsxs)(e.table,{children:[(0,n.jsx)(e.thead,{children:(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.th,{}),(0,n.jsx)(e.th,{}),(0,n.jsx)(e.th,{})]})}),(0,n.jsx)(e.tbody,{children:(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"1.161.71.109:4431.161.71.109:995100.1.108.246:443101.50.103.193:995102.182.232.3:995103.107.113.120:443103.139.243.207:990103.246.242.202:443103.87.95.133:2222103.88.226.30:443105.226.83.196:995108.60.213.141:443109.12.111.14:443109.228.220.196:443113.11.89.165:995117.248.109.38:21120.150.218.241:995120.61.2.95:443121.74.167.191:995125.168.47.127:2222138.204.24.70:443140.82.49.12:443140.82.63.183:443140.82.63.183:995143.0.34.185:443144.202.2.175:443144.202.2.175:995144.202.3.39:443144.202.3.39:995148.64.96.100:443149.28.238.199:443149.28.238.199:995172.114.160.81:995172.115.177.204:2222173.174.216.62:443173.21.10.71:2222174.69.215.101:443175.145.235.37:443176.205.119.81:2078176.67.56.94:443176.88.238.122:995179.158.105.44:443180.129.102.214:995180.183.128.80:2222181.118.183.98:443181.208.248.227:443181.62.0.59:443182.191.92.203:995182.253.189.74:2222185.69.144.209:443\"}),(0,n.jsx)(e.td,{children:\"186.105.121.166:443187.102.135.142:2222187.207.48.194:61202187.250.114.15:443187.251.132.144:22190.252.242.69:443190.73.3.148:2222191.17.223.93:32101191.34.199.129:443191.99.191.28:443196.233.79.3:80197.167.62.14:993197.205.127.234:443197.89.108.252:4432.50.137.197:443201.145.189.252:443201.211.64.196:2222202.134.152.2:2222203.122.46.130:443208.107.221.224:443209.197.176.40:995217.128.122.65:2222217.164.210.192:443217.165.147.83:99324.178.196.158:222224.43.99.75:44331.35.28.29:44331.48.166.122:207832.221.224.140:99537.186.54.254:99537.34.253.233:44338.70.253.226:222239.41.158.185:99539.44.144.159:99539.52.75.201:99539.57.76.82:99540.134.246.185:99541.228.22.180:44341.230.62.211:99341.38.167.179:99541.84.237.10:99542.235.146.7:222245.241.232.25:99545.46.53.140:222245.63.1.12:44345.63.1.12:99545.76.167.26:44345.76.167.26:99545.9.20.200:44346.107.48.202:443\"}),(0,n.jsx)(e.td,{children:\"47.156.191.217:44347.180.172.159:44347.180.172.159:5001047.23.89.62:99347.23.89.62:9955.32.41.45:4435.95.58.211:208766.98.42.102:44367.209.195.198:44368.204.7.158:44370.46.220.114:44370.51.138.126:222271.13.93.154:222271.74.12.34:44372.12.115.90:2272.252.201.34:99572.76.94.99:44373.151.236.31:44373.67.152.98:222274.15.2.252:222275.113.214.234:222275.99.168.194:44375.99.168.194:6120176.169.147.192:3210376.25.142.196:44376.69.155.202:222276.70.9.169:222278.87.206.213:99580.11.74.81:222281.215.196.174:44382.152.39.39:44383.110.75.97:222284.241.8.23:3210385.246.82.244:44386.97.11.43:44386.98.208.214:222286.98.33.141:44386.98.33.141:99588.228.250.126:44389.211.181.64:222290.120.65.153:207891.177.173.10:99592.132.172.197:222293.48.80.198:99594.36.195.250:222294.59.138.62:119494.59.138.62:222296.21.251.127:222296.29.208.97:44396.37.113.36:993\"})]})})]})}),`\n`,(0,n.jsx)(e.h3,{id:\"appendix-b-command-handlers\",children:\"Appendix B (command handlers)\"}),`\n`,(0,n.jsx)(e.div,{className:\"table-container\",children:(0,n.jsxs)(e.table,{children:[(0,n.jsx)(e.thead,{children:(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.th,{children:\"Id\"}),(0,n.jsx)(e.th,{children:\"Handler\"})]})}),(0,n.jsxs)(e.tbody,{children:[(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x1\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::CommunicateWithC2\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x6\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::EnableGlobalRegistryConfigurationValuek0x14\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x7\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::DisableGlobalRegistryConfigurationValuek0x14\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0xa\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::KillProcess\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0xc\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::SetBunchOfGlobalRegistryConfigurationValuesAndTriggerEvent1\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0xd\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::SetBunchOfGlobalRegistryConfigurationValuesAndTriggerEvent0\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0xe\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::DoEvasionMove\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x12\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::NotImplemented\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x13\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::UploadAndRunUpdatedQBOT0\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x14\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::Unk0\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x15\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::Unk1\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x19\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::UploadAndExecuteBinary\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x1A\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::UploadAndInjectDll0\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x1B\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::DoInjectionFromDllToInjectByStr\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x1C\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::KillInjectedProcessAndDisableDllToInject\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x1D\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::Unk3\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x1E\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::KillInjectedProcessAndDoInjectionAgainByStr\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x1F\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::FastInjectdll\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x21\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::ExecuteShellCmd\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x23\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::UploadAndInjectDll1\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x24\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::UploadAndRunUpdatedQBOT1\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x25\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::SetValueToGlobalRegistryConfiguration\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x26\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::DeleteValueFromGlobalRegistryConfiguration\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x27\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::ExecutePowershellCmd\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x28\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::UploadAndRunDllWithRegsvr32\"})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"0x29\"}),(0,n.jsx)(e.td,{children:\"MARE::rpc::handler::UploadAndRunDllWithRundll32\"})]})]})]})}),`\n`,(0,n.jsx)(e.h3,{id:\"appendix-c-string-deciphering-implementation\",children:\"Appendix C (string deciphering implementation)\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`def decipher_strings(data: bytes, key: bytes) -\u003e bytes:\n   result = dict()\n   current_index = 0\n   current_string = list()\n   for i in range(len(data)):\n       current_string.append(data[i] ^ key[i % len(key)])\n       if data[i] == key[i % len(key)]:\n              result[current_index] = bytes(current_string)\n              current_string = list()\n              current_index = i + 1\n   return result\n`})}),`\n`,(0,n.jsx)(e.h3,{id:\"appendix-d-resource-deciphering-implementation\",children:\"Appendix D (resource deciphering implementation)\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`from Crypto.Cipher import ARC4\nfrom Crypto.Hash import SHA1\n\ndef decipher_data(data: bytes, key: bytes) -\u003e tuple[bytes, bytes]:\n   data = ARC4.ARC4Cipher(SHA1.SHA1Hash(key).digest()).decrypt(data)\n   return data[20:], data[:20]\n\n\ndef verify_hash(data: bytes, expected_hash: bytes) -\u003e bool:\n   return SHA1.SHA1Hash(data).digest() == expected_hash\n\n\ndef decipher_rsrc(rsrc: bytes, key: bytes) -\u003e bytes:\n   deciphered_rsrc, expected_hash = decipher_data(rsrc[20:], rsrc[:20])\n   if not verify_hash(deciphered_rsrc, expected_hash):\n       deciphered_rsrc, expected_hash = decipher_data(rsrc, key)\n       if not verify_hash(deciphered_rsrc, expected_hash):\n              raise RuntimeError('Failed to decipher rsrc: Mismatching hashes.')\n   return deciphered_rsrc\n`})})]})}function x(t={}){let{wrapper:e}=t.components||{};return e?(0,n.jsx)(e,Object.assign({},t,{children:(0,n.jsx)(d,t)})):d(t)}var v=x;return b(q);})();\n;return Component;"},"_id":"articles/qbot-malware-analysis.mdx","_raw":{"sourceFilePath":"articles/qbot-malware-analysis.mdx","sourceFileName":"qbot-malware-analysis.mdx","sourceFileDir":"articles","contentType":"mdx","flattenedPath":"articles/qbot-malware-analysis"},"type":"Article","imageUrl":"/assets/images/qbot-malware-analysis/blog-thumb-drill-bit.jpg","readingTime":"44 min read","series":"","url":"/qbot-malware-analysis","headings":[{"level":2,"title":"Key takeaways","href":"#key-takeaways"},{"level":2,"title":"Preamble","href":"#preamble"},{"level":2,"title":"Execution flow","href":"#execution-flow"},{"level":3,"title":"Stage 1","href":"#stage-1"},{"level":3,"title":"Stage 2","href":"#stage-2"},{"level":3,"title":"Stage 3","href":"#stage-3"},{"level":2,"title":"Features","href":"#features"},{"level":3,"title":"Mersenne Twister Random Number Generator","href":"#mersenne-twister-random-number-generator"},{"level":3,"title":"String obfuscation","href":"#string-obfuscation"},{"level":3,"title":"Import obfuscation","href":"#import-obfuscation"},{"level":3,"title":"Resource obfuscation","href":"#resource-obfuscation"},{"level":3,"title":"Cyrillic keyboard language detection","href":"#cyrillic-keyboard-language-detection"},{"level":3,"title":"AVG/AVAST special behavior","href":"#avgavast-special-behavior"},{"level":3,"title":"Windows Defender special behavior","href":"#windows-defender-special-behavior"},{"level":3,"title":"Exception list process watchdog","href":"#exception-list-process-watchdog"},{"level":3,"title":"QBOT process injection","href":"#qbot-process-injection"},{"level":4,"title":"Second stage injection","href":"#second-stage-injection"},{"level":4,"title":"Injecting library from command and control","href":"#injecting-library-from-command-and-control"},{"level":3,"title":"Multi-user installation","href":"#multi-user-installation"},{"level":3,"title":"Dynamic persistence","href":"#dynamic-persistence"},{"level":3,"title":"Command and control public key pinning","href":"#command-and-control-public-key-pinning"},{"level":3,"title":"Computer information gathering","href":"#computer-information-gathering"},{"level":3,"title":"Update mechanism","href":"#update-mechanism"},{"level":3,"title":"Process injection manager","href":"#process-injection-manager"},{"level":2,"title":"Conclusion","href":"#conclusion"},{"level":2,"title":"MITRE ATT\u0026CK Tactics and Techniques","href":"#mitre-attck-tactics-and-techniques"},{"level":3,"title":"Tactics","href":"#tactics"},{"level":3,"title":"Techniques / Sub Techniques","href":"#techniques--sub-techniques"},{"level":2,"title":"Observations","href":"#observations"},{"level":3,"title":"File System","href":"#file-system"},{"level":3,"title":"Registry","href":"#registry"},{"level":3,"title":"Configuration","href":"#configuration"},{"level":2,"title":"Appendices","href":"#appendices"},{"level":3,"title":"Appendix A (extracted network infrastructure)","href":"#appendix-a-extracted-network-infrastructure"},{"level":3,"title":"Appendix B (command handlers)","href":"#appendix-b-command-handlers"},{"level":3,"title":"Appendix C (string deciphering implementation)","href":"#appendix-c-string-deciphering-implementation"},{"level":3,"title":"Appendix D (resource deciphering implementation)","href":"#appendix-d-resource-deciphering-implementation"}],"author":[{"title":"Cyril François","slug":"cyril-francois","body":{"raw":"","code":"var Component=(()=\u003e{var x=Object.create;var a=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var l=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,g=Object.prototype.hasOwnProperty;var j=(t,n)=\u003e()=\u003e(n||t((n={exports:{}}).exports,n),n.exports),d=(t,n)=\u003e{for(var r in n)a(t,r,{get:n[r],enumerable:!0})},i=(t,n,r,s)=\u003e{if(n\u0026\u0026typeof n==\"object\"||typeof n==\"function\")for(let o of l(n))!g.call(t,o)\u0026\u0026o!==r\u0026\u0026a(t,o,{get:()=\u003en[o],enumerable:!(s=f(n,o))||s.enumerable});return t};var p=(t,n,r)=\u003e(r=t!=null?x(_(t)):{},i(n||!t||!t.__esModule?a(r,\"default\",{value:t,enumerable:!0}):r,t)),y=t=\u003ei(a({},\"__esModule\",{value:!0}),t);var u=j((b,c)=\u003e{c.exports=_jsx_runtime});var D={};d(D,{default:()=\u003eM,frontmatter:()=\u003eC});var e=p(u()),C={title:\"Cyril Fran\\xE7ois\",slug:\"cyril-francois\"};function m(t){return(0,e.jsx)(e.Fragment,{})}function F(t={}){let{wrapper:n}=t.components||{};return n?(0,e.jsx)(n,Object.assign({},t,{children:(0,e.jsx)(m,t)})):m(t)}var M=F;return y(D);})();\n;return Component;"},"_id":"authors/cyril-francois.mdx","_raw":{"sourceFilePath":"authors/cyril-francois.mdx","sourceFileName":"cyril-francois.mdx","sourceFileDir":"authors","contentType":"mdx","flattenedPath":"authors/cyril-francois"},"type":"Author","imageUrl":"","url":"/authors/cyril-francois"}],"category":[{"title":"Malware analysis","slug":"malware-analysis","body":{"raw":"","code":"var Component=(()=\u003e{var u=Object.create;var s=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,g=Object.prototype.hasOwnProperty;var j=(t,n)=\u003e()=\u003e(n||t((n={exports:{}}).exports,n),n.exports),M=(t,n)=\u003e{for(var e in n)s(t,e,{get:n[e],enumerable:!0})},i=(t,n,e,o)=\u003e{if(n\u0026\u0026typeof n==\"object\"||typeof n==\"function\")for(let r of f(n))!g.call(t,r)\u0026\u0026r!==e\u0026\u0026s(t,r,{get:()=\u003en[r],enumerable:!(o=x(n,r))||o.enumerable});return t};var d=(t,n,e)=\u003e(e=t!=null?u(_(t)):{},i(n||!t||!t.__esModule?s(e,\"default\",{value:t,enumerable:!0}):e,t)),p=t=\u003ei(s({},\"__esModule\",{value:!0}),t);var l=j((X,c)=\u003e{c.exports=_jsx_runtime});var D={};M(D,{default:()=\u003eC,frontmatter:()=\u003ew});var a=d(l()),w={title:\"Malware analysis\",slug:\"malware-analysis\"};function m(t){return(0,a.jsx)(a.Fragment,{})}function y(t={}){let{wrapper:n}=t.components||{};return n?(0,a.jsx)(n,Object.assign({},t,{children:(0,a.jsx)(m,t)})):m(t)}var C=y;return p(D);})();\n;return Component;"},"_id":"categories/malware-analysis.mdx","_raw":{"sourceFilePath":"categories/malware-analysis.mdx","sourceFileName":"malware-analysis.mdx","sourceFileDir":"categories","contentType":"mdx","flattenedPath":"categories/malware-analysis"},"type":"Category","url":"/categories/malware-analysis"}]},"seriesArticles":null},"__N_SSG":true},"page":"/[slug]","query":{"slug":"qbot-malware-analysis"},"buildId":"LbZ9DZ1J4YuByupgUw5Qo","assetPrefix":"/security-labs","isFallback":false,"gsp":true,"scriptLoader":[{"id":"google-tag-manager","strategy":"afterInteractive","dangerouslySetInnerHTML":{"__html":"\n          (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':\n          new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],\n          j=d.createElement(s),dl=l!='dataLayer'?'\u0026l='+l:'';j.async=true;j.src=\n          'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);\n          })(window,document,'script','dataLayer','GTM-KNJMG2M');\n          "}}]}</script></body></html>