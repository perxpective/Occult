<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script>
  <link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Qakbot Series: API Hashing | MALWAROLOGY</title>
  <link rel = 'canonical' href = 'https://www.malwarology.com/2022/04/qakbot-series-api-hashing/'>
  <meta name="description" content="MALWAROLOGY is a blog authored by Nino Pellegrino, threat researcher. Here you&#39;ll find excerpts of in-depth analyses of malware samples, reviews of published material, and general discussions about malicious software and cybersecurity. Mainly in broken-English, seldom in broken-Italian.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Qakbot Series: API Hashing" />
<meta property="og:description" content="In late March 2022, I was requested to analyze a software artifact. It was an instance of Qakbot, a modular information stealer known since 2007. Differently to other analyses I do as part of my daily job, in this particular case I can disclose wide parts of it with you readers. I&rsquo;m addressing them in a post series. Here, I&rsquo;ll discuss about the Qakbot API hashing techinque based on this specific sample." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.malwarology.com/2022/04/qakbot-series-api-hashing/" />
<meta property="article:published_time" content="2022-04-17T00:32:10+02:00" />
<meta property="article:modified_time" content="2022-04-17T00:32:10+02:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Qakbot Series: API Hashing"/>
<meta name="twitter:description" content="In late March 2022, I was requested to analyze a software artifact. It was an instance of Qakbot, a modular information stealer known since 2007. Differently to other analyses I do as part of my daily job, in this particular case I can disclose wide parts of it with you readers. I&rsquo;m addressing them in a post series. Here, I&rsquo;ll discuss about the Qakbot API hashing techinque based on this specific sample."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://www.malwarology.com/css/styles.5bd9188e4c696a70f32fbca925aba31988dbae4e3c47b10517f50beeabffd3d94c1305d237e5eccfcb562e2ae66380a108a7718f067e298bb95eb7e5ee84fb66.css" integrity="sha512-W9kYjkxpanDzL7ypJaujGYjbrk48R7EFF/UL7qv/09lMEwXSN&#43;Xsz8tWLirmY4ChCKdxjwZ&#43;KYu5Xrfl7oT7Zg=="> 

  
   <link rel="stylesheet" href="https://www.malwarology.com/css/figure.css">  <link rel="stylesheet" href="https://www.malwarology.com/css/itemize.css"> 
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://www.malwarology.com/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Posts</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://www.malwarology.com/2022/04/qakbot-series-process-injection/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://www.malwarology.com/2022/05/janicab-series-first-steps-in-the-infection-chain/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&text=Qakbot%20Series%3a%20API%20Hashing" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&title=Qakbot%20Series%3a%20API%20Hashing" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&is_video=false&description=Qakbot%20Series%3a%20API%20Hashing" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Qakbot%20Series%3a%20API%20Hashing&body=Check out this article: https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&title=Qakbot%20Series%3a%20API%20Hashing" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&title=Qakbot%20Series%3a%20API%20Hashing" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&name=Qakbot%20Series%3a%20API%20Hashing&description=In%20late%20March%202022%2c%20I%20was%20requested%20to%20analyze%20a%20software%20artifact.%20It%20was%20an%20instance%20of%20Qakbot%2c%20a%20modular%20information%20stealer%20known%20since%202007.%20Differently%20to%20other%20analyses%20I%20do%20as%20part%20of%20my%20daily%20job%2c%20in%20this%20particular%20case%20I%20can%20disclose%20wide%20parts%20of%20it%20with%20you%20readers.%20I%26rsquo%3bm%20addressing%20them%20in%20a%20post%20series.%20Here%2c%20I%26rsquo%3bll%20discuss%20about%20the%20Qakbot%20API%20hashing%20techinque%20based%20on%20this%20specific%20sample." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&t=Qakbot%20Series%3a%20API%20Hashing" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents"></nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Qakbot Series: API Hashing
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2022-04-17 00:32:10 &#43;0200 CEST" itemprop="datePublished">2022-04-17</time>
          
        </div>
        
        
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/malware-analysis">Malware Analysis</a>
            
             ,  
            <a class="category-link" href="/categories/qakbot">Qakbot</a>
            
        </div>
        
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p>In late March 2022, I was requested to analyze a software artifact. It was an instance of Qakbot, a modular information stealer known since 2007. Differently to other analyses I do as part of my daily job, in this particular case I can disclose wide parts of it with you readers. I&rsquo;m addressing them in a post series. Here, I&rsquo;ll discuss about the Qakbot API hashing techinque based on <a href="https://www.virustotal.com/gui/file/8565e3e213572cbd7c3df45ae3fadd094831aef7b63d3b389e57097c1b8602d6/detection">this</a> specific sample.</p>

<figure class="figure">
	<img src="/images/4-qakbot-api-hashing/1-protected-invocation.png"    alt="Example of protected API call in Qakbot" }} />
    
	    <figcaption>
		    	<h4>Figure 1</h4> - <p>Example of protected API call in Qakbot</p> 
	    </figcaption>
    
</figure>

<p>API hashing is an anti-analysis technique aimed at hiding a potential source of information about the malware capabilities. Analysts are used to rely on the API calls to form an hypothesis of what a given piece of code tries to do because much of the malware behavior can be inferred by looking at how it interacts with the operating system. As an example, <strong>Figure 1</strong> shows a call to CreateThread (kernel32.dll) located at <em>0xb2348b</em>. You cannot see any reference to CreateRemote thread into the code, besides the comment I placed to slightly improve the code readability. To understand what is happening here, I need to describe the API hashing technique implemented in the sample object of analysis. Luckly, this section is all around this topic.</p>

<figure class="figure">
	<img src="/images/4-qakbot-api-hashing/2-api-dehashing.png"    alt="Qakbot API de-hashing main function" }} />
    
	    <figcaption>
		    	<h4>Figure 2</h4> - <p>Qakbot API de-hashing main function</p> 
	    </figcaption>
    
</figure>

<p>Qakbot attempts to invoke functions exported by 11 dynamic-link libraries: kernel32.dll, ntdll.dll, advapi32.dll, netapi32.dll, shell32.dll, shlwapi.dll, user32.dll, wininet.dll, urlmon.dll, crypt32.dll, and wtsapi32.dll. I know that because I found tracks of those libraries into the strings. Don&rsquo;t panic if you won&rsquo;t find those strings into the sample because they are obfuscated. If you&rsquo;are interested in knowing how Qakbot obfuscates the strings, I address the topic in <a href="https://www.malwarology.com/2022/04/qakbot-series-string-obfuscation/">this</a> post. From those strings, I was able to discover the function responsible for the API de-hashing. For API de-hashing I mean the process allowing to retrieve API addresses starting from rather anonymous numbers called hashes. That function is located at <em>0xb3050a</em> and it is showed in <strong>Figure 2</strong>.</p>
<p>That function expects three arguments. The very first argument is an hash table, namely a vector of 32 bits hashes. A very important point to make clear here is that there is a dedicated and hardcoded hash table for every DLL mentioned above. The second argument is the size of the hash table. The last argument is the offset used by the function <em>deobfuscate_string_1</em> to de-obfuscate the name of the DLL. The goal of the de-hashing  function consists in allocating a new table containing the memory address of all the required APIs for the given DLL. Once such an address table is allocated, invocations for an API may occur by just pointing at the corresponding entry in the table. <strong>Figure 1</strong> shows an example of this type of invocation where the offset <em>0x1c2</em> is aligned with the memory address of CreateThread into the kernel32.dll table (actually, the offset for CreateThread is <em>0x70</em>, as it is possible to observe into the assembly listing at <em>0xb2348b</em>. For some reason, Ghidra decompiler reconstructed a different offset).</p>
<p>As a side note, <em>0x6e2</em> is the offset for kernel32.dll therefore the first condition in the listing of <strong>Figure 2</strong> checks if the caller has requested an API exported by kernel32.dll. Indeed, if that is the case then it is sufficient to invoke GetModuleHandleA to obtain an handle to the DLL because kernel32.dll is mapped in the memory space of every process at loading time. Otherwise, if the requested module isn’t kernel32.dll, LoadLibraryA is invoked to obtain the same result. Notice that in the latter case the API invocation occurs via the kernel32 address table where LoadLibraryA lies at offset 0.</p>

<figure class="figure">
	<img src="/images/4-qakbot-api-hashing/3-hash-resolution.png"    alt="Hash checking to identify the requested export name" }} />
    
	    <figcaption>
		    	<h4>Figure 3</h4> - <p>Hash checking to identify the requested export name</p> 
	    </figcaption>
    
</figure>

<p>The actual de-hashing occurs in a sub-function of <em>resolve_api_address</em> located at <em>0xb303ca</em>. This function is responsible for resolving the address of a specific API of a given module starting from an hash. The code snippet showed in <strong>Figure 3</strong> highlights the hash check. That loop enumerates all the export names of a module and ends in two cases:</p>
<ul>
<li>When the hash provided to resolve_api_address is equal to the hash of an export name xor-ed with an hardcoded constant (<em>0x218fe95b</em>). In this case there is a hit and the export name is later provided to GetProcAddress to obtain the corresponding API address.</li>
<li>The provided hash doesn’t correspond to any export name of the module. In this case the function returns NULL.</li>
</ul>
<p>I close this post by sharing the mapping between hashes and all the API functions requested by this Qakbot sample. You will find the mapping <a href="/text/4-qakbot-api-hashing/dehashed_apis.txt">here</a>. Each row in this file contains the library exporting the API function, the offset into the address table, the hash, and finally the API function name. The offset may turn useful for analysis purposes because it is often hardcoded as showed in <strong>Figure 1</strong>.</p>
<p>As always, if you want to share comments or feedbacks (rigorously in broken Italian or broken English) do not esitate to drop me a message at <strong>admin[@]malwarology.com</strong>.</p>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Posts</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents"></nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&text=Qakbot%20Series%3a%20API%20Hashing" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&title=Qakbot%20Series%3a%20API%20Hashing" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&is_video=false&description=Qakbot%20Series%3a%20API%20Hashing" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Qakbot%20Series%3a%20API%20Hashing&body=Check out this article: https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&title=Qakbot%20Series%3a%20API%20Hashing" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&title=Qakbot%20Series%3a%20API%20Hashing" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&name=Qakbot%20Series%3a%20API%20Hashing&description=In%20late%20March%202022%2c%20I%20was%20requested%20to%20analyze%20a%20software%20artifact.%20It%20was%20an%20instance%20of%20Qakbot%2c%20a%20modular%20information%20stealer%20known%20since%202007.%20Differently%20to%20other%20analyses%20I%20do%20as%20part%20of%20my%20daily%20job%2c%20in%20this%20particular%20case%20I%20can%20disclose%20wide%20parts%20of%20it%20with%20you%20readers.%20I%26rsquo%3bm%20addressing%20them%20in%20a%20post%20series.%20Here%2c%20I%26rsquo%3bll%20discuss%20about%20the%20Qakbot%20API%20hashing%20techinque%20based%20on%20this%20specific%20sample." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-api-hashing%2f&t=Qakbot%20Series%3a%20API%20Hashing" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2022  MALWAROLOGY 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Posts</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
