<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script>
  <link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Qakbot Series: String Obfuscation | MALWAROLOGY</title>
  <link rel = 'canonical' href = 'https://www.malwarology.com/2022/04/qakbot-series-string-obfuscation/'>
  <meta name="description" content="MALWAROLOGY is a blog authored by Nino Pellegrino, threat researcher. Here you&#39;ll find excerpts of in-depth analyses of malware samples, reviews of published material, and general discussions about malicious software and cybersecurity. Mainly in broken-English, seldom in broken-Italian.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Qakbot Series: String Obfuscation" />
<meta property="og:description" content="In late March 2022, I was requested to analyze a software artifact. It was an instance of Qakbot, a modular information stealer known since 2007. Differently to other analyses I do as part of my daily job, in this particular case I can disclose wide parts of it with you readers. I&rsquo;m addressing them in a post series. Here, I&rsquo;ll discuss about the string obfuscation techinque based on this specific sample." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.malwarology.com/2022/04/qakbot-series-string-obfuscation/" />
<meta property="article:published_time" content="2022-04-10T19:26:10+02:00" />
<meta property="article:modified_time" content="2022-04-10T19:26:10+02:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Qakbot Series: String Obfuscation"/>
<meta name="twitter:description" content="In late March 2022, I was requested to analyze a software artifact. It was an instance of Qakbot, a modular information stealer known since 2007. Differently to other analyses I do as part of my daily job, in this particular case I can disclose wide parts of it with you readers. I&rsquo;m addressing them in a post series. Here, I&rsquo;ll discuss about the string obfuscation techinque based on this specific sample."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://www.malwarology.com/css/styles.5bd9188e4c696a70f32fbca925aba31988dbae4e3c47b10517f50beeabffd3d94c1305d237e5eccfcb562e2ae66380a108a7718f067e298bb95eb7e5ee84fb66.css" integrity="sha512-W9kYjkxpanDzL7ypJaujGYjbrk48R7EFF/UL7qv/09lMEwXSN&#43;Xsz8tWLirmY4ChCKdxjwZ&#43;KYu5Xrfl7oT7Zg=="> 

  
   <link rel="stylesheet" href="https://www.malwarology.com/css/figure.css">  <link rel="stylesheet" href="https://www.malwarology.com/css/itemize.css"> 
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://www.malwarology.com/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Posts</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://www.malwarology.com/about/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://www.malwarology.com/2022/04/qakbot-series-configuration-extraction/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&text=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&title=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&is_video=false&description=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Qakbot%20Series%3a%20String%20Obfuscation&body=Check out this article: https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&title=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&title=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&name=Qakbot%20Series%3a%20String%20Obfuscation&description=In%20late%20March%202022%2c%20I%20was%20requested%20to%20analyze%20a%20software%20artifact.%20It%20was%20an%20instance%20of%20Qakbot%2c%20a%20modular%20information%20stealer%20known%20since%202007.%20Differently%20to%20other%20analyses%20I%20do%20as%20part%20of%20my%20daily%20job%2c%20in%20this%20particular%20case%20I%20can%20disclose%20wide%20parts%20of%20it%20with%20you%20readers.%20I%26rsquo%3bm%20addressing%20them%20in%20a%20post%20series.%20Here%2c%20I%26rsquo%3bll%20discuss%20about%20the%20string%20obfuscation%20techinque%20based%20on%20this%20specific%20sample." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&t=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents"></nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Qakbot Series: String Obfuscation
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2022-04-10 19:26:10 &#43;0200 CEST" itemprop="datePublished">2022-04-10</time>
          
        </div>
        
        
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/malware-analysis">Malware Analysis</a>
            
             ,  
            <a class="category-link" href="/categories/qakbot">Qakbot</a>
            
        </div>
        
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p>In late March 2022, I was requested to analyze a software artifact. It was an instance of Qakbot, a modular information stealer known since 2007. Differently to other analyses I do as part of my daily job, in this particular case I can disclose wide parts of it with you readers. I&rsquo;m addressing them in a post series. Here, I&rsquo;ll discuss about the string obfuscation techinque based on <a href="https://www.virustotal.com/gui/file/8565e3e213572cbd7c3df45ae3fadd094831aef7b63d3b389e57097c1b8602d6/detection">this</a> specific sample.</p>
<p>Looking at the strings embedded into a software artifact is one of the first approaches an analyst may attempt during the triaging stage. For those of you don&rsquo;t know what I&rsquo;m talking about, strings are sequences of bytes that, once interpreted as characters, form meaningful words. During the process that starts with a program source code and ends with that program being compiled and ready to run, strings are <em>usually</em> preserved. What does that mean? It means that if you have a string in the source code, e.g. a path or a function name, then that string will lie into the object code after the compilation of the sources. Strings may be an useful source of information to quickly understand the capabilities of a piece of software and immediately focus on specific areas of the artifact deserving a closer look. Strings can be statically extracted, i.e. you don&rsquo;t need to exectute the software to obtain them.</p>
<p>Naturally, malware developers know the importance of the strings during the analyis process. Therefore, they tend to hide this source of information from their products. One easy and cheap technique to hide strings like variable names and function names is to stripe them from the binary. This is acheavable simply by compiling the source with particular flags. Another technique aimed at hiding the most valuable strings is called <strong>string obfuscation</strong>. String obfuscation consists in storing the strings in encrypted or obfuscated form so that they cannot be recognized and extracted from the artifact. Those strings are decrypted at runtime and consumed by the software when they are needed. The Qakbot sample I analyzed implements a string obfuscation technique.</p>
<p>Indeed, the strings analysis for the sample object of analysis wasn’t really fruitful when I tried to do it. There were not so many meaningful strings overall and most of them were unreferenced or, in general, not providing any insight. There was only one exception: the presence of 18 very long and apparently meaningless strings. We postpone a discussion about their purpose to another post since it regards another anti-analysis technique. The reason why the string analysis wasn’t so effective is that the vast majority of them are obfuscated to hide evidence of the malware capabilities.</p>

<figure class="figure">
	<img src="/images/1-qakbot-strings-obfuscation/1-deobfuscation.png"    alt="Qakbot string deobfuscation function" }} />
    
	    <figcaption>
		    	<h4>Figure 1</h4> - <p>Qakbot string deobfuscation function</p> 
	    </figcaption>
    
</figure>

<p>All the meaningful and relevant strings are stored in obfuscated form in two continuous blobs. The first blob is located at <em>0xb542b8</em> and the second blob is located at <em>0xb551f8</em>. A string is de-obfuscated by xor-ing the specific part of the blob with a key stored as a continuous sequence of bytes. Each blob is xor-ed with a different key. There are two instances of the function implementing the string de-obfuscation, one starts at <em>0xb302c6</em> and another one starts at <em>0xb227a1</em>. As you may notice from <strong>Figure 1</strong>, showing the decompiled code for one of those instances, it expects four arguments: the blob where the string is contained, the size of the blob, the xoring key, and the starting offset of the obfuscated string within the blob.</p>

<div class="itemized">
	
	
	<div class="listing-container">
	
	<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">deobfuscate_string</span>(blob1: bytes, p1: int, blob2: bytes, p3: int) <span style="color:#f92672">-&gt;</span> bytes:
    l8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    i <span style="color:#f92672">=</span> p3
    <span style="color:#66d9ef">if</span> p3 <span style="color:#f92672">&lt;=</span> p1:
        <span style="color:#66d9ef">while</span> i <span style="color:#f92672">&lt;=</span> p1:
            <span style="color:#66d9ef">if</span> blob2[i <span style="color:#f92672">%</span> <span style="color:#ae81ff">0x5a</span>] <span style="color:#f92672">==</span> blob1[i]:
                l8 <span style="color:#f92672">=</span> i <span style="color:#f92672">-</span> p3
                <span style="color:#66d9ef">break</span>
            i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    lc <span style="color:#f92672">=</span> bytearray([<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> (l8))
    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">if</span> l8 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">while</span> i <span style="color:#f92672">&lt;</span> l8:
            lc[i] <span style="color:#f92672">=</span> blob2[(p3 <span style="color:#f92672">+</span> i) <span style="color:#f92672">%</span> <span style="color:#ae81ff">0x5a</span>] <span style="color:#f92672">^</span> blob1[p3:][i]
            i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">return</span> bytes(lc)
</code></pre></div></div>
	
	<div class="caption"> 
		<h4>Listing 1</h4> - <p>Python translation of the string deobfuscation function</p>
	</div>
	
</div>

<p><strong>Listing 1</strong> shows a Python3 translation of the Qakbot string deobfuscation function. I had to code it since the offset of many strings into the sample code is computed at runtime instead of being hardcoded. That function replicates the algorithm implemented in the sample. <a href="/text/1-qakbot-strings-obfuscation/strings.txt">Here</a> you will find a complete list of the de-obfuscated strings produced by our script. For each string I mention the containing blob and the starting offset within the blob. In that list you&rsquo;ll find a lot of potentially interesting elements regarding the malware capabilities. I&rsquo;ll discuss about some of them in the coming blog posts.</p>
<p>As always, if you want to share comments or feedbacks (rigorously in broken Italian or broken English) do not esitate to drop me a message at <strong>admin[@]malwarology.com</strong>.</p>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Posts</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents"></nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&text=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&title=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&is_video=false&description=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Qakbot%20Series%3a%20String%20Obfuscation&body=Check out this article: https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&title=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&title=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&name=Qakbot%20Series%3a%20String%20Obfuscation&description=In%20late%20March%202022%2c%20I%20was%20requested%20to%20analyze%20a%20software%20artifact.%20It%20was%20an%20instance%20of%20Qakbot%2c%20a%20modular%20information%20stealer%20known%20since%202007.%20Differently%20to%20other%20analyses%20I%20do%20as%20part%20of%20my%20daily%20job%2c%20in%20this%20particular%20case%20I%20can%20disclose%20wide%20parts%20of%20it%20with%20you%20readers.%20I%26rsquo%3bm%20addressing%20them%20in%20a%20post%20series.%20Here%2c%20I%26rsquo%3bll%20discuss%20about%20the%20string%20obfuscation%20techinque%20based%20on%20this%20specific%20sample." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwww.malwarology.com%2f2022%2f04%2fqakbot-series-string-obfuscation%2f&t=Qakbot%20Series%3a%20String%20Obfuscation" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2022  MALWAROLOGY 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Posts</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
